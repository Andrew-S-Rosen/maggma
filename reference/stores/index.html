
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation for Maggma, a files-to-API data pipeline for scientific applications">
      
      
      
        <link rel="canonical" href="https://materialsproject.github.io/maggma/reference/stores/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.0, mkdocs-material-8.3.9">
    
    
      
        <title>Stores - Maggma Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.1d29e8d0.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#maggma.stores.mongolike" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Maggma Documentation" class="md-header__button md-logo" aria-label="Maggma Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Maggma Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Stores
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/materialsproject/maggma/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Maggma Documentation" class="md-nav__button md-logo" aria-label="Maggma Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Maggma Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/materialsproject/maggma/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/" class="md-nav__link">
        Core Concepts
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Getting Started
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Getting Started" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Getting Started
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting_started/stores/" class="md-nav__link">
        Using Stores
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting_started/using_file_store/" class="md-nav__link">
        Working with FileStore
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting_started/simple_builder/" class="md-nav__link">
        Writing a Builder
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting_started/running_builders/" class="md-nav__link">
        Running a Builder Pipeline
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting_started/advanced_builder/" class="md-nav__link">
        Advanced Builders
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting_started/map_builder/" class="md-nav__link">
        Working with MapBuilder
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting_started/group_builder/" class="md-nav__link">
        Working with GroupBuilder
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Reference" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1" type="checkbox" id="__nav_4_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_1">
          Core
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Core" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_1">
          <span class="md-nav__icon md-icon"></span>
          Core
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../core_store/" class="md-nav__link">
        Store
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../core_builder/" class="md-nav__link">
        Builder
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../core_validator/" class="md-nav__link">
        Validator
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Stores
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Stores
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#maggma.stores.mongolike" class="md-nav__link">
    maggma.stores.mongolike
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.JSONStore" class="md-nav__link">
    JSONStore
  </a>
  
    <nav class="md-nav" aria-label="JSONStore">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.JSONStore.__eq__" class="md-nav__link">
    __eq__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.JSONStore.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.JSONStore.connect" class="md-nav__link">
    connect()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.JSONStore.read_json_file" class="md-nav__link">
    read_json_file()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.JSONStore.remove_docs" class="md-nav__link">
    remove_docs()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.JSONStore.update" class="md-nav__link">
    update()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.JSONStore.update_json_file" class="md-nav__link">
    update_json_file()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MemoryStore" class="md-nav__link">
    MemoryStore
  </a>
  
    <nav class="md-nav" aria-label="MemoryStore">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MemoryStore.name" class="md-nav__link">
    name
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MemoryStore.__eq__" class="md-nav__link">
    __eq__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MemoryStore.__hash__" class="md-nav__link">
    __hash__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MemoryStore.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MemoryStore.close" class="md-nav__link">
    close()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MemoryStore.connect" class="md-nav__link">
    connect()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MemoryStore.groupby" class="md-nav__link">
    groupby()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MongoStore" class="md-nav__link">
    MongoStore
  </a>
  
    <nav class="md-nav" aria-label="MongoStore">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MongoStore.name" class="md-nav__link">
    name
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MongoStore.__eq__" class="md-nav__link">
    __eq__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MongoStore.__hash__" class="md-nav__link">
    __hash__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MongoStore.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MongoStore.close" class="md-nav__link">
    close()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MongoStore.connect" class="md-nav__link">
    connect()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MongoStore.count" class="md-nav__link">
    count()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MongoStore.distinct" class="md-nav__link">
    distinct()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MongoStore.ensure_index" class="md-nav__link">
    ensure_index()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MongoStore.from_collection" class="md-nav__link">
    from_collection()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MongoStore.from_db_file" class="md-nav__link">
    from_db_file()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MongoStore.from_launchpad_file" class="md-nav__link">
    from_launchpad_file()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MongoStore.groupby" class="md-nav__link">
    groupby()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MongoStore.query" class="md-nav__link">
    query()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MongoStore.remove_docs" class="md-nav__link">
    remove_docs()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MongoStore.update" class="md-nav__link">
    update()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MongoURIStore" class="md-nav__link">
    MongoURIStore
  </a>
  
    <nav class="md-nav" aria-label="MongoURIStore">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MongoURIStore.name" class="md-nav__link">
    name
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MongoURIStore.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MongoURIStore.connect" class="md-nav__link">
    connect()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MontyStore" class="md-nav__link">
    MontyStore
  </a>
  
    <nav class="md-nav" aria-label="MontyStore">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MontyStore.name" class="md-nav__link">
    name
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MontyStore.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MontyStore.connect" class="md-nav__link">
    connect()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MontyStore.count" class="md-nav__link">
    count()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MontyStore.update" class="md-nav__link">
    update()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.SSHTunnel" class="md-nav__link">
    SSHTunnel
  </a>
  
    <nav class="md-nav" aria-label="SSHTunnel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.SSHTunnel.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maggma.stores.file_store" class="md-nav__link">
    maggma.stores.file_store
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maggma.stores.file_store.FileStore" class="md-nav__link">
    FileStore
  </a>
  
    <nav class="md-nav" aria-label="FileStore">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#maggma.stores.file_store.FileStore.name" class="md-nav__link">
    name
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.file_store.FileStore.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.file_store.FileStore.add_metadata" class="md-nav__link">
    add_metadata()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.file_store.FileStore.connect" class="md-nav__link">
    connect()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.file_store.FileStore.query" class="md-nav__link">
    query()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.file_store.FileStore.query_one" class="md-nav__link">
    query_one()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.file_store.FileStore.read" class="md-nav__link">
    read()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.file_store.FileStore.remove_docs" class="md-nav__link">
    remove_docs()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.file_store.FileStore.update" class="md-nav__link">
    update()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maggma.stores.gridfs" class="md-nav__link">
    maggma.stores.gridfs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maggma.stores.gridfs.GridFSStore" class="md-nav__link">
    GridFSStore
  </a>
  
    <nav class="md-nav" aria-label="GridFSStore">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#maggma.stores.gridfs.GridFSStore.last_updated" class="md-nav__link">
    last_updated
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.gridfs.GridFSStore.name" class="md-nav__link">
    name
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.gridfs.GridFSStore.__eq__" class="md-nav__link">
    __eq__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.gridfs.GridFSStore.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.gridfs.GridFSStore.close" class="md-nav__link">
    close()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.gridfs.GridFSStore.connect" class="md-nav__link">
    connect()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.gridfs.GridFSStore.count" class="md-nav__link">
    count()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.gridfs.GridFSStore.distinct" class="md-nav__link">
    distinct()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.gridfs.GridFSStore.ensure_index" class="md-nav__link">
    ensure_index()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.gridfs.GridFSStore.from_launchpad_file" class="md-nav__link">
    from_launchpad_file()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.gridfs.GridFSStore.groupby" class="md-nav__link">
    groupby()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.gridfs.GridFSStore.query" class="md-nav__link">
    query()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.gridfs.GridFSStore.remove_docs" class="md-nav__link">
    remove_docs()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.gridfs.GridFSStore.transform_criteria" class="md-nav__link">
    transform_criteria()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.gridfs.GridFSStore.update" class="md-nav__link">
    update()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maggma.stores.gridfs.GridFSURIStore" class="md-nav__link">
    GridFSURIStore
  </a>
  
    <nav class="md-nav" aria-label="GridFSURIStore">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#maggma.stores.gridfs.GridFSURIStore.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.gridfs.GridFSURIStore.connect" class="md-nav__link">
    connect()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maggma.stores.aws" class="md-nav__link">
    maggma.stores.aws
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maggma.stores.aws.S3Store" class="md-nav__link">
    S3Store
  </a>
  
    <nav class="md-nav" aria-label="S3Store">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#maggma.stores.aws.S3Store.last_updated" class="md-nav__link">
    last_updated
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.aws.S3Store.name" class="md-nav__link">
    name
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.aws.S3Store.__eq__" class="md-nav__link">
    __eq__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.aws.S3Store.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.aws.S3Store.close" class="md-nav__link">
    close()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.aws.S3Store.connect" class="md-nav__link">
    connect()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.aws.S3Store.count" class="md-nav__link">
    count()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.aws.S3Store.distinct" class="md-nav__link">
    distinct()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.aws.S3Store.ensure_index" class="md-nav__link">
    ensure_index()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.aws.S3Store.groupby" class="md-nav__link">
    groupby()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.aws.S3Store.newer_in" class="md-nav__link">
    newer_in()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.aws.S3Store.query" class="md-nav__link">
    query()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.aws.S3Store.rebuild_index_from_s3_data" class="md-nav__link">
    rebuild_index_from_s3_data()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.aws.S3Store.rebuild_metadata_from_index" class="md-nav__link">
    rebuild_metadata_from_index()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.aws.S3Store.remove_docs" class="md-nav__link">
    remove_docs()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.aws.S3Store.update" class="md-nav__link">
    update()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.aws.S3Store.write_doc_to_s3" class="md-nav__link">
    write_doc_to_s3()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores" class="md-nav__link">
    maggma.stores.advanced_stores
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.AliasingStore" class="md-nav__link">
    AliasingStore
  </a>
  
    <nav class="md-nav" aria-label="AliasingStore">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.AliasingStore.name" class="md-nav__link">
    name
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.AliasingStore.__eq__" class="md-nav__link">
    __eq__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.AliasingStore.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.AliasingStore.close" class="md-nav__link">
    close()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.AliasingStore.connect" class="md-nav__link">
    connect()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.AliasingStore.count" class="md-nav__link">
    count()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.AliasingStore.distinct" class="md-nav__link">
    distinct()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.AliasingStore.ensure_index" class="md-nav__link">
    ensure_index()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.AliasingStore.groupby" class="md-nav__link">
    groupby()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.AliasingStore.query" class="md-nav__link">
    query()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.AliasingStore.remove_docs" class="md-nav__link">
    remove_docs()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.AliasingStore.update" class="md-nav__link">
    update()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.MongograntStore" class="md-nav__link">
    MongograntStore
  </a>
  
    <nav class="md-nav" aria-label="MongograntStore">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.MongograntStore.name" class="md-nav__link">
    name
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.MongograntStore.__eq__" class="md-nav__link">
    __eq__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.MongograntStore.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.MongograntStore.from_collection" class="md-nav__link">
    from_collection()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.MongograntStore.from_db_file" class="md-nav__link">
    from_db_file()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.SandboxStore" class="md-nav__link">
    SandboxStore
  </a>
  
    <nav class="md-nav" aria-label="SandboxStore">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.SandboxStore.name" class="md-nav__link">
    name
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.SandboxStore.sbx_criteria" class="md-nav__link">
    sbx_criteria
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.SandboxStore.__eq__" class="md-nav__link">
    __eq__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.SandboxStore.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.SandboxStore.close" class="md-nav__link">
    close()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.SandboxStore.connect" class="md-nav__link">
    connect()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.SandboxStore.count" class="md-nav__link">
    count()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.SandboxStore.ensure_index" class="md-nav__link">
    ensure_index()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.SandboxStore.groupby" class="md-nav__link">
    groupby()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.SandboxStore.query" class="md-nav__link">
    query()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.SandboxStore.remove_docs" class="md-nav__link">
    remove_docs()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.SandboxStore.update" class="md-nav__link">
    update()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.VaultStore" class="md-nav__link">
    VaultStore
  </a>
  
    <nav class="md-nav" aria-label="VaultStore">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.VaultStore.__eq__" class="md-nav__link">
    __eq__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.VaultStore.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores" class="md-nav__link">
    maggma.stores.compound_stores
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.ConcatStore" class="md-nav__link">
    ConcatStore
  </a>
  
    <nav class="md-nav" aria-label="ConcatStore">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.ConcatStore.last_updated" class="md-nav__link">
    last_updated
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.ConcatStore.name" class="md-nav__link">
    name
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.ConcatStore.__eq__" class="md-nav__link">
    __eq__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.ConcatStore.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.ConcatStore.close" class="md-nav__link">
    close()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.ConcatStore.connect" class="md-nav__link">
    connect()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.ConcatStore.count" class="md-nav__link">
    count()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.ConcatStore.distinct" class="md-nav__link">
    distinct()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.ConcatStore.ensure_index" class="md-nav__link">
    ensure_index()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.ConcatStore.groupby" class="md-nav__link">
    groupby()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.ConcatStore.query" class="md-nav__link">
    query()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.ConcatStore.remove_docs" class="md-nav__link">
    remove_docs()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.ConcatStore.update" class="md-nav__link">
    update()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.JointStore" class="md-nav__link">
    JointStore
  </a>
  
    <nav class="md-nav" aria-label="JointStore">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.JointStore.last_updated" class="md-nav__link">
    last_updated
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.JointStore.name" class="md-nav__link">
    name
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.JointStore.nonmain_names" class="md-nav__link">
    nonmain_names
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.JointStore.__eq__" class="md-nav__link">
    __eq__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.JointStore.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.JointStore.close" class="md-nav__link">
    close()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.JointStore.connect" class="md-nav__link">
    connect()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.JointStore.count" class="md-nav__link">
    count()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.JointStore.ensure_index" class="md-nav__link">
    ensure_index()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.JointStore.groupby" class="md-nav__link">
    groupby()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.JointStore.query" class="md-nav__link">
    query()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.JointStore.query_one" class="md-nav__link">
    query_one()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.JointStore.remove_docs" class="md-nav__link">
    remove_docs()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.JointStore.update" class="md-nav__link">
    update()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../builders/" class="md-nav__link">
        Builders
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../CHANGELOG/" class="md-nav__link">
        Changelog
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#maggma.stores.mongolike" class="md-nav__link">
    maggma.stores.mongolike
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.JSONStore" class="md-nav__link">
    JSONStore
  </a>
  
    <nav class="md-nav" aria-label="JSONStore">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.JSONStore.__eq__" class="md-nav__link">
    __eq__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.JSONStore.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.JSONStore.connect" class="md-nav__link">
    connect()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.JSONStore.read_json_file" class="md-nav__link">
    read_json_file()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.JSONStore.remove_docs" class="md-nav__link">
    remove_docs()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.JSONStore.update" class="md-nav__link">
    update()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.JSONStore.update_json_file" class="md-nav__link">
    update_json_file()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MemoryStore" class="md-nav__link">
    MemoryStore
  </a>
  
    <nav class="md-nav" aria-label="MemoryStore">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MemoryStore.name" class="md-nav__link">
    name
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MemoryStore.__eq__" class="md-nav__link">
    __eq__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MemoryStore.__hash__" class="md-nav__link">
    __hash__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MemoryStore.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MemoryStore.close" class="md-nav__link">
    close()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MemoryStore.connect" class="md-nav__link">
    connect()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MemoryStore.groupby" class="md-nav__link">
    groupby()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MongoStore" class="md-nav__link">
    MongoStore
  </a>
  
    <nav class="md-nav" aria-label="MongoStore">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MongoStore.name" class="md-nav__link">
    name
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MongoStore.__eq__" class="md-nav__link">
    __eq__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MongoStore.__hash__" class="md-nav__link">
    __hash__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MongoStore.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MongoStore.close" class="md-nav__link">
    close()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MongoStore.connect" class="md-nav__link">
    connect()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MongoStore.count" class="md-nav__link">
    count()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MongoStore.distinct" class="md-nav__link">
    distinct()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MongoStore.ensure_index" class="md-nav__link">
    ensure_index()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MongoStore.from_collection" class="md-nav__link">
    from_collection()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MongoStore.from_db_file" class="md-nav__link">
    from_db_file()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MongoStore.from_launchpad_file" class="md-nav__link">
    from_launchpad_file()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MongoStore.groupby" class="md-nav__link">
    groupby()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MongoStore.query" class="md-nav__link">
    query()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MongoStore.remove_docs" class="md-nav__link">
    remove_docs()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MongoStore.update" class="md-nav__link">
    update()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MongoURIStore" class="md-nav__link">
    MongoURIStore
  </a>
  
    <nav class="md-nav" aria-label="MongoURIStore">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MongoURIStore.name" class="md-nav__link">
    name
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MongoURIStore.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MongoURIStore.connect" class="md-nav__link">
    connect()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MontyStore" class="md-nav__link">
    MontyStore
  </a>
  
    <nav class="md-nav" aria-label="MontyStore">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MontyStore.name" class="md-nav__link">
    name
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MontyStore.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MontyStore.connect" class="md-nav__link">
    connect()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MontyStore.count" class="md-nav__link">
    count()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.MontyStore.update" class="md-nav__link">
    update()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.SSHTunnel" class="md-nav__link">
    SSHTunnel
  </a>
  
    <nav class="md-nav" aria-label="SSHTunnel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#maggma.stores.mongolike.SSHTunnel.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maggma.stores.file_store" class="md-nav__link">
    maggma.stores.file_store
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maggma.stores.file_store.FileStore" class="md-nav__link">
    FileStore
  </a>
  
    <nav class="md-nav" aria-label="FileStore">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#maggma.stores.file_store.FileStore.name" class="md-nav__link">
    name
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.file_store.FileStore.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.file_store.FileStore.add_metadata" class="md-nav__link">
    add_metadata()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.file_store.FileStore.connect" class="md-nav__link">
    connect()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.file_store.FileStore.query" class="md-nav__link">
    query()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.file_store.FileStore.query_one" class="md-nav__link">
    query_one()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.file_store.FileStore.read" class="md-nav__link">
    read()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.file_store.FileStore.remove_docs" class="md-nav__link">
    remove_docs()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.file_store.FileStore.update" class="md-nav__link">
    update()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maggma.stores.gridfs" class="md-nav__link">
    maggma.stores.gridfs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maggma.stores.gridfs.GridFSStore" class="md-nav__link">
    GridFSStore
  </a>
  
    <nav class="md-nav" aria-label="GridFSStore">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#maggma.stores.gridfs.GridFSStore.last_updated" class="md-nav__link">
    last_updated
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.gridfs.GridFSStore.name" class="md-nav__link">
    name
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.gridfs.GridFSStore.__eq__" class="md-nav__link">
    __eq__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.gridfs.GridFSStore.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.gridfs.GridFSStore.close" class="md-nav__link">
    close()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.gridfs.GridFSStore.connect" class="md-nav__link">
    connect()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.gridfs.GridFSStore.count" class="md-nav__link">
    count()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.gridfs.GridFSStore.distinct" class="md-nav__link">
    distinct()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.gridfs.GridFSStore.ensure_index" class="md-nav__link">
    ensure_index()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.gridfs.GridFSStore.from_launchpad_file" class="md-nav__link">
    from_launchpad_file()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.gridfs.GridFSStore.groupby" class="md-nav__link">
    groupby()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.gridfs.GridFSStore.query" class="md-nav__link">
    query()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.gridfs.GridFSStore.remove_docs" class="md-nav__link">
    remove_docs()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.gridfs.GridFSStore.transform_criteria" class="md-nav__link">
    transform_criteria()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.gridfs.GridFSStore.update" class="md-nav__link">
    update()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maggma.stores.gridfs.GridFSURIStore" class="md-nav__link">
    GridFSURIStore
  </a>
  
    <nav class="md-nav" aria-label="GridFSURIStore">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#maggma.stores.gridfs.GridFSURIStore.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.gridfs.GridFSURIStore.connect" class="md-nav__link">
    connect()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maggma.stores.aws" class="md-nav__link">
    maggma.stores.aws
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maggma.stores.aws.S3Store" class="md-nav__link">
    S3Store
  </a>
  
    <nav class="md-nav" aria-label="S3Store">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#maggma.stores.aws.S3Store.last_updated" class="md-nav__link">
    last_updated
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.aws.S3Store.name" class="md-nav__link">
    name
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.aws.S3Store.__eq__" class="md-nav__link">
    __eq__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.aws.S3Store.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.aws.S3Store.close" class="md-nav__link">
    close()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.aws.S3Store.connect" class="md-nav__link">
    connect()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.aws.S3Store.count" class="md-nav__link">
    count()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.aws.S3Store.distinct" class="md-nav__link">
    distinct()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.aws.S3Store.ensure_index" class="md-nav__link">
    ensure_index()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.aws.S3Store.groupby" class="md-nav__link">
    groupby()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.aws.S3Store.newer_in" class="md-nav__link">
    newer_in()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.aws.S3Store.query" class="md-nav__link">
    query()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.aws.S3Store.rebuild_index_from_s3_data" class="md-nav__link">
    rebuild_index_from_s3_data()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.aws.S3Store.rebuild_metadata_from_index" class="md-nav__link">
    rebuild_metadata_from_index()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.aws.S3Store.remove_docs" class="md-nav__link">
    remove_docs()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.aws.S3Store.update" class="md-nav__link">
    update()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.aws.S3Store.write_doc_to_s3" class="md-nav__link">
    write_doc_to_s3()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores" class="md-nav__link">
    maggma.stores.advanced_stores
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.AliasingStore" class="md-nav__link">
    AliasingStore
  </a>
  
    <nav class="md-nav" aria-label="AliasingStore">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.AliasingStore.name" class="md-nav__link">
    name
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.AliasingStore.__eq__" class="md-nav__link">
    __eq__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.AliasingStore.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.AliasingStore.close" class="md-nav__link">
    close()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.AliasingStore.connect" class="md-nav__link">
    connect()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.AliasingStore.count" class="md-nav__link">
    count()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.AliasingStore.distinct" class="md-nav__link">
    distinct()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.AliasingStore.ensure_index" class="md-nav__link">
    ensure_index()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.AliasingStore.groupby" class="md-nav__link">
    groupby()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.AliasingStore.query" class="md-nav__link">
    query()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.AliasingStore.remove_docs" class="md-nav__link">
    remove_docs()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.AliasingStore.update" class="md-nav__link">
    update()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.MongograntStore" class="md-nav__link">
    MongograntStore
  </a>
  
    <nav class="md-nav" aria-label="MongograntStore">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.MongograntStore.name" class="md-nav__link">
    name
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.MongograntStore.__eq__" class="md-nav__link">
    __eq__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.MongograntStore.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.MongograntStore.from_collection" class="md-nav__link">
    from_collection()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.MongograntStore.from_db_file" class="md-nav__link">
    from_db_file()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.SandboxStore" class="md-nav__link">
    SandboxStore
  </a>
  
    <nav class="md-nav" aria-label="SandboxStore">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.SandboxStore.name" class="md-nav__link">
    name
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.SandboxStore.sbx_criteria" class="md-nav__link">
    sbx_criteria
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.SandboxStore.__eq__" class="md-nav__link">
    __eq__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.SandboxStore.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.SandboxStore.close" class="md-nav__link">
    close()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.SandboxStore.connect" class="md-nav__link">
    connect()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.SandboxStore.count" class="md-nav__link">
    count()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.SandboxStore.ensure_index" class="md-nav__link">
    ensure_index()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.SandboxStore.groupby" class="md-nav__link">
    groupby()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.SandboxStore.query" class="md-nav__link">
    query()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.SandboxStore.remove_docs" class="md-nav__link">
    remove_docs()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.SandboxStore.update" class="md-nav__link">
    update()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.VaultStore" class="md-nav__link">
    VaultStore
  </a>
  
    <nav class="md-nav" aria-label="VaultStore">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.VaultStore.__eq__" class="md-nav__link">
    __eq__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.advanced_stores.VaultStore.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores" class="md-nav__link">
    maggma.stores.compound_stores
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.ConcatStore" class="md-nav__link">
    ConcatStore
  </a>
  
    <nav class="md-nav" aria-label="ConcatStore">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.ConcatStore.last_updated" class="md-nav__link">
    last_updated
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.ConcatStore.name" class="md-nav__link">
    name
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.ConcatStore.__eq__" class="md-nav__link">
    __eq__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.ConcatStore.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.ConcatStore.close" class="md-nav__link">
    close()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.ConcatStore.connect" class="md-nav__link">
    connect()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.ConcatStore.count" class="md-nav__link">
    count()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.ConcatStore.distinct" class="md-nav__link">
    distinct()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.ConcatStore.ensure_index" class="md-nav__link">
    ensure_index()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.ConcatStore.groupby" class="md-nav__link">
    groupby()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.ConcatStore.query" class="md-nav__link">
    query()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.ConcatStore.remove_docs" class="md-nav__link">
    remove_docs()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.ConcatStore.update" class="md-nav__link">
    update()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.JointStore" class="md-nav__link">
    JointStore
  </a>
  
    <nav class="md-nav" aria-label="JointStore">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.JointStore.last_updated" class="md-nav__link">
    last_updated
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.JointStore.name" class="md-nav__link">
    name
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.JointStore.nonmain_names" class="md-nav__link">
    nonmain_names
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.JointStore.__eq__" class="md-nav__link">
    __eq__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.JointStore.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.JointStore.close" class="md-nav__link">
    close()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.JointStore.connect" class="md-nav__link">
    connect()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.JointStore.count" class="md-nav__link">
    count()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.JointStore.ensure_index" class="md-nav__link">
    ensure_index()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.JointStore.groupby" class="md-nav__link">
    groupby()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.JointStore.query" class="md-nav__link">
    query()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.JointStore.query_one" class="md-nav__link">
    query_one()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.JointStore.remove_docs" class="md-nav__link">
    remove_docs()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maggma.stores.compound_stores.JointStore.update" class="md-nav__link">
    update()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/materialsproject/maggma/edit/master/docs/reference/stores.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



  <h1>Stores</h1>

<div class="doc doc-object doc-module">

<a id="maggma.stores.mongolike"></a>
    <div class="doc doc-contents first">

      <p>Module containing various definitions of Stores.
Stores are a default access pattern to data and provide
various utilities</p>



  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h2 class="doc doc-heading" id="maggma.stores.mongolike.JSONStore">
        <code>
JSONStore            (<a class="autorefs autorefs-internal" title="maggma.stores.mongolike.MemoryStore" href="#maggma.stores.mongolike.MemoryStore">MemoryStore</a>)
        </code>



<a class="headerlink" href="#maggma.stores.mongolike.JSONStore" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>A Store for access to a single or multiple JSON files</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/mongolike.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">JSONStore</span><span class="p">(</span><span class="n">MemoryStore</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Store for access to a single or multiple JSON files</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">paths</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
        <span class="n">read_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">serialization_option</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">serialization_default</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            paths: paths for json files to turn into a Store</span>
<span class="sd">            read_only: whether this JSONStore is read only. When read_only=True,</span>
<span class="sd">                       the JSONStore can still apply MongoDB-like writable operations</span>
<span class="sd">                       (e.g. an update) because it behaves like a MemoryStore,</span>
<span class="sd">                       but it will not write those changes to the file. On the other hand,</span>
<span class="sd">                       if read_only=False (i.e., it is writeable), the JSON file</span>
<span class="sd">                       will be automatically updated every time a write-like operation is</span>
<span class="sd">                       performed.</span>

<span class="sd">                       Note that when read_only=False, JSONStore only supports a single JSON</span>
<span class="sd">                       file. If the file does not exist, it will be automatically created</span>
<span class="sd">                       when the JSONStore is initialized.</span>
<span class="sd">            serialization_option:</span>
<span class="sd">                option that will be passed to the orjson.dump when saving to the json the file.</span>
<span class="sd">            serialization_default:</span>
<span class="sd">                default that will be passed to the orjson.dump when saving to the json the file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="n">paths</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="k">else</span> <span class="p">[</span><span class="n">paths</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paths</span> <span class="o">=</span> <span class="n">paths</span>

        <span class="c1"># file_writable overrides read_only for compatibility reasons</span>
        <span class="k">if</span> <span class="s2">&quot;file_writable&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">file_writable</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;file_writable&quot;</span><span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;file_writable is deprecated; use read only instead.&quot;</span><span class="p">,</span>
                <span class="ne">DeprecationWarning</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">file_writable</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span> <span class="o">!=</span> <span class="n">read_only</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Received conflicting keyword arguments file_writable=</span><span class="si">{</span><span class="n">file_writable</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; and read_only=</span><span class="si">{</span><span class="n">read_only</span><span class="si">}</span><span class="s2">. Setting read_only=</span><span class="si">{</span><span class="n">file_writable</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
                    <span class="ne">UserWarning</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span> <span class="o">=</span> <span class="n">read_only</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot instantiate file-writable JSONStore with multiple JSON files.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># create the .json file if it does not exist</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">with</span> <span class="n">zopen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">bytesdata</span> <span class="o">=</span> <span class="n">orjson</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">bytesdata</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">default_sort</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serialization_option</span> <span class="o">=</span> <span class="n">serialization_option</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serialization_default</span> <span class="o">=</span> <span class="n">serialization_default</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_reset</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the files into the collection in memory</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">force_reset</span><span class="o">=</span><span class="n">force_reset</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">:</span>
            <span class="n">objects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_json_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    Key field &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; not found in </span><span class="si">{</span><span class="n">path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">. This</span>
<span class="s2">                    could mean that this JSONStore was initially created with a different key field.</span>
<span class="s2">                    The keys found in the .json file are </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">objects</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">. Try</span>
<span class="s2">                    re-initializing your JSONStore using one of these as the key arguments.</span>
<span class="s2">                    &quot;&quot;&quot;</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_json_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper method to read the contents of a JSON file and generate</span>
<span class="sd">        a list of docs.</span>
<span class="sd">        Args:</span>
<span class="sd">            path: Path to the JSON file to be read</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">zopen</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span> <span class="k">else</span> <span class="n">data</span>
            <span class="n">objects</span> <span class="o">=</span> <span class="n">orjson</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">objects</span> <span class="o">=</span> <span class="p">[</span><span class="n">objects</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">objects</span>
            <span class="c1"># datetime objects deserialize to str. Try to convert the last_updated</span>
            <span class="c1"># field back to datetime.</span>
            <span class="c1"># # TODO - there may still be problems caused if a JSONStore is init&#39;ed from</span>
            <span class="c1"># documents that don&#39;t contain a last_updated field</span>
            <span class="c1"># See Store.last_updated in store.py.</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span><span class="p">):</span>
                    <span class="n">obj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_dt</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">objects</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">Dict</span><span class="p">],</span> <span class="n">key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update documents into the Store.</span>

<span class="sd">        For a file-writable JSONStore, the json file is updated.</span>

<span class="sd">        Args:</span>
<span class="sd">            docs: the document or list of documents to update</span>
<span class="sd">            key: field name(s) to determine uniqueness for a</span>
<span class="sd">                 document, can be a list of multiple fields,</span>
<span class="sd">                 a single field, or None if the Store&#39;s key</span>
<span class="sd">                 field is to be used</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">docs</span><span class="o">=</span><span class="n">docs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_json_file</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">remove_docs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove docs matching the query dictionary.</span>

<span class="sd">        For a file-writable JSONStore, the json file is updated.</span>

<span class="sd">        Args:</span>
<span class="sd">            criteria: query dictionary to match</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">remove_docs</span><span class="p">(</span><span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_json_file</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">update_json_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the json file when a write-like operation is performed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">zopen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">()]</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_id&quot;</span><span class="p">)</span>
            <span class="n">bytesdata</span> <span class="o">=</span> <span class="n">orjson</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                <span class="n">data</span><span class="p">,</span>
                <span class="n">option</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">serialization_option</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">serialization_default</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">bytesdata</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check equality for JSONStore</span>

<span class="sd">        Args:</span>
<span class="sd">            other: other JSONStore to compare with</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">JSONStore</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;paths&quot;</span><span class="p">,</span> <span class="s2">&quot;last_updated_field&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.mongolike.JSONStore.__eq__">
<code class="codehilite language-python"><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.mongolike.JSONStore.__eq__" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Check equality for JSONStore</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>other</code></td>
        <td><code>object</code></td>
        <td><p>other JSONStore to compare with</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/mongolike.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check equality for JSONStore</span>

<span class="sd">    Args:</span>
<span class="sd">        other: other JSONStore to compare with</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">JSONStore</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;paths&quot;</span><span class="p">,</span> <span class="s2">&quot;last_updated_field&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>




  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.mongolike.JSONStore.__init__">
<code class="codehilite language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paths</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">serialization_option</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">serialization_default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.mongolike.JSONStore.__init__" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>paths</code></td>
        <td><code>Union[str, List[str]]</code></td>
        <td><p>paths for json files to turn into a Store</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>read_only</code></td>
        <td><code>bool</code></td>
        <td><p>whether this JSONStore is read only. When read_only=True,
       the JSONStore can still apply MongoDB-like writable operations
       (e.g. an update) because it behaves like a MemoryStore,
       but it will not write those changes to the file. On the other hand,
       if read_only=False (i.e., it is writeable), the JSON file
       will be automatically updated every time a write-like operation is
       performed.</p>
<div class="codehilite"><pre><span></span><code><span class="w">   </span><span class="nv">Note</span><span class="w"> </span><span class="nv">that</span><span class="w"> </span><span class="nv">when</span><span class="w"> </span><span class="nv">read_only</span><span class="o">=</span><span class="nv">False</span>,<span class="w"> </span><span class="nv">JSONStore</span><span class="w"> </span><span class="nv">only</span><span class="w"> </span><span class="nv">supports</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">single</span><span class="w"> </span><span class="nv">JSON</span>
<span class="w">   </span><span class="nv">file</span>.<span class="w"> </span><span class="k">If</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">file</span><span class="w"> </span><span class="nv">does</span><span class="w"> </span><span class="nv">not</span><span class="w"> </span><span class="nv">exist</span>,<span class="w"> </span><span class="nv">it</span><span class="w"> </span><span class="nv">will</span><span class="w"> </span><span class="nv">be</span><span class="w"> </span><span class="nv">automatically</span><span class="w"> </span><span class="nv">created</span>
<span class="w">   </span><span class="nv">when</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">JSONStore</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">initialized</span>.
</code></pre></div></td>
        <td><code>True</code></td>
      </tr>
      <tr>
        <td><code>serialization_option</code></td>
        <td><code>Optional[int]</code></td>
        <td><p>option that will be passed to the orjson.dump when saving to the json the file.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>serialization_default</code></td>
        <td><code>Any</code></td>
        <td><p>default that will be passed to the orjson.dump when saving to the json the file.</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/mongolike.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">paths</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
    <span class="n">read_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">serialization_option</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">serialization_default</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        paths: paths for json files to turn into a Store</span>
<span class="sd">        read_only: whether this JSONStore is read only. When read_only=True,</span>
<span class="sd">                   the JSONStore can still apply MongoDB-like writable operations</span>
<span class="sd">                   (e.g. an update) because it behaves like a MemoryStore,</span>
<span class="sd">                   but it will not write those changes to the file. On the other hand,</span>
<span class="sd">                   if read_only=False (i.e., it is writeable), the JSON file</span>
<span class="sd">                   will be automatically updated every time a write-like operation is</span>
<span class="sd">                   performed.</span>

<span class="sd">                   Note that when read_only=False, JSONStore only supports a single JSON</span>
<span class="sd">                   file. If the file does not exist, it will be automatically created</span>
<span class="sd">                   when the JSONStore is initialized.</span>
<span class="sd">        serialization_option:</span>
<span class="sd">            option that will be passed to the orjson.dump when saving to the json the file.</span>
<span class="sd">        serialization_default:</span>
<span class="sd">            default that will be passed to the orjson.dump when saving to the json the file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="n">paths</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="k">else</span> <span class="p">[</span><span class="n">paths</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">paths</span> <span class="o">=</span> <span class="n">paths</span>

    <span class="c1"># file_writable overrides read_only for compatibility reasons</span>
    <span class="k">if</span> <span class="s2">&quot;file_writable&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">file_writable</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;file_writable&quot;</span><span class="p">)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;file_writable is deprecated; use read only instead.&quot;</span><span class="p">,</span>
            <span class="ne">DeprecationWarning</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">file_writable</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span> <span class="o">!=</span> <span class="n">read_only</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Received conflicting keyword arguments file_writable=</span><span class="si">{</span><span class="n">file_writable</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; and read_only=</span><span class="si">{</span><span class="n">read_only</span><span class="si">}</span><span class="s2">. Setting read_only=</span><span class="si">{</span><span class="n">file_writable</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
                <span class="ne">UserWarning</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span> <span class="o">=</span> <span class="n">read_only</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;Cannot instantiate file-writable JSONStore with multiple JSON files.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># create the .json file if it does not exist</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">with</span> <span class="n">zopen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">bytesdata</span> <span class="o">=</span> <span class="n">orjson</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">bytesdata</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">default_sort</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">serialization_option</span> <span class="o">=</span> <span class="n">serialization_option</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">serialization_default</span> <span class="o">=</span> <span class="n">serialization_default</span>

    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.mongolike.JSONStore.connect">
<code class="codehilite language-python"><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_reset</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.mongolike.JSONStore.connect" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Loads the files into the collection in memory</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/mongolike.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_reset</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loads the files into the collection in memory</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">force_reset</span><span class="o">=</span><span class="n">force_reset</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">:</span>
        <span class="n">objects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_json_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                Key field &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; not found in </span><span class="si">{</span><span class="n">path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">. This</span>
<span class="s2">                could mean that this JSONStore was initially created with a different key field.</span>
<span class="s2">                The keys found in the .json file are </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">objects</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">. Try</span>
<span class="s2">                re-initializing your JSONStore using one of these as the key arguments.</span>
<span class="s2">                &quot;&quot;&quot;</span>
            <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.mongolike.JSONStore.read_json_file">
<code class="codehilite language-python"><span class="n">read_json_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.mongolike.JSONStore.read_json_file" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Helper method to read the contents of a JSON file and generate
a list of docs.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>path</code></td>
        <td></td>
        <td><p>Path to the JSON file to be read</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/mongolike.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">read_json_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper method to read the contents of a JSON file and generate</span>
<span class="sd">    a list of docs.</span>
<span class="sd">    Args:</span>
<span class="sd">        path: Path to the JSON file to be read</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">zopen</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span> <span class="k">else</span> <span class="n">data</span>
        <span class="n">objects</span> <span class="o">=</span> <span class="n">orjson</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">objects</span> <span class="o">=</span> <span class="p">[</span><span class="n">objects</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">objects</span>
        <span class="c1"># datetime objects deserialize to str. Try to convert the last_updated</span>
        <span class="c1"># field back to datetime.</span>
        <span class="c1"># # TODO - there may still be problems caused if a JSONStore is init&#39;ed from</span>
        <span class="c1"># documents that don&#39;t contain a last_updated field</span>
        <span class="c1"># See Store.last_updated in store.py.</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span><span class="p">):</span>
                <span class="n">obj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_dt</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">objects</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.mongolike.JSONStore.remove_docs">
<code class="codehilite language-python"><span class="n">remove_docs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.mongolike.JSONStore.remove_docs" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Remove docs matching the query dictionary.</p>
<p>For a file-writable JSONStore, the json file is updated.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>criteria</code></td>
        <td><code>Dict</code></td>
        <td><p>query dictionary to match</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/mongolike.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">remove_docs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove docs matching the query dictionary.</span>

<span class="sd">    For a file-writable JSONStore, the json file is updated.</span>

<span class="sd">    Args:</span>
<span class="sd">        criteria: query dictionary to match</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">remove_docs</span><span class="p">(</span><span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_json_file</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.mongolike.JSONStore.update">
<code class="codehilite language-python"><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.mongolike.JSONStore.update" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Update documents into the Store.</p>
<p>For a file-writable JSONStore, the json file is updated.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>docs</code></td>
        <td><code>Union[List[Dict], Dict]</code></td>
        <td><p>the document or list of documents to update</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>key</code></td>
        <td><code>Union[List, str]</code></td>
        <td><p>field name(s) to determine uniqueness for a
 document, can be a list of multiple fields,
 a single field, or None if the Store's key
 field is to be used</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/mongolike.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">Dict</span><span class="p">],</span> <span class="n">key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update documents into the Store.</span>

<span class="sd">    For a file-writable JSONStore, the json file is updated.</span>

<span class="sd">    Args:</span>
<span class="sd">        docs: the document or list of documents to update</span>
<span class="sd">        key: field name(s) to determine uniqueness for a</span>
<span class="sd">             document, can be a list of multiple fields,</span>
<span class="sd">             a single field, or None if the Store&#39;s key</span>
<span class="sd">             field is to be used</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">docs</span><span class="o">=</span><span class="n">docs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_json_file</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.mongolike.JSONStore.update_json_file">
<code class="codehilite language-python"><span class="n">update_json_file</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.mongolike.JSONStore.update_json_file" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Updates the json file when a write-like operation is performed.</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/mongolike.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">update_json_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Updates the json file when a write-like operation is performed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">zopen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">()]</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_id&quot;</span><span class="p">)</span>
        <span class="n">bytesdata</span> <span class="o">=</span> <span class="n">orjson</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
            <span class="n">data</span><span class="p">,</span>
            <span class="n">option</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">serialization_option</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">serialization_default</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">bytesdata</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h2 class="doc doc-heading" id="maggma.stores.mongolike.MemoryStore">
        <code>
MemoryStore            (<a class="autorefs autorefs-internal" title="maggma.stores.mongolike.MongoStore" href="#maggma.stores.mongolike.MongoStore">MongoStore</a>)
        </code>



<a class="headerlink" href="#maggma.stores.mongolike.MemoryStore" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>An in-memory Store that functions similarly
to a MongoStore</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/mongolike.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">MemoryStore</span><span class="p">(</span><span class="n">MongoStore</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An in-memory Store that functions similarly</span>
<span class="sd">    to a MongoStore</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;memory_db&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the Memory Store</span>
<span class="sd">        Args:</span>
<span class="sd">            collection_name: name for the collection in memory</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span> <span class="o">=</span> <span class="n">collection_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_sort</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MongoStore</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># noqa</span>

    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_reset</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Connect to the source data</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">force_reset</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="o">=</span> <span class="n">mongomock</span><span class="o">.</span><span class="n">MongoClient</span><span class="p">()</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>  <span class="c1"># type: ignore</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Close up all collections&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Name for the store&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;mem://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Hash for the store&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">groupby</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">keys</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">properties</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">skip</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simple grouping function that will group documents</span>
<span class="sd">        by keys.</span>

<span class="sd">        Args:</span>
<span class="sd">            keys: fields to group documents</span>
<span class="sd">            criteria: PyMongo filter for documents to search in</span>
<span class="sd">            properties: properties to return in grouped documents</span>
<span class="sd">            sort: Dictionary of sort order for fields. Keys are field names and</span>
<span class="sd">                values are 1 for ascending or -1 for descending.</span>
<span class="sd">            skip: number documents to skip</span>
<span class="sd">            limit: limit on total number of documents returned</span>

<span class="sd">        Returns:</span>
<span class="sd">            generator returning tuples of (key, list of elements)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">keys</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">keys</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">properties</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">properties</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">properties</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">properties</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">doc</span>
            <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">properties</span><span class="o">=</span><span class="n">keys</span> <span class="o">+</span> <span class="n">properties</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">has</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="k">def</span> <span class="nf">grouping_keys</span><span class="p">(</span><span class="n">doc</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">get</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">vals</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">grouping_keys</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="n">grouping_keys</span><span class="p">):</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: ignore</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">vals</span><span class="p">):</span>
                <span class="n">set_</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">doc</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check equality for MemoryStore</span>
<span class="sd">        other: other MemoryStore to compare with</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">MemoryStore</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;collection_name&quot;</span><span class="p">,</span> <span class="s2">&quot;last_updated_field&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="maggma.stores.mongolike.MemoryStore.name">
<code class="codehilite language-python"><span class="n">name</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.mongolike.MemoryStore.name" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Name for the store</p>
    </div>

  </div>






  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.mongolike.MemoryStore.__eq__">
<code class="codehilite language-python"><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.mongolike.MemoryStore.__eq__" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Check equality for MemoryStore
other: other MemoryStore to compare with</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/mongolike.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check equality for MemoryStore</span>
<span class="sd">    other: other MemoryStore to compare with</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">MemoryStore</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;collection_name&quot;</span><span class="p">,</span> <span class="s2">&quot;last_updated_field&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.mongolike.MemoryStore.__hash__">
<code class="codehilite language-python"><span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.mongolike.MemoryStore.__hash__" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Hash for the store</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/mongolike.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Hash for the store&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.mongolike.MemoryStore.__init__">
<code class="codehilite language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection_name</span><span class="o">=</span><span class="s1">&#39;memory_db&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.mongolike.MemoryStore.__init__" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Initializes the Memory Store</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>collection_name</code></td>
        <td><code>str</code></td>
        <td><p>name for the collection in memory</p></td>
        <td><code>&#39;memory_db&#39;</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/mongolike.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;memory_db&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initializes the Memory Store</span>
<span class="sd">    Args:</span>
<span class="sd">        collection_name: name for the collection in memory</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span> <span class="o">=</span> <span class="n">collection_name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">default_sort</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">MongoStore</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># noqa</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.mongolike.MemoryStore.close">
<code class="codehilite language-python"><span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.mongolike.MemoryStore.close" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Close up all collections</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/mongolike.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Close up all collections&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.mongolike.MemoryStore.connect">
<code class="codehilite language-python"><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_reset</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.mongolike.MemoryStore.connect" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Connect to the source data</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/mongolike.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_reset</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Connect to the source data</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">force_reset</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="o">=</span> <span class="n">mongomock</span><span class="o">.</span><span class="n">MongoClient</span><span class="p">()</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.mongolike.MemoryStore.groupby">
<code class="codehilite language-python"><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.mongolike.MemoryStore.groupby" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Simple grouping function that will group documents
by keys.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>keys</code></td>
        <td><code>Union[List[str], str]</code></td>
        <td><p>fields to group documents</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>criteria</code></td>
        <td><code>Optional[Dict]</code></td>
        <td><p>PyMongo filter for documents to search in</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>properties</code></td>
        <td><code>Union[Dict, List]</code></td>
        <td><p>properties to return in grouped documents</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>sort</code></td>
        <td><code>Optional[Dict[str, Union[maggma.core.store.Sort, int]]]</code></td>
        <td><p>Dictionary of sort order for fields. Keys are field names and
values are 1 for ascending or -1 for descending.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>skip</code></td>
        <td><code>int</code></td>
        <td><p>number documents to skip</p></td>
        <td><code>0</code></td>
      </tr>
      <tr>
        <td><code>limit</code></td>
        <td><code>int</code></td>
        <td><p>limit on total number of documents returned</p></td>
        <td><code>0</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Iterator[Tuple[Dict, List[Dict]]]</code></td>
      <td><p>generator returning tuples of (key, list of elements)</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/mongolike.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">groupby</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">keys</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">],</span>
    <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">properties</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">sort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">skip</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple grouping function that will group documents</span>
<span class="sd">    by keys.</span>

<span class="sd">    Args:</span>
<span class="sd">        keys: fields to group documents</span>
<span class="sd">        criteria: PyMongo filter for documents to search in</span>
<span class="sd">        properties: properties to return in grouped documents</span>
<span class="sd">        sort: Dictionary of sort order for fields. Keys are field names and</span>
<span class="sd">            values are 1 for ascending or -1 for descending.</span>
<span class="sd">        skip: number documents to skip</span>
<span class="sd">        limit: limit on total number of documents returned</span>

<span class="sd">    Returns:</span>
<span class="sd">        generator returning tuples of (key, list of elements)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="n">keys</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">keys</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">properties</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">properties</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">doc</span>
        <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">properties</span><span class="o">=</span><span class="n">keys</span> <span class="o">+</span> <span class="n">properties</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">has</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="nf">grouping_keys</span><span class="p">(</span><span class="n">doc</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">get</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">vals</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">grouping_keys</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="n">grouping_keys</span><span class="p">):</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: ignore</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">vals</span><span class="p">):</span>
            <span class="n">set_</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">doc</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h2 class="doc doc-heading" id="maggma.stores.mongolike.MongoStore">
        <code>
MongoStore            (<a class="autorefs autorefs-internal" title="maggma.core.store.Store" href="../core_store/#maggma.core.store.Store">Store</a>)
        </code>



<a class="headerlink" href="#maggma.stores.mongolike.MongoStore" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>A Store that connects to a Mongo collection</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/mongolike.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">MongoStore</span><span class="p">(</span><span class="n">Store</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Store that connects to a Mongo collection</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">database</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span>
        <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">27017</span><span class="p">,</span>
        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">ssh_tunnel</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SSHTunnel</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">safe_update</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">auth_source</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mongoclient_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">default_sort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            database: The database name</span>
<span class="sd">            collection_name: The collection name</span>
<span class="sd">            host: Hostname for the database</span>
<span class="sd">            port: TCP port to connect to</span>
<span class="sd">            username: Username for the collection</span>
<span class="sd">            password: Password to connect with</span>
<span class="sd">            safe_update: fail gracefully on DocumentTooLarge errors on update</span>
<span class="sd">            auth_source: The database to authenticate on. Defaults to the database name.</span>
<span class="sd">            default_sort: Default sort field and direction to use when querying. Can be used to</span>
<span class="sd">                ensure determinacy in query results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span> <span class="o">=</span> <span class="n">collection_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">password</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssh_tunnel</span> <span class="o">=</span> <span class="n">ssh_tunnel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">safe_update</span> <span class="o">=</span> <span class="n">safe_update</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_sort</span> <span class="o">=</span> <span class="n">default_sort</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

        <span class="k">if</span> <span class="n">auth_source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">auth_source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auth_source</span> <span class="o">=</span> <span class="n">auth_source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mongoclient_kwargs</span> <span class="o">=</span> <span class="n">mongoclient_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a string representing this data source</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;mongo://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_reset</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Connect to the source data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">force_reset</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssh_tunnel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span>
                <span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ssh_tunnel</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssh_tunnel</span><span class="o">.</span><span class="n">local_address</span>

            <span class="n">conn</span><span class="p">:</span> <span class="n">MongoClient</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">MongoClient</span><span class="p">(</span>
                    <span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span>
                    <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span>
                    <span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
                    <span class="n">password</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">,</span>
                    <span class="n">authSource</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">auth_source</span><span class="p">,</span>
                    <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">mongoclient_kwargs</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">else</span> <span class="n">MongoClient</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">mongoclient_kwargs</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">db</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="p">]</span>  <span class="c1"># type: ignore</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Hash for MongoStore&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_db_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience method to construct MongoStore from db_file</span>
<span class="sd">        from old QueryEngine format</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">loadfn</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;collection&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;collection_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;collection&quot;</span><span class="p">)</span>
        <span class="c1"># Get rid of aliases from traditional query engine db docs</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;aliases&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_launchpad_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">lp_file</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience method to construct MongoStore from a launchpad file</span>

<span class="sd">        Note: A launchpad file is a special formatted yaml file used in fireworks</span>

<span class="sd">        Returns:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">lp_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">lp_creds</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

        <span class="n">db_creds</span> <span class="o">=</span> <span class="n">lp_creds</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">db_creds</span><span class="p">[</span><span class="s2">&quot;database&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">db_creds</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">db_creds</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;database&quot;</span><span class="p">,</span> <span class="s2">&quot;host&quot;</span><span class="p">,</span> <span class="s2">&quot;port&quot;</span><span class="p">,</span> <span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">]:</span>
                <span class="n">db_creds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">db_creds</span><span class="p">[</span><span class="s2">&quot;collection_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collection_name</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">db_creds</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">distinct</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">all_exist</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get all distinct values for a field</span>

<span class="sd">        Args:</span>
<span class="sd">            field: the field(s) to get distinct values for</span>
<span class="sd">            criteria: PyMongo filter for documents to search in</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">criteria</span> <span class="o">=</span> <span class="n">criteria</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">distinct_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">criteria</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">OperationFailure</span><span class="p">,</span> <span class="n">DocumentTooLarge</span><span class="p">):</span>
            <span class="n">distinct_vals</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">d</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
                    <span class="p">[{</span><span class="s2">&quot;$match&quot;</span><span class="p">:</span> <span class="n">criteria</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;$group&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;$</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}}]</span>
                <span class="p">)</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">distinct_vals</span><span class="p">)):</span>  <span class="c1"># type: ignore</span>
                <span class="n">distinct_vals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">distinct_vals</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">distinct_vals</span> <span class="k">if</span> <span class="n">distinct_vals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">groupby</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">keys</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">properties</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">skip</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simple grouping function that will group documents</span>
<span class="sd">        by keys.</span>

<span class="sd">        Args:</span>
<span class="sd">            keys: fields to group documents</span>
<span class="sd">            criteria: PyMongo filter for documents to search in</span>
<span class="sd">            properties: properties to return in grouped documents</span>
<span class="sd">            sort: Dictionary of sort order for fields. Keys are field names and</span>
<span class="sd">                values are 1 for ascending or -1 for descending.</span>
<span class="sd">            skip: number documents to skip</span>
<span class="sd">            limit: limit on total number of documents returned</span>

<span class="sd">        Returns:</span>
<span class="sd">            generator returning tuples of (key, list of docs)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">keys</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">properties</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">properties</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">properties</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">properties</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">criteria</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$match&quot;</span><span class="p">:</span> <span class="n">criteria</span><span class="p">})</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$project&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">properties</span> <span class="o">+</span> <span class="n">keys</span><span class="p">}})</span>

        <span class="n">alpha</span> <span class="o">=</span> <span class="s2">&quot;abcdefghijklmnopqrstuvwxyz&quot;</span>
        <span class="n">group_id</span> <span class="o">=</span> <span class="p">{</span><span class="n">letter</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;$</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">letter</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">keys</span><span class="p">)}</span>
        <span class="n">pipeline</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$group&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">group_id</span><span class="p">,</span> <span class="s2">&quot;docs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$push&quot;</span><span class="p">:</span> <span class="s2">&quot;$$ROOT&quot;</span><span class="p">}}})</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">allowDiskUse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">id_doc</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: ignore</span>
            <span class="k">for</span> <span class="n">letter</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">group_id</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">has</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">],</span> <span class="n">letter</span><span class="p">):</span>
                    <span class="n">set_</span><span class="p">(</span><span class="n">id_doc</span><span class="p">,</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">][</span><span class="n">letter</span><span class="p">])</span>
            <span class="k">yield</span> <span class="p">(</span><span class="n">id_doc</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;docs&quot;</span><span class="p">])</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_collection</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">collection</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a MongoStore from a pymongo collection object</span>
<span class="sd">        This is not a fully safe operation as it gives dummy information to the MongoStore</span>
<span class="sd">        As a result, this will not serialize and can not reset its connection</span>

<span class="sd">        Args:</span>
<span class="sd">            collection: the PyMongo collection to create a MongoStore around</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: How do we make this safer?</span>
        <span class="n">coll_name</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">name</span>
        <span class="n">db_name</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">name</span>

        <span class="n">store</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">coll_name</span><span class="p">)</span>
        <span class="n">store</span><span class="o">.</span><span class="n">_coll</span> <span class="o">=</span> <span class="n">collection</span>
        <span class="k">return</span> <span class="n">store</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Property referring to underlying pymongo collection&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StoreError</span><span class="p">(</span>
                <span class="s2">&quot;Must connect Mongo-like store before attempting to use it&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span>

    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">hint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Counts the number of documents matching the query criteria</span>

<span class="sd">        Args:</span>
<span class="sd">            criteria: PyMongo filter for documents to count in</span>
<span class="sd">            hint: Dictionary of indexes to use as hints for query optimizer.</span>
<span class="sd">                Keys are field names and values are 1 for ascending or -1 for descending.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">criteria</span> <span class="o">=</span> <span class="n">criteria</span> <span class="k">if</span> <span class="n">criteria</span> <span class="k">else</span> <span class="p">{}</span>

        <span class="n">hint_list</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[</span>
                <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">Sort</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">hint</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="n">hint</span>
            <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">hint_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">count_documents</span><span class="p">(</span><span class="nb">filter</span><span class="o">=</span><span class="n">criteria</span><span class="p">,</span> <span class="n">hint</span><span class="o">=</span><span class="n">hint_list</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">count_documents</span><span class="p">(</span><span class="nb">filter</span><span class="o">=</span><span class="n">criteria</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">criteria</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">estimated_document_count</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">properties</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">hint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">skip</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Queries the Store for a set of documents</span>

<span class="sd">        Args:</span>
<span class="sd">            criteria: PyMongo filter for documents to search in</span>
<span class="sd">            properties: properties to return in grouped documents</span>
<span class="sd">            sort: Dictionary of sort order for fields. Keys are field names and</span>
<span class="sd">                values are 1 for ascending or -1 for descending.</span>
<span class="sd">            hint: Dictionary of indexes to use as hints for query optimizer.</span>
<span class="sd">                Keys are field names and values are 1 for ascending or -1 for descending.</span>
<span class="sd">            skip: number documents to skip</span>
<span class="sd">            limit: limit on total number of documents returned</span>
<span class="sd">            mongoclient_kwargs: Dict of extra kwargs to pass to pymongo find.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">}</span>

        <span class="n">default_sort_formatted</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_sort</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">default_sort_formatted</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">Sort</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_sort</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">]</span>

        <span class="n">sort_list</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[</span>
                <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">Sort</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sort</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="n">sort</span>
            <span class="k">else</span> <span class="n">default_sort_formatted</span>
        <span class="p">)</span>

        <span class="n">hint_list</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[</span>
                <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">Sort</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">hint</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="n">hint</span>
            <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
            <span class="nb">filter</span><span class="o">=</span><span class="n">criteria</span><span class="p">,</span>
            <span class="n">projection</span><span class="o">=</span><span class="n">properties</span><span class="p">,</span>
            <span class="n">skip</span><span class="o">=</span><span class="n">skip</span><span class="p">,</span>
            <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span>
            <span class="n">sort</span><span class="o">=</span><span class="n">sort_list</span><span class="p">,</span>
            <span class="n">hint</span><span class="o">=</span><span class="n">hint_list</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">yield</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">ensure_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">unique</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tries to create an index and return true if it succeeded</span>
<span class="sd">        Args:</span>
<span class="sd">            key: single key to index</span>
<span class="sd">            unique: Whether or not this index contains only unique keys</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool indicating if the index exists/was created</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">confirm_field_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="n">unique</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">Dict</span><span class="p">],</span> <span class="n">key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update documents into the Store</span>

<span class="sd">        Args:</span>
<span class="sd">            docs: the document or list of documents to update</span>
<span class="sd">            key: field name(s) to determine uniqueness for a</span>
<span class="sd">                 document, can be a list of multiple fields,</span>
<span class="sd">                 a single field, or None if the Store&#39;s key</span>
<span class="sd">                 field is to be used</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">requests</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">docs</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">docs</span> <span class="o">=</span> <span class="p">[</span><span class="n">docs</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">jsanitize</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">allow_bson</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># document-level validation is optional</span>
            <span class="n">validates</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="p">:</span>
                <span class="n">validates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">validates</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="o">.</span><span class="n">strict</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="o">.</span><span class="n">validation_errors</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="o">.</span><span class="n">validation_errors</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">validates</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">key</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">search_doc</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">key</span><span class="p">}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">search_doc</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]}</span>

                <span class="n">requests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ReplaceOne</span><span class="p">(</span><span class="n">search_doc</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">upsert</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">requests</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">bulk_write</span><span class="p">(</span><span class="n">requests</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">OperationFailure</span><span class="p">,</span> <span class="n">DocumentTooLarge</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">safe_update</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">requests</span><span class="p">:</span>
                        <span class="n">req</span><span class="o">.</span><span class="n">_filter</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">bulk_write</span><span class="p">([</span><span class="n">req</span><span class="p">],</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="k">except</span> <span class="p">(</span><span class="n">OperationFailure</span><span class="p">,</span> <span class="n">DocumentTooLarge</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Could not upload document for </span><span class="si">{</span><span class="n">req</span><span class="o">.</span><span class="n">_filter</span><span class="si">}</span><span class="s2"> as it was too large for Mongo&quot;</span>
                            <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>

    <span class="k">def</span> <span class="nf">remove_docs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove docs matching the query dictionary</span>

<span class="sd">        Args:</span>
<span class="sd">            criteria: query dictionary to match</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">delete_many</span><span class="p">(</span><span class="nb">filter</span><span class="o">=</span><span class="n">criteria</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Close up all collections&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssh_tunnel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ssh_tunnel</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check equality for MongoStore</span>
<span class="sd">        other: other mongostore to compare with</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">MongoStore</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;database&quot;</span><span class="p">,</span> <span class="s2">&quot;collection_name&quot;</span><span class="p">,</span> <span class="s2">&quot;host&quot;</span><span class="p">,</span> <span class="s2">&quot;port&quot;</span><span class="p">,</span> <span class="s2">&quot;last_updated_field&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="maggma.stores.mongolike.MongoStore.name">
<code class="codehilite language-python"><span class="n">name</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.mongolike.MongoStore.name" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Return a string representing this data source</p>
    </div>

  </div>






  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.mongolike.MongoStore.__eq__">
<code class="codehilite language-python"><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.mongolike.MongoStore.__eq__" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Check equality for MongoStore
other: other mongostore to compare with</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/mongolike.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check equality for MongoStore</span>
<span class="sd">    other: other mongostore to compare with</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">MongoStore</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;database&quot;</span><span class="p">,</span> <span class="s2">&quot;collection_name&quot;</span><span class="p">,</span> <span class="s2">&quot;host&quot;</span><span class="p">,</span> <span class="s2">&quot;port&quot;</span><span class="p">,</span> <span class="s2">&quot;last_updated_field&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.mongolike.MongoStore.__hash__">
<code class="codehilite language-python"><span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.mongolike.MongoStore.__hash__" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Hash for MongoStore</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/mongolike.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Hash for MongoStore&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.mongolike.MongoStore.__init__">
<code class="codehilite language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">27017</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ssh_tunnel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">safe_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">auth_source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mongoclient_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default_sort</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.mongolike.MongoStore.__init__" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>database</code></td>
        <td><code>str</code></td>
        <td><p>The database name</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>collection_name</code></td>
        <td><code>str</code></td>
        <td><p>The collection name</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>host</code></td>
        <td><code>str</code></td>
        <td><p>Hostname for the database</p></td>
        <td><code>&#39;localhost&#39;</code></td>
      </tr>
      <tr>
        <td><code>port</code></td>
        <td><code>int</code></td>
        <td><p>TCP port to connect to</p></td>
        <td><code>27017</code></td>
      </tr>
      <tr>
        <td><code>username</code></td>
        <td><code>str</code></td>
        <td><p>Username for the collection</p></td>
        <td><code>&#39;&#39;</code></td>
      </tr>
      <tr>
        <td><code>password</code></td>
        <td><code>str</code></td>
        <td><p>Password to connect with</p></td>
        <td><code>&#39;&#39;</code></td>
      </tr>
      <tr>
        <td><code>safe_update</code></td>
        <td><code>bool</code></td>
        <td><p>fail gracefully on DocumentTooLarge errors on update</p></td>
        <td><code>False</code></td>
      </tr>
      <tr>
        <td><code>auth_source</code></td>
        <td><code>Optional[str]</code></td>
        <td><p>The database to authenticate on. Defaults to the database name.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>default_sort</code></td>
        <td><code>Optional[Dict[str, Union[maggma.core.store.Sort, int]]]</code></td>
        <td><p>Default sort field and direction to use when querying. Can be used to
ensure determinacy in query results.</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/mongolike.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">database</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span>
    <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">27017</span><span class="p">,</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">ssh_tunnel</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SSHTunnel</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">safe_update</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">auth_source</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">mongoclient_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">default_sort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        database: The database name</span>
<span class="sd">        collection_name: The collection name</span>
<span class="sd">        host: Hostname for the database</span>
<span class="sd">        port: TCP port to connect to</span>
<span class="sd">        username: Username for the collection</span>
<span class="sd">        password: Password to connect with</span>
<span class="sd">        safe_update: fail gracefully on DocumentTooLarge errors on update</span>
<span class="sd">        auth_source: The database to authenticate on. Defaults to the database name.</span>
<span class="sd">        default_sort: Default sort field and direction to use when querying. Can be used to</span>
<span class="sd">            ensure determinacy in query results.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">database</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span> <span class="o">=</span> <span class="n">collection_name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">password</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ssh_tunnel</span> <span class="o">=</span> <span class="n">ssh_tunnel</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">safe_update</span> <span class="o">=</span> <span class="n">safe_update</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">default_sort</span> <span class="o">=</span> <span class="n">default_sort</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

    <span class="k">if</span> <span class="n">auth_source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">auth_source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">auth_source</span> <span class="o">=</span> <span class="n">auth_source</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mongoclient_kwargs</span> <span class="o">=</span> <span class="n">mongoclient_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>

    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.mongolike.MongoStore.close">
<code class="codehilite language-python"><span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.mongolike.MongoStore.close" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Close up all collections</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/mongolike.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Close up all collections&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssh_tunnel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssh_tunnel</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.mongolike.MongoStore.connect">
<code class="codehilite language-python"><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_reset</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.mongolike.MongoStore.connect" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Connect to the source data</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/mongolike.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_reset</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Connect to the source data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">force_reset</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssh_tunnel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span>
            <span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ssh_tunnel</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssh_tunnel</span><span class="o">.</span><span class="n">local_address</span>

        <span class="n">conn</span><span class="p">:</span> <span class="n">MongoClient</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">MongoClient</span><span class="p">(</span>
                <span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span>
                <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span>
                <span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
                <span class="n">password</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">,</span>
                <span class="n">authSource</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">auth_source</span><span class="p">,</span>
                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">mongoclient_kwargs</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">else</span> <span class="n">MongoClient</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">mongoclient_kwargs</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.mongolike.MongoStore.count">
<code class="codehilite language-python"><span class="n">count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hint</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.mongolike.MongoStore.count" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Counts the number of documents matching the query criteria</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>criteria</code></td>
        <td><code>Optional[Dict]</code></td>
        <td><p>PyMongo filter for documents to count in</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>hint</code></td>
        <td><code>Optional[Dict[str, Union[maggma.core.store.Sort, int]]]</code></td>
        <td><p>Dictionary of indexes to use as hints for query optimizer.
Keys are field names and values are 1 for ascending or -1 for descending.</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/mongolike.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">count</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">hint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Counts the number of documents matching the query criteria</span>

<span class="sd">    Args:</span>
<span class="sd">        criteria: PyMongo filter for documents to count in</span>
<span class="sd">        hint: Dictionary of indexes to use as hints for query optimizer.</span>
<span class="sd">            Keys are field names and values are 1 for ascending or -1 for descending.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">criteria</span> <span class="o">=</span> <span class="n">criteria</span> <span class="k">if</span> <span class="n">criteria</span> <span class="k">else</span> <span class="p">{}</span>

    <span class="n">hint_list</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">[</span>
            <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">Sort</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">hint</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">hint</span>
        <span class="k">else</span> <span class="kc">None</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">hint_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">count_documents</span><span class="p">(</span><span class="nb">filter</span><span class="o">=</span><span class="n">criteria</span><span class="p">,</span> <span class="n">hint</span><span class="o">=</span><span class="n">hint_list</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">count_documents</span><span class="p">(</span><span class="nb">filter</span><span class="o">=</span><span class="n">criteria</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">criteria</span>
        <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">estimated_document_count</span><span class="p">()</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.mongolike.MongoStore.distinct">
<code class="codehilite language-python"><span class="n">distinct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">all_exist</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.mongolike.MongoStore.distinct" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Get all distinct values for a field</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>field</code></td>
        <td><code>str</code></td>
        <td><p>the field(s) to get distinct values for</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>criteria</code></td>
        <td><code>Optional[Dict]</code></td>
        <td><p>PyMongo filter for documents to search in</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/mongolike.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">distinct</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">all_exist</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get all distinct values for a field</span>

<span class="sd">    Args:</span>
<span class="sd">        field: the field(s) to get distinct values for</span>
<span class="sd">        criteria: PyMongo filter for documents to search in</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">criteria</span> <span class="o">=</span> <span class="n">criteria</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">distinct_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">criteria</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">OperationFailure</span><span class="p">,</span> <span class="n">DocumentTooLarge</span><span class="p">):</span>
        <span class="n">distinct_vals</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">d</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
                <span class="p">[{</span><span class="s2">&quot;$match&quot;</span><span class="p">:</span> <span class="n">criteria</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;$group&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;$</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}}]</span>
            <span class="p">)</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">distinct_vals</span><span class="p">)):</span>  <span class="c1"># type: ignore</span>
            <span class="n">distinct_vals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">distinct_vals</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">distinct_vals</span> <span class="k">if</span> <span class="n">distinct_vals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[]</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.mongolike.MongoStore.ensure_index">
<code class="codehilite language-python"><span class="n">ensure_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.mongolike.MongoStore.ensure_index" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Tries to create an index and return true if it succeeded</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>key</code></td>
        <td><code>str</code></td>
        <td><p>single key to index</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>unique</code></td>
        <td><code>Optional[bool]</code></td>
        <td><p>Whether or not this index contains only unique keys</p></td>
        <td><code>False</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>bool</code></td>
      <td><p>bool indicating if the index exists/was created</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/mongolike.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">ensure_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">unique</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tries to create an index and return true if it succeeded</span>
<span class="sd">    Args:</span>
<span class="sd">        key: single key to index</span>
<span class="sd">        unique: Whether or not this index contains only unique keys</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool indicating if the index exists/was created</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">confirm_field_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="n">unique</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.mongolike.MongoStore.from_collection">
<code class="codehilite language-python"><span class="n">from_collection</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-classmethod"><code>classmethod</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.mongolike.MongoStore.from_collection" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Generates a MongoStore from a pymongo collection object
This is not a fully safe operation as it gives dummy information to the MongoStore
As a result, this will not serialize and can not reset its connection</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>collection</code></td>
        <td></td>
        <td><p>the PyMongo collection to create a MongoStore around</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/mongolike.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">from_collection</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">collection</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates a MongoStore from a pymongo collection object</span>
<span class="sd">    This is not a fully safe operation as it gives dummy information to the MongoStore</span>
<span class="sd">    As a result, this will not serialize and can not reset its connection</span>

<span class="sd">    Args:</span>
<span class="sd">        collection: the PyMongo collection to create a MongoStore around</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: How do we make this safer?</span>
    <span class="n">coll_name</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">name</span>
    <span class="n">db_name</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">name</span>

    <span class="n">store</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">coll_name</span><span class="p">)</span>
    <span class="n">store</span><span class="o">.</span><span class="n">_coll</span> <span class="o">=</span> <span class="n">collection</span>
    <span class="k">return</span> <span class="n">store</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.mongolike.MongoStore.from_db_file">
<code class="codehilite language-python"><span class="n">from_db_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-classmethod"><code>classmethod</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.mongolike.MongoStore.from_db_file" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Convenience method to construct MongoStore from db_file
from old QueryEngine format</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/mongolike.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">from_db_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convenience method to construct MongoStore from db_file</span>
<span class="sd">    from old QueryEngine format</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">loadfn</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;collection&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;collection_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;collection&quot;</span><span class="p">)</span>
    <span class="c1"># Get rid of aliases from traditional query engine db docs</span>
    <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;aliases&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.mongolike.MongoStore.from_launchpad_file">
<code class="codehilite language-python"><span class="n">from_launchpad_file</span><span class="p">(</span><span class="n">lp_file</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-classmethod"><code>classmethod</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.mongolike.MongoStore.from_launchpad_file" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Convenience method to construct MongoStore from a launchpad file</p>
<p>Note: A launchpad file is a special formatted yaml file used in fireworks</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/mongolike.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">from_launchpad_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">lp_file</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convenience method to construct MongoStore from a launchpad file</span>

<span class="sd">    Note: A launchpad file is a special formatted yaml file used in fireworks</span>

<span class="sd">    Returns:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">lp_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lp_creds</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

    <span class="n">db_creds</span> <span class="o">=</span> <span class="n">lp_creds</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">db_creds</span><span class="p">[</span><span class="s2">&quot;database&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">db_creds</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">db_creds</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;database&quot;</span><span class="p">,</span> <span class="s2">&quot;host&quot;</span><span class="p">,</span> <span class="s2">&quot;port&quot;</span><span class="p">,</span> <span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">]:</span>
            <span class="n">db_creds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">db_creds</span><span class="p">[</span><span class="s2">&quot;collection_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collection_name</span>

    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">db_creds</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.mongolike.MongoStore.groupby">
<code class="codehilite language-python"><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.mongolike.MongoStore.groupby" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Simple grouping function that will group documents
by keys.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>keys</code></td>
        <td><code>Union[List[str], str]</code></td>
        <td><p>fields to group documents</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>criteria</code></td>
        <td><code>Optional[Dict]</code></td>
        <td><p>PyMongo filter for documents to search in</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>properties</code></td>
        <td><code>Union[Dict, List]</code></td>
        <td><p>properties to return in grouped documents</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>sort</code></td>
        <td><code>Optional[Dict[str, Union[maggma.core.store.Sort, int]]]</code></td>
        <td><p>Dictionary of sort order for fields. Keys are field names and
values are 1 for ascending or -1 for descending.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>skip</code></td>
        <td><code>int</code></td>
        <td><p>number documents to skip</p></td>
        <td><code>0</code></td>
      </tr>
      <tr>
        <td><code>limit</code></td>
        <td><code>int</code></td>
        <td><p>limit on total number of documents returned</p></td>
        <td><code>0</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Iterator[Tuple[Dict, List[Dict]]]</code></td>
      <td><p>generator returning tuples of (key, list of docs)</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/mongolike.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">groupby</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">keys</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">],</span>
    <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">properties</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">sort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">skip</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple grouping function that will group documents</span>
<span class="sd">    by keys.</span>

<span class="sd">    Args:</span>
<span class="sd">        keys: fields to group documents</span>
<span class="sd">        criteria: PyMongo filter for documents to search in</span>
<span class="sd">        properties: properties to return in grouped documents</span>
<span class="sd">        sort: Dictionary of sort order for fields. Keys are field names and</span>
<span class="sd">            values are 1 for ascending or -1 for descending.</span>
<span class="sd">        skip: number documents to skip</span>
<span class="sd">        limit: limit on total number of documents returned</span>

<span class="sd">    Returns:</span>
<span class="sd">        generator returning tuples of (key, list of docs)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">keys</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">properties</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">properties</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">criteria</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pipeline</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$match&quot;</span><span class="p">:</span> <span class="n">criteria</span><span class="p">})</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">pipeline</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$project&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">properties</span> <span class="o">+</span> <span class="n">keys</span><span class="p">}})</span>

    <span class="n">alpha</span> <span class="o">=</span> <span class="s2">&quot;abcdefghijklmnopqrstuvwxyz&quot;</span>
    <span class="n">group_id</span> <span class="o">=</span> <span class="p">{</span><span class="n">letter</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;$</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">letter</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">keys</span><span class="p">)}</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$group&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">group_id</span><span class="p">,</span> <span class="s2">&quot;docs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$push&quot;</span><span class="p">:</span> <span class="s2">&quot;$$ROOT&quot;</span><span class="p">}}})</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">allowDiskUse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">id_doc</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: ignore</span>
        <span class="k">for</span> <span class="n">letter</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">group_id</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">has</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">],</span> <span class="n">letter</span><span class="p">):</span>
                <span class="n">set_</span><span class="p">(</span><span class="n">id_doc</span><span class="p">,</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">][</span><span class="n">letter</span><span class="p">])</span>
        <span class="k">yield</span> <span class="p">(</span><span class="n">id_doc</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;docs&quot;</span><span class="p">])</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.mongolike.MongoStore.query">
<code class="codehilite language-python"><span class="n">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.mongolike.MongoStore.query" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Queries the Store for a set of documents</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>criteria</code></td>
        <td><code>Optional[Dict]</code></td>
        <td><p>PyMongo filter for documents to search in</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>properties</code></td>
        <td><code>Union[Dict, List]</code></td>
        <td><p>properties to return in grouped documents</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>sort</code></td>
        <td><code>Optional[Dict[str, Union[maggma.core.store.Sort, int]]]</code></td>
        <td><p>Dictionary of sort order for fields. Keys are field names and
values are 1 for ascending or -1 for descending.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>hint</code></td>
        <td><code>Optional[Dict[str, Union[maggma.core.store.Sort, int]]]</code></td>
        <td><p>Dictionary of indexes to use as hints for query optimizer.
Keys are field names and values are 1 for ascending or -1 for descending.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>skip</code></td>
        <td><code>int</code></td>
        <td><p>number documents to skip</p></td>
        <td><code>0</code></td>
      </tr>
      <tr>
        <td><code>limit</code></td>
        <td><code>int</code></td>
        <td><p>limit on total number of documents returned</p></td>
        <td><code>0</code></td>
      </tr>
      <tr>
        <td><code>mongoclient_kwargs</code></td>
        <td></td>
        <td><p>Dict of extra kwargs to pass to pymongo find.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/mongolike.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">query</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">properties</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">sort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">hint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">skip</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Queries the Store for a set of documents</span>

<span class="sd">    Args:</span>
<span class="sd">        criteria: PyMongo filter for documents to search in</span>
<span class="sd">        properties: properties to return in grouped documents</span>
<span class="sd">        sort: Dictionary of sort order for fields. Keys are field names and</span>
<span class="sd">            values are 1 for ascending or -1 for descending.</span>
<span class="sd">        hint: Dictionary of indexes to use as hints for query optimizer.</span>
<span class="sd">            Keys are field names and values are 1 for ascending or -1 for descending.</span>
<span class="sd">        skip: number documents to skip</span>
<span class="sd">        limit: limit on total number of documents returned</span>
<span class="sd">        mongoclient_kwargs: Dict of extra kwargs to pass to pymongo find.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">}</span>

    <span class="n">default_sort_formatted</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_sort</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">default_sort_formatted</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">Sort</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_sort</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">]</span>

    <span class="n">sort_list</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">[</span>
            <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">Sort</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sort</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">sort</span>
        <span class="k">else</span> <span class="n">default_sort_formatted</span>
    <span class="p">)</span>

    <span class="n">hint_list</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">[</span>
            <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">Sort</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">hint</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">hint</span>
        <span class="k">else</span> <span class="kc">None</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
        <span class="nb">filter</span><span class="o">=</span><span class="n">criteria</span><span class="p">,</span>
        <span class="n">projection</span><span class="o">=</span><span class="n">properties</span><span class="p">,</span>
        <span class="n">skip</span><span class="o">=</span><span class="n">skip</span><span class="p">,</span>
        <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span>
        <span class="n">sort</span><span class="o">=</span><span class="n">sort_list</span><span class="p">,</span>
        <span class="n">hint</span><span class="o">=</span><span class="n">hint_list</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">yield</span> <span class="n">d</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.mongolike.MongoStore.remove_docs">
<code class="codehilite language-python"><span class="n">remove_docs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.mongolike.MongoStore.remove_docs" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Remove docs matching the query dictionary</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>criteria</code></td>
        <td><code>Dict</code></td>
        <td><p>query dictionary to match</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/mongolike.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">remove_docs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove docs matching the query dictionary</span>

<span class="sd">    Args:</span>
<span class="sd">        criteria: query dictionary to match</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">delete_many</span><span class="p">(</span><span class="nb">filter</span><span class="o">=</span><span class="n">criteria</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.mongolike.MongoStore.update">
<code class="codehilite language-python"><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.mongolike.MongoStore.update" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Update documents into the Store</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>docs</code></td>
        <td><code>Union[List[Dict], Dict]</code></td>
        <td><p>the document or list of documents to update</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>key</code></td>
        <td><code>Union[List, str]</code></td>
        <td><p>field name(s) to determine uniqueness for a
 document, can be a list of multiple fields,
 a single field, or None if the Store's key
 field is to be used</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/mongolike.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">Dict</span><span class="p">],</span> <span class="n">key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update documents into the Store</span>

<span class="sd">    Args:</span>
<span class="sd">        docs: the document or list of documents to update</span>
<span class="sd">        key: field name(s) to determine uniqueness for a</span>
<span class="sd">             document, can be a list of multiple fields,</span>
<span class="sd">             a single field, or None if the Store&#39;s key</span>
<span class="sd">             field is to be used</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">requests</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">docs</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">docs</span> <span class="o">=</span> <span class="p">[</span><span class="n">docs</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">jsanitize</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">allow_bson</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># document-level validation is optional</span>
        <span class="n">validates</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="p">:</span>
            <span class="n">validates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">validates</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="o">.</span><span class="n">strict</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="o">.</span><span class="n">validation_errors</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="o">.</span><span class="n">validation_errors</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">validates</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">key</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">search_doc</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">key</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">search_doc</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]}</span>

            <span class="n">requests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ReplaceOne</span><span class="p">(</span><span class="n">search_doc</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">upsert</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">requests</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">bulk_write</span><span class="p">(</span><span class="n">requests</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">OperationFailure</span><span class="p">,</span> <span class="n">DocumentTooLarge</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">safe_update</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">requests</span><span class="p">:</span>
                    <span class="n">req</span><span class="o">.</span><span class="n">_filter</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">bulk_write</span><span class="p">([</span><span class="n">req</span><span class="p">],</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">except</span> <span class="p">(</span><span class="n">OperationFailure</span><span class="p">,</span> <span class="n">DocumentTooLarge</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Could not upload document for </span><span class="si">{</span><span class="n">req</span><span class="o">.</span><span class="n">_filter</span><span class="si">}</span><span class="s2"> as it was too large for Mongo&quot;</span>
                        <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h2 class="doc doc-heading" id="maggma.stores.mongolike.MongoURIStore">
        <code>
MongoURIStore            (<a class="autorefs autorefs-internal" title="maggma.stores.mongolike.MongoStore" href="#maggma.stores.mongolike.MongoStore">MongoStore</a>)
        </code>



<a class="headerlink" href="#maggma.stores.mongolike.MongoURIStore" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>A Store that connects to a Mongo collection via a URI
This is expected to be a special mongodb+srv:// URIs that include
client parameters via TXT records</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/mongolike.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">MongoURIStore</span><span class="p">(</span><span class="n">MongoStore</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Store that connects to a Mongo collection via a URI</span>
<span class="sd">    This is expected to be a special mongodb+srv:// URIs that include</span>
<span class="sd">    client parameters via TXT records</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">database</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ssh_tunnel</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SSHTunnel</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mongoclient_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">default_sort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            uri: MongoDB+SRV URI</span>
<span class="sd">            database: database to connect to</span>
<span class="sd">            collection_name: The collection name</span>
<span class="sd">            default_sort: Default sort field and direction to use when querying. Can be used to</span>
<span class="sd">                ensure determinacy in query results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uri</span> <span class="o">=</span> <span class="n">uri</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssh_tunnel</span> <span class="o">=</span> <span class="n">ssh_tunnel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_sort</span> <span class="o">=</span> <span class="n">default_sort</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mongoclient_kwargs</span> <span class="o">=</span> <span class="n">mongoclient_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="c1"># parse the dbname from the uri</span>
        <span class="k">if</span> <span class="n">database</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">d_uri</span> <span class="o">=</span> <span class="n">uri_parser</span><span class="o">.</span><span class="n">parse_uri</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">d_uri</span><span class="p">[</span><span class="s2">&quot;database&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                    <span class="s2">&quot;If database name is not supplied, a database must be set in the uri&quot;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">d_uri</span><span class="p">[</span><span class="s2">&quot;database&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">database</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span> <span class="o">=</span> <span class="n">collection_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MongoStore</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># lgtm</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a string representing this data source</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: This is not very safe since it exposes the username/password info</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">uri</span>

    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_reset</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Connect to the source data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">force_reset</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="n">conn</span><span class="p">:</span> <span class="n">MongoClient</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uri</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">mongoclient_kwargs</span><span class="p">)</span>
            <span class="n">db</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="maggma.stores.mongolike.MongoURIStore.name">
<code class="codehilite language-python"><span class="n">name</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.mongolike.MongoURIStore.name" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Return a string representing this data source</p>
    </div>

  </div>






  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.mongolike.MongoURIStore.__init__">
<code class="codehilite language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ssh_tunnel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mongoclient_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default_sort</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.mongolike.MongoURIStore.__init__" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>uri</code></td>
        <td><code>str</code></td>
        <td><p>MongoDB+SRV URI</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>database</code></td>
        <td><code>str</code></td>
        <td><p>database to connect to</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>collection_name</code></td>
        <td><code>str</code></td>
        <td><p>The collection name</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>default_sort</code></td>
        <td><code>Optional[Dict[str, Union[maggma.core.store.Sort, int]]]</code></td>
        <td><p>Default sort field and direction to use when querying. Can be used to
ensure determinacy in query results.</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/mongolike.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">database</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ssh_tunnel</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SSHTunnel</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">mongoclient_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">default_sort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        uri: MongoDB+SRV URI</span>
<span class="sd">        database: database to connect to</span>
<span class="sd">        collection_name: The collection name</span>
<span class="sd">        default_sort: Default sort field and direction to use when querying. Can be used to</span>
<span class="sd">            ensure determinacy in query results.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">uri</span> <span class="o">=</span> <span class="n">uri</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ssh_tunnel</span> <span class="o">=</span> <span class="n">ssh_tunnel</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">default_sort</span> <span class="o">=</span> <span class="n">default_sort</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mongoclient_kwargs</span> <span class="o">=</span> <span class="n">mongoclient_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>

    <span class="c1"># parse the dbname from the uri</span>
    <span class="k">if</span> <span class="n">database</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">d_uri</span> <span class="o">=</span> <span class="n">uri_parser</span><span class="o">.</span><span class="n">parse_uri</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">d_uri</span><span class="p">[</span><span class="s2">&quot;database&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="s2">&quot;If database name is not supplied, a database must be set in the uri&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">d_uri</span><span class="p">[</span><span class="s2">&quot;database&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">database</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span> <span class="o">=</span> <span class="n">collection_name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">MongoStore</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># lgtm</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.mongolike.MongoURIStore.connect">
<code class="codehilite language-python"><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_reset</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.mongolike.MongoURIStore.connect" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Connect to the source data</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/mongolike.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_reset</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Connect to the source data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">force_reset</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">conn</span><span class="p">:</span> <span class="n">MongoClient</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uri</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">mongoclient_kwargs</span><span class="p">)</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h2 class="doc doc-heading" id="maggma.stores.mongolike.MontyStore">
        <code>
MontyStore            (<a class="autorefs autorefs-internal" title="maggma.stores.mongolike.MemoryStore" href="#maggma.stores.mongolike.MemoryStore">MemoryStore</a>)
        </code>



<a class="headerlink" href="#maggma.stores.mongolike.MontyStore" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>A MongoDB compatible store that uses on disk files for storage.</p>
<p>This is handled under the hood using MontyDB. A number of on-disk storage options
are available but MontyDB provides a mongo style interface for all options. The
options include:</p>
<ul>
<li>sqlite: Uses an sqlite database to store documents.</li>
<li>lightning: Uses Lightning Memory-Mapped Database (LMDB) for storage. This can
  provide fast read and write times but requires lmdb to be installed (in most cases
  this can be achieved using <code>pip install lmdb</code>).</li>
<li>flatfile: Uses a system of flat json files. This is not recommended as multiple
  simultaneous connections to the store will not work correctly.</li>
</ul>
<p>See the MontyDB repository for more information: https://github.com/davidlatwe/montydb</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/mongolike.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">MontyStore</span><span class="p">(</span><span class="n">MemoryStore</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A MongoDB compatible store that uses on disk files for storage.</span>

<span class="sd">    This is handled under the hood using MontyDB. A number of on-disk storage options</span>
<span class="sd">    are available but MontyDB provides a mongo style interface for all options. The</span>
<span class="sd">    options include:</span>

<span class="sd">    - sqlite: Uses an sqlite database to store documents.</span>
<span class="sd">    - lightning: Uses Lightning Memory-Mapped Database (LMDB) for storage. This can</span>
<span class="sd">      provide fast read and write times but requires lmdb to be installed (in most cases</span>
<span class="sd">      this can be achieved using ``pip install lmdb``).</span>
<span class="sd">    - flatfile: Uses a system of flat json files. This is not recommended as multiple</span>
<span class="sd">      simultaneous connections to the store will not work correctly.</span>

<span class="sd">    See the MontyDB repository for more information: https://github.com/davidlatwe/montydb</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">collection_name</span><span class="p">,</span>
        <span class="n">database_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">database_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;db&quot;</span><span class="p">,</span>
        <span class="n">storage</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;sqlite&quot;</span><span class="p">,</span>
        <span class="n">storage_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">client_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the Monty Store.</span>

<span class="sd">        Args:</span>
<span class="sd">            collection_name: Name for the collection.</span>
<span class="sd">            database_path: Path to on-disk database files. If None, the current working</span>
<span class="sd">                directory will be used.</span>
<span class="sd">            database_name: The database name.</span>
<span class="sd">            storage: The storage type. Options include &quot;sqlite&quot;, &quot;lightning&quot;, &quot;flatfile&quot;.</span>
<span class="sd">            storage_kwargs: Keyword arguments passed to ``montydb.set_storage``.</span>
<span class="sd">            client_kwargs: Keyword arguments passed to the ``montydb.MontyClient``</span>
<span class="sd">                constructor.</span>
<span class="sd">            **kwargs: Additional keyword arguments passed to the Store constructor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">database_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">database_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">database_path</span> <span class="o">=</span> <span class="n">database_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database_name</span> <span class="o">=</span> <span class="n">database_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span> <span class="o">=</span> <span class="n">collection_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_sort</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssh_tunnel</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># This is to fix issues with the tunnel on close</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage</span> <span class="o">=</span> <span class="n">storage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage_kwargs</span> <span class="o">=</span> <span class="n">storage_kwargs</span> <span class="ow">or</span> <span class="p">{</span>
            <span class="s2">&quot;use_bson&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;monty_version&quot;</span><span class="p">:</span> <span class="s2">&quot;4.0&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_kwargs</span> <span class="o">=</span> <span class="n">client_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MongoStore</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># noqa</span>

    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_reset</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Connect to the database store.</span>

<span class="sd">        Args:</span>
<span class="sd">            force_reset: Force connection reset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">montydb</span> <span class="kn">import</span> <span class="n">set_storage</span><span class="p">,</span> <span class="n">MontyClient</span>  <span class="c1"># type: ignore</span>

        <span class="n">set_storage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database_path</span><span class="p">,</span> <span class="n">storage</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_kwargs</span><span class="p">)</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">MontyClient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database_path</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">client_kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="ow">or</span> <span class="n">force_reset</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="o">=</span> <span class="n">client</span><span class="p">[</span><span class="s2">&quot;db&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a string representing this data source.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;monty://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">database_path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">hint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Counts the number of documents matching the query criteria</span>

<span class="sd">        Args:</span>
<span class="sd">            criteria: PyMongo filter for documents to count in</span>
<span class="sd">            hint: Dictionary of indexes to use as hints for query optimizer.</span>
<span class="sd">                Keys are field names and values are 1 for ascending or -1 for descending.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">criteria</span> <span class="o">=</span> <span class="n">criteria</span> <span class="k">if</span> <span class="n">criteria</span> <span class="k">else</span> <span class="p">{}</span>

        <span class="n">hint_list</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[</span>
                <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">Sort</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">hint</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="n">hint</span>
            <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">hint_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">count_documents</span><span class="p">(</span><span class="nb">filter</span><span class="o">=</span><span class="n">criteria</span><span class="p">,</span> <span class="n">hint</span><span class="o">=</span><span class="n">hint_list</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">count_documents</span><span class="p">(</span><span class="nb">filter</span><span class="o">=</span><span class="n">criteria</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">Dict</span><span class="p">],</span> <span class="n">key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update documents into the Store.</span>

<span class="sd">        Args:</span>
<span class="sd">            docs: The document or list of documents to update.</span>
<span class="sd">            key: Field name(s) to determine uniqueness for a document, can be a list of</span>
<span class="sd">                multiple fields, a single field, or None if the Store&#39;s key field is to be</span>
<span class="sd">                used.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">docs</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">docs</span> <span class="o">=</span> <span class="p">[</span><span class="n">docs</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">jsanitize</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">allow_bson</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># document-level validation is optional</span>
            <span class="n">validates</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="p">:</span>
                <span class="n">validates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">validates</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="o">.</span><span class="n">strict</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="o">.</span><span class="n">validation_errors</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="o">.</span><span class="n">validation_errors</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">validates</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">key</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">search_doc</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">key</span><span class="p">}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">search_doc</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]}</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">replace_one</span><span class="p">(</span><span class="n">search_doc</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">upsert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="maggma.stores.mongolike.MontyStore.name">
<code class="codehilite language-python"><span class="n">name</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.mongolike.MontyStore.name" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Return a string representing this data source.</p>
    </div>

  </div>






  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.mongolike.MontyStore.__init__">
<code class="codehilite language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">,</span> <span class="n">database_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">database_name</span><span class="o">=</span><span class="s1">&#39;db&#39;</span><span class="p">,</span> <span class="n">storage</span><span class="o">=</span><span class="s1">&#39;sqlite&#39;</span><span class="p">,</span> <span class="n">storage_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">client_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.mongolike.MontyStore.__init__" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Initializes the Monty Store.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>collection_name</code></td>
        <td></td>
        <td><p>Name for the collection.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>database_path</code></td>
        <td><code>str</code></td>
        <td><p>Path to on-disk database files. If None, the current working
directory will be used.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>database_name</code></td>
        <td><code>str</code></td>
        <td><p>The database name.</p></td>
        <td><code>&#39;db&#39;</code></td>
      </tr>
      <tr>
        <td><code>storage</code></td>
        <td><code>str</code></td>
        <td><p>The storage type. Options include "sqlite", "lightning", "flatfile".</p></td>
        <td><code>&#39;sqlite&#39;</code></td>
      </tr>
      <tr>
        <td><code>storage_kwargs</code></td>
        <td><code>Optional[dict]</code></td>
        <td><p>Keyword arguments passed to <code>montydb.set_storage</code>.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>client_kwargs</code></td>
        <td><code>Optional[dict]</code></td>
        <td><p>Keyword arguments passed to the <code>montydb.MontyClient</code>
constructor.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>**kwargs</code></td>
        <td></td>
        <td><p>Additional keyword arguments passed to the Store constructor.</p></td>
        <td><code>{}</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/mongolike.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">collection_name</span><span class="p">,</span>
    <span class="n">database_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">database_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;db&quot;</span><span class="p">,</span>
    <span class="n">storage</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;sqlite&quot;</span><span class="p">,</span>
    <span class="n">storage_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">client_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initializes the Monty Store.</span>

<span class="sd">    Args:</span>
<span class="sd">        collection_name: Name for the collection.</span>
<span class="sd">        database_path: Path to on-disk database files. If None, the current working</span>
<span class="sd">            directory will be used.</span>
<span class="sd">        database_name: The database name.</span>
<span class="sd">        storage: The storage type. Options include &quot;sqlite&quot;, &quot;lightning&quot;, &quot;flatfile&quot;.</span>
<span class="sd">        storage_kwargs: Keyword arguments passed to ``montydb.set_storage``.</span>
<span class="sd">        client_kwargs: Keyword arguments passed to the ``montydb.MontyClient``</span>
<span class="sd">            constructor.</span>
<span class="sd">        **kwargs: Additional keyword arguments passed to the Store constructor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">database_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">database_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">())</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">database_path</span> <span class="o">=</span> <span class="n">database_path</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">database_name</span> <span class="o">=</span> <span class="n">database_name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span> <span class="o">=</span> <span class="n">collection_name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">default_sort</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ssh_tunnel</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># This is to fix issues with the tunnel on close</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">storage</span> <span class="o">=</span> <span class="n">storage</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">storage_kwargs</span> <span class="o">=</span> <span class="n">storage_kwargs</span> <span class="ow">or</span> <span class="p">{</span>
        <span class="s2">&quot;use_bson&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;monty_version&quot;</span><span class="p">:</span> <span class="s2">&quot;4.0&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">client_kwargs</span> <span class="o">=</span> <span class="n">client_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">MongoStore</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># noqa</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.mongolike.MontyStore.connect">
<code class="codehilite language-python"><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_reset</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.mongolike.MontyStore.connect" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Connect to the database store.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>force_reset</code></td>
        <td><code>bool</code></td>
        <td><p>Force connection reset.</p></td>
        <td><code>False</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/mongolike.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_reset</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Connect to the database store.</span>

<span class="sd">    Args:</span>
<span class="sd">        force_reset: Force connection reset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">montydb</span> <span class="kn">import</span> <span class="n">set_storage</span><span class="p">,</span> <span class="n">MontyClient</span>  <span class="c1"># type: ignore</span>

    <span class="n">set_storage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database_path</span><span class="p">,</span> <span class="n">storage</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_kwargs</span><span class="p">)</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">MontyClient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database_path</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">client_kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="ow">or</span> <span class="n">force_reset</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="o">=</span> <span class="n">client</span><span class="p">[</span><span class="s2">&quot;db&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="p">]</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.mongolike.MontyStore.count">
<code class="codehilite language-python"><span class="n">count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hint</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.mongolike.MontyStore.count" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Counts the number of documents matching the query criteria</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>criteria</code></td>
        <td><code>Optional[Dict]</code></td>
        <td><p>PyMongo filter for documents to count in</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>hint</code></td>
        <td><code>Optional[Dict[str, Union[maggma.core.store.Sort, int]]]</code></td>
        <td><p>Dictionary of indexes to use as hints for query optimizer.
Keys are field names and values are 1 for ascending or -1 for descending.</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/mongolike.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">count</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">hint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Counts the number of documents matching the query criteria</span>

<span class="sd">    Args:</span>
<span class="sd">        criteria: PyMongo filter for documents to count in</span>
<span class="sd">        hint: Dictionary of indexes to use as hints for query optimizer.</span>
<span class="sd">            Keys are field names and values are 1 for ascending or -1 for descending.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">criteria</span> <span class="o">=</span> <span class="n">criteria</span> <span class="k">if</span> <span class="n">criteria</span> <span class="k">else</span> <span class="p">{}</span>

    <span class="n">hint_list</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">[</span>
            <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">Sort</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">hint</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">hint</span>
        <span class="k">else</span> <span class="kc">None</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">hint_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">count_documents</span><span class="p">(</span><span class="nb">filter</span><span class="o">=</span><span class="n">criteria</span><span class="p">,</span> <span class="n">hint</span><span class="o">=</span><span class="n">hint_list</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">count_documents</span><span class="p">(</span><span class="nb">filter</span><span class="o">=</span><span class="n">criteria</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.mongolike.MontyStore.update">
<code class="codehilite language-python"><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.mongolike.MontyStore.update" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Update documents into the Store.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>docs</code></td>
        <td><code>Union[List[Dict], Dict]</code></td>
        <td><p>The document or list of documents to update.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>key</code></td>
        <td><code>Union[List, str]</code></td>
        <td><p>Field name(s) to determine uniqueness for a document, can be a list of
multiple fields, a single field, or None if the Store's key field is to be
used.</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/mongolike.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">Dict</span><span class="p">],</span> <span class="n">key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update documents into the Store.</span>

<span class="sd">    Args:</span>
<span class="sd">        docs: The document or list of documents to update.</span>
<span class="sd">        key: Field name(s) to determine uniqueness for a document, can be a list of</span>
<span class="sd">            multiple fields, a single field, or None if the Store&#39;s key field is to be</span>
<span class="sd">            used.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">docs</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">docs</span> <span class="o">=</span> <span class="p">[</span><span class="n">docs</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">jsanitize</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">allow_bson</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># document-level validation is optional</span>
        <span class="n">validates</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="p">:</span>
            <span class="n">validates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">validates</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="o">.</span><span class="n">strict</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="o">.</span><span class="n">validation_errors</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="o">.</span><span class="n">validation_errors</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">validates</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">key</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">search_doc</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">key</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">search_doc</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]}</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">replace_one</span><span class="p">(</span><span class="n">search_doc</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">upsert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h2 class="doc doc-heading" id="maggma.stores.mongolike.SSHTunnel">
        <code>
SSHTunnel            (<span title="monty.json.MSONable">MSONable</span>)
        </code>



<a class="headerlink" href="#maggma.stores.mongolike.SSHTunnel" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>maggma/stores/mongolike.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">SSHTunnel</span><span class="p">(</span><span class="n">MSONable</span><span class="p">):</span>
    <span class="n">__TUNNELS</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">SSHTunnelForwarder</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tunnel_server_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">remote_server_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">username</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">password</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">private_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            tunnel_server_address: string address with port for the SSH tunnel server</span>
<span class="sd">            remote_server_address: string address with port for the server to connect to</span>
<span class="sd">            username: optional username for the ssh tunnel server</span>
<span class="sd">            password: optional password for the ssh tunnel server; If a private_key is</span>
<span class="sd">                supplied this password is assumed to be the private key password</span>
<span class="sd">            private_key: ssh private key to authenticate to the tunnel server</span>
<span class="sd">            kwargs: any extra args passed to the SSHTunnelForwarder</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tunnel_server_address</span> <span class="o">=</span> <span class="n">tunnel_server_address</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remote_server_address</span> <span class="o">=</span> <span class="n">remote_server_address</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">password</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">private_key</span> <span class="o">=</span> <span class="n">private_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

        <span class="k">if</span> <span class="n">remote_server_address</span> <span class="ow">in</span> <span class="n">SSHTunnel</span><span class="o">.</span><span class="n">__TUNNELS</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tunnel</span> <span class="o">=</span> <span class="n">SSHTunnel</span><span class="o">.</span><span class="n">__TUNNELS</span><span class="p">[</span><span class="n">remote_server_address</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">open_port</span> <span class="o">=</span> <span class="n">_find_free_port</span><span class="p">(</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">)</span>
            <span class="n">local_bind_address</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="n">open_port</span><span class="p">)</span>

            <span class="n">ssh_address</span><span class="p">,</span> <span class="n">ssh_port</span> <span class="o">=</span> <span class="n">tunnel_server_address</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
            <span class="n">ssh_port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ssh_port</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

            <span class="n">remote_bind_address</span><span class="p">,</span> <span class="n">remote_bind_port</span> <span class="o">=</span> <span class="n">remote_server_address</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
            <span class="n">remote_bind_port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">remote_bind_port</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

            <span class="k">if</span> <span class="n">private_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ssh_password</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">ssh_private_key_password</span> <span class="o">=</span> <span class="n">password</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ssh_password</span> <span class="o">=</span> <span class="n">password</span>
                <span class="n">ssh_private_key_password</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">tunnel</span> <span class="o">=</span> <span class="n">SSHTunnelForwarder</span><span class="p">(</span>
                <span class="n">ssh_address_or_host</span><span class="o">=</span><span class="p">(</span><span class="n">ssh_address</span><span class="p">,</span> <span class="n">ssh_port</span><span class="p">),</span>
                <span class="n">local_bind_address</span><span class="o">=</span><span class="n">local_bind_address</span><span class="p">,</span>
                <span class="n">remote_bind_address</span><span class="o">=</span><span class="p">(</span><span class="n">remote_bind_address</span><span class="p">,</span> <span class="n">remote_bind_port</span><span class="p">),</span>
                <span class="n">ssh_username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
                <span class="n">ssh_password</span><span class="o">=</span><span class="n">ssh_password</span><span class="p">,</span>
                <span class="n">ssh_private_key_password</span><span class="o">=</span><span class="n">ssh_private_key_password</span><span class="p">,</span>
                <span class="n">ssh_pkey</span><span class="o">=</span><span class="n">private_key</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tunnel</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tunnel</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tunnel</span><span class="o">.</span><span class="n">tunnel_is_up</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tunnel</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">local_address</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tunnel</span><span class="o">.</span><span class="n">local_bind_address</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.mongolike.SSHTunnel.__init__">
<code class="codehilite language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tunnel_server_address</span><span class="p">,</span> <span class="n">remote_server_address</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">private_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.mongolike.SSHTunnel.__init__" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>tunnel_server_address</code></td>
        <td><code>str</code></td>
        <td><p>string address with port for the SSH tunnel server</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>remote_server_address</code></td>
        <td><code>str</code></td>
        <td><p>string address with port for the server to connect to</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>username</code></td>
        <td><code>Optional[str]</code></td>
        <td><p>optional username for the ssh tunnel server</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>password</code></td>
        <td><code>Optional[str]</code></td>
        <td><p>optional password for the ssh tunnel server; If a private_key is
supplied this password is assumed to be the private key password</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>private_key</code></td>
        <td><code>Optional[str]</code></td>
        <td><p>ssh private key to authenticate to the tunnel server</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>kwargs</code></td>
        <td></td>
        <td><p>any extra args passed to the SSHTunnelForwarder</p></td>
        <td><code>{}</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/mongolike.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">tunnel_server_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">remote_server_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">username</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">password</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">private_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        tunnel_server_address: string address with port for the SSH tunnel server</span>
<span class="sd">        remote_server_address: string address with port for the server to connect to</span>
<span class="sd">        username: optional username for the ssh tunnel server</span>
<span class="sd">        password: optional password for the ssh tunnel server; If a private_key is</span>
<span class="sd">            supplied this password is assumed to be the private key password</span>
<span class="sd">        private_key: ssh private key to authenticate to the tunnel server</span>
<span class="sd">        kwargs: any extra args passed to the SSHTunnelForwarder</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">tunnel_server_address</span> <span class="o">=</span> <span class="n">tunnel_server_address</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">remote_server_address</span> <span class="o">=</span> <span class="n">remote_server_address</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">password</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">private_key</span> <span class="o">=</span> <span class="n">private_key</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

    <span class="k">if</span> <span class="n">remote_server_address</span> <span class="ow">in</span> <span class="n">SSHTunnel</span><span class="o">.</span><span class="n">__TUNNELS</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tunnel</span> <span class="o">=</span> <span class="n">SSHTunnel</span><span class="o">.</span><span class="n">__TUNNELS</span><span class="p">[</span><span class="n">remote_server_address</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">open_port</span> <span class="o">=</span> <span class="n">_find_free_port</span><span class="p">(</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">)</span>
        <span class="n">local_bind_address</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="n">open_port</span><span class="p">)</span>

        <span class="n">ssh_address</span><span class="p">,</span> <span class="n">ssh_port</span> <span class="o">=</span> <span class="n">tunnel_server_address</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
        <span class="n">ssh_port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ssh_port</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

        <span class="n">remote_bind_address</span><span class="p">,</span> <span class="n">remote_bind_port</span> <span class="o">=</span> <span class="n">remote_server_address</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
        <span class="n">remote_bind_port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">remote_bind_port</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

        <span class="k">if</span> <span class="n">private_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ssh_password</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">ssh_private_key_password</span> <span class="o">=</span> <span class="n">password</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ssh_password</span> <span class="o">=</span> <span class="n">password</span>
            <span class="n">ssh_private_key_password</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tunnel</span> <span class="o">=</span> <span class="n">SSHTunnelForwarder</span><span class="p">(</span>
            <span class="n">ssh_address_or_host</span><span class="o">=</span><span class="p">(</span><span class="n">ssh_address</span><span class="p">,</span> <span class="n">ssh_port</span><span class="p">),</span>
            <span class="n">local_bind_address</span><span class="o">=</span><span class="n">local_bind_address</span><span class="p">,</span>
            <span class="n">remote_bind_address</span><span class="o">=</span><span class="p">(</span><span class="n">remote_bind_address</span><span class="p">,</span> <span class="n">remote_bind_port</span><span class="p">),</span>
            <span class="n">ssh_username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
            <span class="n">ssh_password</span><span class="o">=</span><span class="n">ssh_password</span><span class="p">,</span>
            <span class="n">ssh_private_key_password</span><span class="o">=</span><span class="n">ssh_private_key_password</span><span class="p">,</span>
            <span class="n">ssh_pkey</span><span class="o">=</span><span class="n">private_key</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>







  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">

<a id="maggma.stores.file_store"></a>
    <div class="doc doc-contents first">

      <p>Module defining a FileStore that enables accessing files in a local directory
using typical maggma access patterns.</p>



  <div class="doc doc-children">








  <div class="doc doc-object doc-class">



<h2 class="doc doc-heading" id="maggma.stores.file_store.FileStore">
        <code>
FileStore            (<a class="autorefs autorefs-internal" title="maggma.stores.mongolike.MemoryStore" href="#maggma.stores.mongolike.MemoryStore">MemoryStore</a>)
        </code>



<a class="headerlink" href="#maggma.stores.file_store.FileStore" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>A Store for files on disk. Provides a common access method consistent with
other stores. Each Item in the Store represents one file. Files can be organized
into any type of directory structure.</p>
<p>A hash of the full path to each file is used to define a file_id that uniquely
identifies each item.</p>
<p>Any metadata added to the items is written to a .json file in the root directory
of the FileStore.</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/file_store.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">FileStore</span><span class="p">(</span><span class="n">MemoryStore</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Store for files on disk. Provides a common access method consistent with</span>
<span class="sd">    other stores. Each Item in the Store represents one file. Files can be organized</span>
<span class="sd">    into any type of directory structure.</span>

<span class="sd">    A hash of the full path to each file is used to define a file_id that uniquely</span>
<span class="sd">    identifies each item.</span>

<span class="sd">    Any metadata added to the items is written to a .json file in the root directory</span>
<span class="sd">    of the FileStore.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">],</span>
        <span class="n">file_filters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_depth</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">read_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">include_orphans</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">json_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;FileStore.json&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes a FileStore</span>
<span class="sd">        Args:</span>
<span class="sd">            path: parent directory containing all files and subdirectories to process</span>
<span class="sd">            file_filters: List of fnmatch patterns defining the files to be tracked by</span>
<span class="sd">                the FileStore. Only files that match one of the patterns  provided will</span>
<span class="sd">                be included in the Store If None (default), all files are included.</span>

<span class="sd">                Examples: [&quot;*.txt&quot;, &quot;test-[abcd].txt&quot;], etc.</span>
<span class="sd">                See https://docs.python.org/3/library/fnmatch.html for full syntax</span>
<span class="sd">            max_depth: The maximum depth to look into subdirectories. 0 = no recursion,</span>
<span class="sd">                1 = include files 1 directory below the FileStore, etc.</span>
<span class="sd">                None (default) will scan all files below</span>
<span class="sd">                the FileStore root directory, regardless of depth.</span>
<span class="sd">            read_only: If True (default), the .update() and .remove_docs()</span>
<span class="sd">                methods are disabled, preventing any changes to the files on</span>
<span class="sd">                disk. In addition, metadata cannot be written to disk.</span>
<span class="sd">            include_orphans: Whether to include orphaned metadata records in query results.</span>
<span class="sd">                Orphaned metadata records are records found in the local JSON file that can</span>
<span class="sd">                no longer be associated to a file on disk. This can happen if a file is renamed</span>
<span class="sd">                or deleted, or if the FileStore is re-initialized with a more restrictive</span>
<span class="sd">                file_filters or max_depth argument. By default (False), these records</span>
<span class="sd">                do not appear in query results. Nevertheless, the metadata records are</span>
<span class="sd">                retained in the JSON file and the FileStore to prevent accidental data loss.</span>
<span class="sd">            json_name: Name of the .json file to which metadata is saved. If read_only</span>
<span class="sd">                is False, this file will be created in the root directory of the</span>
<span class="sd">                FileStore.</span>
<span class="sd">            kwargs: kwargs passed to MemoryStore.__init__()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># this conditional block is needed in order to guarantee that the &#39;name&#39;</span>
        <span class="c1"># property, which is passed to `MemoryStore`, works correctly</span>
        <span class="c1"># collection names passed to MemoryStore cannot end with &#39;.&#39;</span>
        <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="s2">&quot;.&quot;</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">path</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">json_name</span> <span class="o">=</span> <span class="n">json_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_filters</span> <span class="o">=</span> <span class="n">file_filters</span> <span class="k">if</span> <span class="n">file_filters</span> <span class="k">else</span> <span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span> <span class="o">=</span> <span class="s2">&quot;file_store&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;file_id&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">include_orphans</span> <span class="o">=</span> <span class="n">include_orphans</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span> <span class="o">=</span> <span class="n">read_only</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span> <span class="o">=</span> <span class="n">max_depth</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metadata_store</span> <span class="o">=</span> <span class="n">JSONStore</span><span class="p">(</span>
            <span class="n">paths</span><span class="o">=</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_name</span><span class="p">)],</span>
            <span class="n">read_only</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read_only</span><span class="p">,</span>
            <span class="n">collection_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="p">,</span>
            <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">collection_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="p">,</span>
            <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a string representing this data source</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;file://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="nf">add_metadata</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">metadata</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="n">query</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">auto_data</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add metadata to a record in the FileStore, either manually or by computing it automatically</span>
<span class="sd">        from another field, such as name or path (see auto_data).</span>

<span class="sd">        Args:</span>
<span class="sd">            metadata: dict of additional data to add to the records returned by query.</span>
<span class="sd">                      Note that any protected keys (such as &#39;name&#39;, &#39;path&#39;, etc.)</span>
<span class="sd">                      will be ignored.</span>
<span class="sd">            query: Query passed to FileStore.query()</span>
<span class="sd">            auto_data: A function that automatically computes metadata based on a field in</span>
<span class="sd">                    the record itself. The function must take in the item as a dict and</span>
<span class="sd">                    return a dict containing the desired metadata. A typical use case is</span>
<span class="sd">                    to assign metadata based on the name of a file. For example, for</span>
<span class="sd">                    data files named like `2022-04-01_april_fool_experiment.txt`, the</span>
<span class="sd">                    auto_data function could be:</span>

<span class="sd">                    def get_metadata_from_filename(d):</span>
<span class="sd">                        return {&quot;date&quot;: d[&quot;name&quot;].split(&quot;_&quot;)[0],</span>
<span class="sd">                                &quot;test_name&quot;: d[&quot;name&quot;].split(&quot;_&quot;)[1]</span>
<span class="sd">                                }</span>

<span class="sd">                    Note that in the case of conflict between manual and automatically</span>
<span class="sd">                    computed metadata (for example, if metadata={&quot;name&quot;: &quot;another_name&quot;} was</span>
<span class="sd">                    supplied alongside the auto_data function above), the manually-supplied</span>
<span class="sd">                    metadata is used.</span>
<span class="sd">            kwargs: kwargs passed to FileStore.query()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># sanitize the metadata</span>
        <span class="n">filtered_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_data</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
        <span class="n">updated_docs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">auto_data</span><span class="p">:</span>
                <span class="n">extra_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_data</span><span class="p">(</span><span class="n">auto_data</span><span class="p">(</span><span class="n">doc</span><span class="p">))</span>
                <span class="n">doc</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extra_data</span><span class="p">)</span>
            <span class="n">doc</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">filtered_metadata</span><span class="p">)</span>
            <span class="n">updated_docs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">updated_docs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Iterate through all files in the Store folder and populate</span>
<span class="sd">        the Store with dictionaries containing basic information about each file.</span>

<span class="sd">        The keys of the documents added to the Store are</span>

<span class="sd">            name: str = File name</span>
<span class="sd">            path: Path = Absolute path of this file</span>
<span class="sd">            parent: str = Name of the parent directory (if any)</span>
<span class="sd">            file_id: str = Unique identifier for this file, computed from the hash</span>
<span class="sd">                        of its path relative to the base FileStore directory and</span>
<span class="sd">                        the file creation time. The key of this field is &#39;file_id&#39;</span>
<span class="sd">                        by default but can be changed via the &#39;key&#39; kwarg to</span>
<span class="sd">                        FileStore.__init__().</span>
<span class="sd">            size: int = Size of this file in bytes</span>
<span class="sd">            last_updated: datetime = Time this file was last modified</span>
<span class="sd">            hash: str = Hash of the file contents</span>
<span class="sd">            orphan: bool = Whether this record is an orphan</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">file_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># generate a list of files in subdirectories</span>
        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_filters</span><span class="p">:</span>
            <span class="c1"># list every file that matches the pattern</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="n">pattern</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                    <span class="c1"># ignore the .json file created by the Store</span>
                    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_name</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="c1"># filter based on depth</span>
                    <span class="n">depth</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">parts</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">depth</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span><span class="p">:</span>
                        <span class="n">file_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_record_from_file</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">file_list</span>

    <span class="k">def</span> <span class="nf">_create_record_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given the path to a file, return a Dict that constitues a record of</span>
<span class="sd">        basic information about that file. The keys in the returned dict</span>
<span class="sd">        are:</span>

<span class="sd">            name: str = File name</span>
<span class="sd">            path: Path = Absolute path of this file</span>
<span class="sd">            parent: str = Name of the parent directory (if any)</span>
<span class="sd">            file_id: str = Unique identifier for this file, computed from the hash</span>
<span class="sd">                        of its path relative to the base FileStore directory and</span>
<span class="sd">                        the file creation time. The key of this field is &#39;file_id&#39;</span>
<span class="sd">                        by default but can be changed via the &#39;key&#39; kwarg to</span>
<span class="sd">                        FileStore.__init__().</span>
<span class="sd">            size: int = Size of this file in bytes</span>
<span class="sd">            last_updated: datetime = Time this file was last modified</span>
<span class="sd">            hash: str = Hash of the file contents</span>
<span class="sd">            orphan: bool = Whether this record is an orphan</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># make sure f is a Path object</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="c1"># compute the file_id from the relative path</span>
        <span class="n">relative_path</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="n">digest</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">()</span>
        <span class="n">digest</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">relative_path</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
        <span class="n">file_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">digest</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">())</span>

        <span class="c1"># hash the file contents</span>
        <span class="n">digest2</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">()</span>
        <span class="n">block_size</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">*</span> <span class="n">digest2</span><span class="o">.</span><span class="n">block_size</span>
        <span class="n">digest2</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">block_size</span><span class="p">)</span>
            <span class="n">digest2</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
        <span class="n">content_hash</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">digest2</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">())</span>

        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">f</span><span class="p">,</span>
            <span class="s2">&quot;path_relative&quot;</span><span class="p">:</span> <span class="n">relative_path</span><span class="p">,</span>
            <span class="s2">&quot;parent&quot;</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span><span class="p">,</span>
            <span class="s2">&quot;last_updated&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span>
            <span class="s2">&quot;orphan&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;hash&quot;</span><span class="p">:</span> <span class="n">content_hash</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">:</span> <span class="n">file_id</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_reset</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Connect to the source data</span>

<span class="sd">        Read all the files in the directory, create corresponding File</span>
<span class="sd">        items in the internal MemoryStore.</span>

<span class="sd">        If there is a metadata .json file in the directory, read its</span>
<span class="sd">        contents into the MemoryStore</span>

<span class="sd">        Args:</span>
<span class="sd">            force_reset: whether to reset the connection or not</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># read all files and place them in the MemoryStore</span>
        <span class="c1"># use super.update to bypass the read_only guard statement</span>
        <span class="c1"># because we want the file data to be populated in memory</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

        <span class="c1"># now read any metadata from the .json file</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata_store</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_store</span><span class="o">.</span><span class="n">query</span><span class="p">()]</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                JSON file &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">json_name</span><span class="si">}</span><span class="s2">&#39; not found. To create this file automatically, re-initialize</span>
<span class="s2">                the FileStore with read_only=False.</span>
<span class="s2">                &quot;&quot;&quot;</span>
            <span class="p">)</span>

        <span class="c1"># merge metadata with file data and check for orphaned metadata</span>
        <span class="n">requests</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">found_orphans</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span>
        <span class="n">file_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">search_doc</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">key</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">search_doc</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]}</span>

            <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file_ids</span><span class="p">:</span>
                <span class="n">found_orphans</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;orphan&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>

            <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]</span>

            <span class="n">requests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">UpdateOne</span><span class="p">(</span><span class="n">search_doc</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="n">d</span><span class="p">},</span> <span class="n">upsert</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">found_orphans</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Orphaned metadata was found in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">json_name</span><span class="si">}</span><span class="s2">. This metadata&quot;</span>
                <span class="s2">&quot;will be added to the store with {&#39;orphan&#39;: True}&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">requests</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">bulk_write</span><span class="p">(</span><span class="n">requests</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">Dict</span><span class="p">],</span> <span class="n">key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update items in the Store. Only possible if the store is not read only. Any new</span>
<span class="sd">        fields that are added will be written to the JSON file in the root directory</span>
<span class="sd">        of the FileStore.</span>

<span class="sd">        Note that certain fields that come from file metadata on disk are protected and</span>
<span class="sd">        cannot be updated with this method. This prevents the contents of the FileStore</span>
<span class="sd">        from becoming out of sync with the files on which it is based. The protected fields</span>
<span class="sd">        are keys in the dict returned by _create_record_from_file, e.g. &#39;name&#39;, &#39;parent&#39;,</span>
<span class="sd">        &#39;path&#39;, &#39;last_updated&#39;, &#39;hash&#39;, &#39;size&#39;, &#39;contents&#39;, and &#39;orphan&#39;. The &#39;path_relative&#39; and key fields are</span>
<span class="sd">        retained to make each document in the JSON file identifiable by manual inspection.</span>

<span class="sd">        Args:</span>
<span class="sd">            docs: the document or list of documents to update</span>
<span class="sd">            key: field name(s) to determine uniqueness for a</span>
<span class="sd">                 document, can be a list of multiple fields,</span>
<span class="sd">                 a single field, or None if the Store&#39;s key</span>
<span class="sd">                 field is to be used</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StoreError</span><span class="p">(</span>
                <span class="s2">&quot;This Store is read-only. To enable file I/O, re-initialize the store with read_only=False.&quot;</span>
            <span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">docs</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">()]</span>
        <span class="n">filtered_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># remove fields that are populated by .read()</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">filtered_d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_data</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="c1"># don&#39;t write records that contain only file_id</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">filtered_d</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="s2">&quot;path_relative&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">])))</span>
                <span class="o">!=</span> <span class="mi">0</span>
            <span class="p">):</span>
                <span class="n">filtered_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filtered_d</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata_store</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">filtered_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_filter_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove any protected keys from a dictionary</span>

<span class="sd">        Args:</span>
<span class="sd">            d: Dictionary whose keys are to be filtered</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filtered_d</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">PROTECTED_KEYS</span><span class="o">.</span><span class="n">union</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span><span class="p">})</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">filtered_d</span>

    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">properties</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">hint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">skip</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">contents_size_limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Queries the Store for a set of documents</span>

<span class="sd">        Args:</span>
<span class="sd">            criteria: PyMongo filter for documents to search in</span>
<span class="sd">            properties: properties to return in grouped documents</span>
<span class="sd">            sort: Dictionary of sort order for fields. Keys are field names and</span>
<span class="sd">                values are 1 for ascending or -1 for descending.</span>
<span class="sd">            hint: Dictionary of indexes to use as hints for query optimizer.</span>
<span class="sd">                Keys are field names and values are 1 for ascending or -1 for descending.</span>
<span class="sd">            skip: number documents to skip</span>
<span class="sd">            limit: limit on total number of documents returned</span>
<span class="sd">            contents_size_limit: Maximum file size in bytes for which to return contents.</span>
<span class="sd">                The FileStore will attempt to read the file and populate the &#39;contents&#39; key</span>
<span class="sd">                with its content at query time, unless the file size is larger than this value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">return_contents</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">criteria</span> <span class="o">=</span> <span class="n">criteria</span> <span class="k">if</span> <span class="n">criteria</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">criteria</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;orphan&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_orphans</span><span class="p">:</span>
                <span class="n">criteria</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;orphan&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">criteria</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;contents&quot;</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;&#39;contents&#39; is not a queryable field! Ignoring.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">}</span>

        <span class="n">orig_properties</span> <span class="o">=</span> <span class="n">properties</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="n">properties</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">properties</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;contents&quot;</span><span class="p">):</span>
            <span class="n">return_contents</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">properties</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">return_contents</span><span class="p">:</span>
            <span class="c1"># remove contents b/c it isn&#39;t stored in the MemoryStore</span>
            <span class="n">properties</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;contents&quot;</span><span class="p">)</span>
            <span class="c1"># add size and path to query so that file can be read</span>
            <span class="n">properties</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
            <span class="n">properties</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">,</span>
            <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">,</span>
            <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span>
            <span class="n">hint</span><span class="o">=</span><span class="n">hint</span><span class="p">,</span>
            <span class="n">skip</span><span class="o">=</span><span class="n">skip</span><span class="p">,</span>
            <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="c1"># add file contents to the returned documents, if appropriate</span>
            <span class="k">if</span> <span class="n">return_contents</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">contents_size_limit</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">contents_size_limit</span><span class="p">:</span>
                    <span class="c1"># attempt to read the file contents and inject into the document</span>
                    <span class="c1"># TODO - could add more logic for detecting different file types</span>
                    <span class="c1"># and more nuanced exception handling</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">with</span> <span class="n">zopen</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">],</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Unable to read: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>

                <span class="k">elif</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">contents_size_limit</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="s2">&quot;Unable to read: file too large&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="s2">&quot;Unable to read: Unknown error&quot;</span>

                <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;contents&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">})</span>

                <span class="c1"># remove size and path if not explicitly requested</span>
                <span class="k">if</span> <span class="n">orig_properties</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;size&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">orig_properties</span><span class="p">:</span>
                    <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;size&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">orig_properties</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;path&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">orig_properties</span><span class="p">:</span>
                    <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">)</span>

            <span class="k">yield</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">query_one</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">properties</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">contents_size_limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Queries the Store for a single document</span>

<span class="sd">        Args:</span>
<span class="sd">            criteria: PyMongo filter for documents to search</span>
<span class="sd">            properties: properties to return in the document</span>
<span class="sd">            sort: Dictionary of sort order for fields. Keys are field names and</span>
<span class="sd">                values are 1 for ascending or -1 for descending.</span>
<span class="sd">            contents_size_limit: Maximum file size in bytes for which to return contents.</span>
<span class="sd">                The FileStore will attempt to read the file and populate the &#39;contents&#39; key</span>
<span class="sd">                with its content at query time, unless the file size is larger than this value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">,</span>
                <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">,</span>
                <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span>
                <span class="n">contents_size_limit</span><span class="o">=</span><span class="n">contents_size_limit</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove_docs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">confirm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove items matching the query dictionary.</span>

<span class="sd">        Args:</span>
<span class="sd">            criteria: query dictionary to match</span>
<span class="sd">            confirm: Boolean flag to confirm that remove_docs should delete</span>
<span class="sd">                     files on disk. Default: False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StoreError</span><span class="p">(</span>
                <span class="s2">&quot;This Store is read-only. To enable file I/O, re-initialize the &quot;</span>
                <span class="s2">&quot;store with read_only=False.&quot;</span>
            <span class="p">)</span>

        <span class="n">docs</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">criteria</span><span class="p">)]</span>
        <span class="c1"># this ensures that any modifications to criteria made by self.query</span>
        <span class="c1"># (e.g., related to orphans or contents) are propagated through to the superclass</span>
        <span class="n">new_criteria</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;file_id&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;file_id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">]}}</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">confirm</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StoreError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Warning! This command is about to delete </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span><span class="si">}</span><span class="s2"> items from disk! &quot;</span>
                <span class="s2">&quot;If this is what you want, reissue this command with confirm=True.&quot;</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">:</span>
            <span class="n">Path</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">remove_docs</span><span class="p">(</span><span class="n">criteria</span><span class="o">=</span><span class="n">new_criteria</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="maggma.stores.file_store.FileStore.name">
<code class="codehilite language-python"><span class="n">name</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.file_store.FileStore.name" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Return a string representing this data source</p>
    </div>

  </div>






  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.file_store.FileStore.__init__">
<code class="codehilite language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">file_filters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">include_orphans</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">json_name</span><span class="o">=</span><span class="s1">&#39;FileStore.json&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.file_store.FileStore.__init__" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Initializes a FileStore</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>path</code></td>
        <td><code>Union[str, pathlib.Path]</code></td>
        <td><p>parent directory containing all files and subdirectories to process</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>file_filters</code></td>
        <td><code>Optional[List]</code></td>
        <td><p>List of fnmatch patterns defining the files to be tracked by
the FileStore. Only files that match one of the patterns  provided will
be included in the Store If None (default), all files are included.</p>
<p>Examples: ["*.txt", "test-[abcd].txt"], etc.
See https://docs.python.org/3/library/fnmatch.html for full syntax</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>max_depth</code></td>
        <td><code>Optional[int]</code></td>
        <td><p>The maximum depth to look into subdirectories. 0 = no recursion,
1 = include files 1 directory below the FileStore, etc.
None (default) will scan all files below
the FileStore root directory, regardless of depth.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>read_only</code></td>
        <td><code>bool</code></td>
        <td><p>If True (default), the .update() and .remove_docs()
methods are disabled, preventing any changes to the files on
disk. In addition, metadata cannot be written to disk.</p></td>
        <td><code>True</code></td>
      </tr>
      <tr>
        <td><code>include_orphans</code></td>
        <td><code>bool</code></td>
        <td><p>Whether to include orphaned metadata records in query results.
Orphaned metadata records are records found in the local JSON file that can
no longer be associated to a file on disk. This can happen if a file is renamed
or deleted, or if the FileStore is re-initialized with a more restrictive
file_filters or max_depth argument. By default (False), these records
do not appear in query results. Nevertheless, the metadata records are
retained in the JSON file and the FileStore to prevent accidental data loss.</p></td>
        <td><code>False</code></td>
      </tr>
      <tr>
        <td><code>json_name</code></td>
        <td><code>str</code></td>
        <td><p>Name of the .json file to which metadata is saved. If read_only
is False, this file will be created in the root directory of the
FileStore.</p></td>
        <td><code>&#39;FileStore.json&#39;</code></td>
      </tr>
      <tr>
        <td><code>kwargs</code></td>
        <td></td>
        <td><p>kwargs passed to MemoryStore.<strong>init</strong>()</p></td>
        <td><code>{}</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/file_store.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">],</span>
    <span class="n">file_filters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">max_depth</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">read_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">include_orphans</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">json_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;FileStore.json&quot;</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initializes a FileStore</span>
<span class="sd">    Args:</span>
<span class="sd">        path: parent directory containing all files and subdirectories to process</span>
<span class="sd">        file_filters: List of fnmatch patterns defining the files to be tracked by</span>
<span class="sd">            the FileStore. Only files that match one of the patterns  provided will</span>
<span class="sd">            be included in the Store If None (default), all files are included.</span>

<span class="sd">            Examples: [&quot;*.txt&quot;, &quot;test-[abcd].txt&quot;], etc.</span>
<span class="sd">            See https://docs.python.org/3/library/fnmatch.html for full syntax</span>
<span class="sd">        max_depth: The maximum depth to look into subdirectories. 0 = no recursion,</span>
<span class="sd">            1 = include files 1 directory below the FileStore, etc.</span>
<span class="sd">            None (default) will scan all files below</span>
<span class="sd">            the FileStore root directory, regardless of depth.</span>
<span class="sd">        read_only: If True (default), the .update() and .remove_docs()</span>
<span class="sd">            methods are disabled, preventing any changes to the files on</span>
<span class="sd">            disk. In addition, metadata cannot be written to disk.</span>
<span class="sd">        include_orphans: Whether to include orphaned metadata records in query results.</span>
<span class="sd">            Orphaned metadata records are records found in the local JSON file that can</span>
<span class="sd">            no longer be associated to a file on disk. This can happen if a file is renamed</span>
<span class="sd">            or deleted, or if the FileStore is re-initialized with a more restrictive</span>
<span class="sd">            file_filters or max_depth argument. By default (False), these records</span>
<span class="sd">            do not appear in query results. Nevertheless, the metadata records are</span>
<span class="sd">            retained in the JSON file and the FileStore to prevent accidental data loss.</span>
<span class="sd">        json_name: Name of the .json file to which metadata is saved. If read_only</span>
<span class="sd">            is False, this file will be created in the root directory of the</span>
<span class="sd">            FileStore.</span>
<span class="sd">        kwargs: kwargs passed to MemoryStore.__init__()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># this conditional block is needed in order to guarantee that the &#39;name&#39;</span>
    <span class="c1"># property, which is passed to `MemoryStore`, works correctly</span>
    <span class="c1"># collection names passed to MemoryStore cannot end with &#39;.&#39;</span>
    <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="s2">&quot;.&quot;</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">path</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">json_name</span> <span class="o">=</span> <span class="n">json_name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">file_filters</span> <span class="o">=</span> <span class="n">file_filters</span> <span class="k">if</span> <span class="n">file_filters</span> <span class="k">else</span> <span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span> <span class="o">=</span> <span class="s2">&quot;file_store&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;file_id&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">include_orphans</span> <span class="o">=</span> <span class="n">include_orphans</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span> <span class="o">=</span> <span class="n">read_only</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span> <span class="o">=</span> <span class="n">max_depth</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">metadata_store</span> <span class="o">=</span> <span class="n">JSONStore</span><span class="p">(</span>
        <span class="n">paths</span><span class="o">=</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_name</span><span class="p">)],</span>
        <span class="n">read_only</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read_only</span><span class="p">,</span>
        <span class="n">collection_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="p">,</span>
        <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
        <span class="n">collection_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="p">,</span>
        <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
        <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.file_store.FileStore.add_metadata">
<code class="codehilite language-python"><span class="n">add_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{},</span> <span class="n">query</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">auto_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.file_store.FileStore.add_metadata" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Add metadata to a record in the FileStore, either manually or by computing it automatically
from another field, such as name or path (see auto_data).</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>metadata</code></td>
        <td><code>Dict</code></td>
        <td><p>dict of additional data to add to the records returned by query.
      Note that any protected keys (such as 'name', 'path', etc.)
      will be ignored.</p></td>
        <td><code>{}</code></td>
      </tr>
      <tr>
        <td><code>query</code></td>
        <td><code>Optional[Dict]</code></td>
        <td><p>Query passed to FileStore.query()</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>auto_data</code></td>
        <td><code>Callable[[Dict], Dict]</code></td>
        <td><p>A function that automatically computes metadata based on a field in
    the record itself. The function must take in the item as a dict and
    return a dict containing the desired metadata. A typical use case is
    to assign metadata based on the name of a file. For example, for
    data files named like <code>2022-04-01_april_fool_experiment.txt</code>, the
    auto_data function could be:</p>
<div class="codehilite"><pre><span></span><code><span class="nv">def</span><span class="w"> </span><span class="nv">get_metadata_from_filename</span><span class="ss">(</span><span class="nv">d</span><span class="ss">)</span>:
<span class="w">    </span><span class="k">return</span><span class="w"> </span>{<span class="s2">&quot;date&quot;</span>:<span class="w"> </span><span class="nv">d</span>[<span class="s2">&quot;name&quot;</span>].<span class="nv">split</span><span class="ss">(</span><span class="s2">&quot;_&quot;</span><span class="ss">)</span>[<span class="mi">0</span>],
<span class="w">            </span><span class="s2">&quot;test_name&quot;</span>:<span class="w"> </span><span class="nv">d</span>[<span class="s2">&quot;name&quot;</span>].<span class="nv">split</span><span class="ss">(</span><span class="s2">&quot;_&quot;</span><span class="ss">)</span>[<span class="mi">1</span>]
<span class="w">            </span>}

<span class="nv">Note</span><span class="w"> </span><span class="nv">that</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">case</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">conflict</span><span class="w"> </span><span class="nv">between</span><span class="w"> </span><span class="nv">manual</span><span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="nv">automatically</span>
<span class="nv">computed</span><span class="w"> </span><span class="nv">metadata</span><span class="w"> </span><span class="ss">(</span><span class="k">for</span><span class="w"> </span><span class="nv">example</span>,<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nv">metadata</span><span class="o">=</span>{<span class="s2">&quot;name&quot;</span>:<span class="w"> </span><span class="s2">&quot;another_name&quot;</span>}<span class="w"> </span><span class="nv">was</span>
<span class="nv">supplied</span><span class="w"> </span><span class="nv">alongside</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">auto_data</span><span class="w"> </span><span class="nv">function</span><span class="w"> </span><span class="nv">above</span><span class="ss">)</span>,<span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">manually</span><span class="o">-</span><span class="nv">supplied</span>
<span class="nv">metadata</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">used</span>.
</code></pre></div></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>kwargs</code></td>
        <td></td>
        <td><p>kwargs passed to FileStore.query()</p></td>
        <td><code>{}</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/file_store.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">add_metadata</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">metadata</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="n">query</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">auto_data</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add metadata to a record in the FileStore, either manually or by computing it automatically</span>
<span class="sd">    from another field, such as name or path (see auto_data).</span>

<span class="sd">    Args:</span>
<span class="sd">        metadata: dict of additional data to add to the records returned by query.</span>
<span class="sd">                  Note that any protected keys (such as &#39;name&#39;, &#39;path&#39;, etc.)</span>
<span class="sd">                  will be ignored.</span>
<span class="sd">        query: Query passed to FileStore.query()</span>
<span class="sd">        auto_data: A function that automatically computes metadata based on a field in</span>
<span class="sd">                the record itself. The function must take in the item as a dict and</span>
<span class="sd">                return a dict containing the desired metadata. A typical use case is</span>
<span class="sd">                to assign metadata based on the name of a file. For example, for</span>
<span class="sd">                data files named like `2022-04-01_april_fool_experiment.txt`, the</span>
<span class="sd">                auto_data function could be:</span>

<span class="sd">                def get_metadata_from_filename(d):</span>
<span class="sd">                    return {&quot;date&quot;: d[&quot;name&quot;].split(&quot;_&quot;)[0],</span>
<span class="sd">                            &quot;test_name&quot;: d[&quot;name&quot;].split(&quot;_&quot;)[1]</span>
<span class="sd">                            }</span>

<span class="sd">                Note that in the case of conflict between manual and automatically</span>
<span class="sd">                computed metadata (for example, if metadata={&quot;name&quot;: &quot;another_name&quot;} was</span>
<span class="sd">                supplied alongside the auto_data function above), the manually-supplied</span>
<span class="sd">                metadata is used.</span>
<span class="sd">        kwargs: kwargs passed to FileStore.query()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># sanitize the metadata</span>
    <span class="n">filtered_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_data</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
    <span class="n">updated_docs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">auto_data</span><span class="p">:</span>
            <span class="n">extra_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_data</span><span class="p">(</span><span class="n">auto_data</span><span class="p">(</span><span class="n">doc</span><span class="p">))</span>
            <span class="n">doc</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extra_data</span><span class="p">)</span>
        <span class="n">doc</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">filtered_metadata</span><span class="p">)</span>
        <span class="n">updated_docs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">updated_docs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.file_store.FileStore.connect">
<code class="codehilite language-python"><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_reset</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.file_store.FileStore.connect" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Connect to the source data</p>
<p>Read all the files in the directory, create corresponding File
items in the internal MemoryStore.</p>
<p>If there is a metadata .json file in the directory, read its
contents into the MemoryStore</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>force_reset</code></td>
        <td><code>bool</code></td>
        <td><p>whether to reset the connection or not</p></td>
        <td><code>False</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/file_store.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_reset</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Connect to the source data</span>

<span class="sd">    Read all the files in the directory, create corresponding File</span>
<span class="sd">    items in the internal MemoryStore.</span>

<span class="sd">    If there is a metadata .json file in the directory, read its</span>
<span class="sd">    contents into the MemoryStore</span>

<span class="sd">    Args:</span>
<span class="sd">        force_reset: whether to reset the connection or not</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># read all files and place them in the MemoryStore</span>
    <span class="c1"># use super.update to bypass the read_only guard statement</span>
    <span class="c1"># because we want the file data to be populated in memory</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

    <span class="c1"># now read any metadata from the .json file</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata_store</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_store</span><span class="o">.</span><span class="n">query</span><span class="p">()]</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            JSON file &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">json_name</span><span class="si">}</span><span class="s2">&#39; not found. To create this file automatically, re-initialize</span>
<span class="s2">            the FileStore with read_only=False.</span>
<span class="s2">            &quot;&quot;&quot;</span>
        <span class="p">)</span>

    <span class="c1"># merge metadata with file data and check for orphaned metadata</span>
    <span class="n">requests</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">found_orphans</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span>
    <span class="n">file_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">search_doc</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">key</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">search_doc</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]}</span>

        <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file_ids</span><span class="p">:</span>
            <span class="n">found_orphans</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;orphan&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>

        <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]</span>

        <span class="n">requests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">UpdateOne</span><span class="p">(</span><span class="n">search_doc</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="n">d</span><span class="p">},</span> <span class="n">upsert</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">found_orphans</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Orphaned metadata was found in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">json_name</span><span class="si">}</span><span class="s2">. This metadata&quot;</span>
            <span class="s2">&quot;will be added to the store with {&#39;orphan&#39;: True}&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">requests</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">bulk_write</span><span class="p">(</span><span class="n">requests</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.file_store.FileStore.query">
<code class="codehilite language-python"><span class="n">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">contents_size_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.file_store.FileStore.query" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Queries the Store for a set of documents</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>criteria</code></td>
        <td><code>Optional[Dict]</code></td>
        <td><p>PyMongo filter for documents to search in</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>properties</code></td>
        <td><code>Union[Dict, List]</code></td>
        <td><p>properties to return in grouped documents</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>sort</code></td>
        <td><code>Optional[Dict[str, Union[maggma.core.store.Sort, int]]]</code></td>
        <td><p>Dictionary of sort order for fields. Keys are field names and
values are 1 for ascending or -1 for descending.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>hint</code></td>
        <td><code>Optional[Dict[str, Union[maggma.core.store.Sort, int]]]</code></td>
        <td><p>Dictionary of indexes to use as hints for query optimizer.
Keys are field names and values are 1 for ascending or -1 for descending.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>skip</code></td>
        <td><code>int</code></td>
        <td><p>number documents to skip</p></td>
        <td><code>0</code></td>
      </tr>
      <tr>
        <td><code>limit</code></td>
        <td><code>int</code></td>
        <td><p>limit on total number of documents returned</p></td>
        <td><code>0</code></td>
      </tr>
      <tr>
        <td><code>contents_size_limit</code></td>
        <td><code>Optional[int]</code></td>
        <td><p>Maximum file size in bytes for which to return contents.
The FileStore will attempt to read the file and populate the 'contents' key
with its content at query time, unless the file size is larger than this value.</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/file_store.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">query</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">properties</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">sort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">hint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">skip</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">contents_size_limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Queries the Store for a set of documents</span>

<span class="sd">    Args:</span>
<span class="sd">        criteria: PyMongo filter for documents to search in</span>
<span class="sd">        properties: properties to return in grouped documents</span>
<span class="sd">        sort: Dictionary of sort order for fields. Keys are field names and</span>
<span class="sd">            values are 1 for ascending or -1 for descending.</span>
<span class="sd">        hint: Dictionary of indexes to use as hints for query optimizer.</span>
<span class="sd">            Keys are field names and values are 1 for ascending or -1 for descending.</span>
<span class="sd">        skip: number documents to skip</span>
<span class="sd">        limit: limit on total number of documents returned</span>
<span class="sd">        contents_size_limit: Maximum file size in bytes for which to return contents.</span>
<span class="sd">            The FileStore will attempt to read the file and populate the &#39;contents&#39; key</span>
<span class="sd">            with its content at query time, unless the file size is larger than this value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">return_contents</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">criteria</span> <span class="o">=</span> <span class="n">criteria</span> <span class="k">if</span> <span class="n">criteria</span> <span class="k">else</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">criteria</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;orphan&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_orphans</span><span class="p">:</span>
            <span class="n">criteria</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;orphan&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>

    <span class="k">if</span> <span class="n">criteria</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;contents&quot;</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;&#39;contents&#39; is not a queryable field! Ignoring.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">}</span>

    <span class="n">orig_properties</span> <span class="o">=</span> <span class="n">properties</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="n">properties</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">properties</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;contents&quot;</span><span class="p">):</span>
        <span class="n">return_contents</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">properties</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">return_contents</span><span class="p">:</span>
        <span class="c1"># remove contents b/c it isn&#39;t stored in the MemoryStore</span>
        <span class="n">properties</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;contents&quot;</span><span class="p">)</span>
        <span class="c1"># add size and path to query so that file can be read</span>
        <span class="n">properties</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="n">properties</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>

    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
        <span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">,</span>
        <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">,</span>
        <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span>
        <span class="n">hint</span><span class="o">=</span><span class="n">hint</span><span class="p">,</span>
        <span class="n">skip</span><span class="o">=</span><span class="n">skip</span><span class="p">,</span>
        <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># add file contents to the returned documents, if appropriate</span>
        <span class="k">if</span> <span class="n">return_contents</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">contents_size_limit</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">contents_size_limit</span><span class="p">:</span>
                <span class="c1"># attempt to read the file contents and inject into the document</span>
                <span class="c1"># TODO - could add more logic for detecting different file types</span>
                <span class="c1"># and more nuanced exception handling</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">zopen</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">],</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Unable to read: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="k">elif</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">contents_size_limit</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="s2">&quot;Unable to read: file too large&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="s2">&quot;Unable to read: Unknown error&quot;</span>

            <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;contents&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">})</span>

            <span class="c1"># remove size and path if not explicitly requested</span>
            <span class="k">if</span> <span class="n">orig_properties</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;size&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">orig_properties</span><span class="p">:</span>
                <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;size&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">orig_properties</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;path&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">orig_properties</span><span class="p">:</span>
                <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">)</span>

        <span class="k">yield</span> <span class="n">d</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.file_store.FileStore.query_one">
<code class="codehilite language-python"><span class="n">query_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">contents_size_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.file_store.FileStore.query_one" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Queries the Store for a single document</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>criteria</code></td>
        <td><code>Optional[Dict]</code></td>
        <td><p>PyMongo filter for documents to search</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>properties</code></td>
        <td><code>Union[Dict, List]</code></td>
        <td><p>properties to return in the document</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>sort</code></td>
        <td><code>Optional[Dict[str, Union[maggma.core.store.Sort, int]]]</code></td>
        <td><p>Dictionary of sort order for fields. Keys are field names and
values are 1 for ascending or -1 for descending.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>contents_size_limit</code></td>
        <td><code>Optional[int]</code></td>
        <td><p>Maximum file size in bytes for which to return contents.
The FileStore will attempt to read the file and populate the 'contents' key
with its content at query time, unless the file size is larger than this value.</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/file_store.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">query_one</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">properties</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">sort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">contents_size_limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Queries the Store for a single document</span>

<span class="sd">    Args:</span>
<span class="sd">        criteria: PyMongo filter for documents to search</span>
<span class="sd">        properties: properties to return in the document</span>
<span class="sd">        sort: Dictionary of sort order for fields. Keys are field names and</span>
<span class="sd">            values are 1 for ascending or -1 for descending.</span>
<span class="sd">        contents_size_limit: Maximum file size in bytes for which to return contents.</span>
<span class="sd">            The FileStore will attempt to read the file and populate the &#39;contents&#39; key</span>
<span class="sd">            with its content at query time, unless the file size is larger than this value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">next</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">,</span>
            <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">,</span>
            <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span>
            <span class="n">contents_size_limit</span><span class="o">=</span><span class="n">contents_size_limit</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.file_store.FileStore.read">
<code class="codehilite language-python"><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.file_store.FileStore.read" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Iterate through all files in the Store folder and populate
the Store with dictionaries containing basic information about each file.</p>
<p>The keys of the documents added to the Store are</p>
<div class="codehilite"><pre><span></span><code><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">File</span><span class="w"> </span><span class="n">name</span>
<span class="n">path</span><span class="o">:</span><span class="w"> </span><span class="n">Path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Absolute</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="k">this</span><span class="w"> </span><span class="n">file</span>
<span class="n">parent</span><span class="o">:</span><span class="w"> </span><span class="n">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">parent</span><span class="w"> </span><span class="n">directory</span><span class="w"> </span><span class="o">(</span><span class="k">if</span><span class="w"> </span><span class="n">any</span><span class="o">)</span>
<span class="o">!!!</span><span class="w"> </span><span class="n">file_id</span><span class="w"> </span><span class="s2">&quot;str = Unique identifier for this file, computed from the hash&quot;</span>
<span class="w">            </span><span class="n">of</span><span class="w"> </span><span class="n">its</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="n">relative</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="n">FileStore</span><span class="w"> </span><span class="n">directory</span><span class="w"> </span><span class="n">and</span>
<span class="w">            </span><span class="n">the</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">creation</span><span class="w"> </span><span class="n">time</span><span class="o">.</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="k">this</span><span class="w"> </span><span class="n">field</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="s1">&#39;file_id&#39;</span>
<span class="w">            </span><span class="n">by</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">changed</span><span class="w"> </span><span class="n">via</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="s1">&#39;key&#39;</span><span class="w"> </span><span class="n">kwarg</span><span class="w"> </span><span class="n">to</span>
<span class="w">            </span><span class="n">FileStore</span><span class="o">.</span><span class="na">__init__</span><span class="o">().</span>
<span class="n">size</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Size</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="k">this</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">bytes</span>
<span class="n">last_updated</span><span class="o">:</span><span class="w"> </span><span class="n">datetime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Time</span><span class="w"> </span><span class="k">this</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">last</span><span class="w"> </span><span class="n">modified</span>
<span class="n">hash</span><span class="o">:</span><span class="w"> </span><span class="n">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Hash</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">contents</span>
<span class="n">orphan</span><span class="o">:</span><span class="w"> </span><span class="n">bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Whether</span><span class="w"> </span><span class="k">this</span><span class="w"> </span><span class="n">record</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">orphan</span>
</code></pre></div>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/file_store.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Iterate through all files in the Store folder and populate</span>
<span class="sd">    the Store with dictionaries containing basic information about each file.</span>

<span class="sd">    The keys of the documents added to the Store are</span>

<span class="sd">        name: str = File name</span>
<span class="sd">        path: Path = Absolute path of this file</span>
<span class="sd">        parent: str = Name of the parent directory (if any)</span>
<span class="sd">        file_id: str = Unique identifier for this file, computed from the hash</span>
<span class="sd">                    of its path relative to the base FileStore directory and</span>
<span class="sd">                    the file creation time. The key of this field is &#39;file_id&#39;</span>
<span class="sd">                    by default but can be changed via the &#39;key&#39; kwarg to</span>
<span class="sd">                    FileStore.__init__().</span>
<span class="sd">        size: int = Size of this file in bytes</span>
<span class="sd">        last_updated: datetime = Time this file was last modified</span>
<span class="sd">        hash: str = Hash of the file contents</span>
<span class="sd">        orphan: bool = Whether this record is an orphan</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">file_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># generate a list of files in subdirectories</span>
    <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_filters</span><span class="p">:</span>
        <span class="c1"># list every file that matches the pattern</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="n">pattern</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="c1"># ignore the .json file created by the Store</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_name</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1"># filter based on depth</span>
                <span class="n">depth</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">parts</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">depth</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span><span class="p">:</span>
                    <span class="n">file_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_record_from_file</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">file_list</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.file_store.FileStore.remove_docs">
<code class="codehilite language-python"><span class="n">remove_docs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">,</span> <span class="n">confirm</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.file_store.FileStore.remove_docs" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Remove items matching the query dictionary.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>criteria</code></td>
        <td><code>Dict</code></td>
        <td><p>query dictionary to match</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>confirm</code></td>
        <td><code>bool</code></td>
        <td><p>Boolean flag to confirm that remove_docs should delete
     files on disk. Default: False.</p></td>
        <td><code>False</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/file_store.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">remove_docs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">confirm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove items matching the query dictionary.</span>

<span class="sd">    Args:</span>
<span class="sd">        criteria: query dictionary to match</span>
<span class="sd">        confirm: Boolean flag to confirm that remove_docs should delete</span>
<span class="sd">                 files on disk. Default: False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">StoreError</span><span class="p">(</span>
            <span class="s2">&quot;This Store is read-only. To enable file I/O, re-initialize the &quot;</span>
            <span class="s2">&quot;store with read_only=False.&quot;</span>
        <span class="p">)</span>

    <span class="n">docs</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">criteria</span><span class="p">)]</span>
    <span class="c1"># this ensures that any modifications to criteria made by self.query</span>
    <span class="c1"># (e.g., related to orphans or contents) are propagated through to the superclass</span>
    <span class="n">new_criteria</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;file_id&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;file_id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">]}}</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">confirm</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">StoreError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Warning! This command is about to delete </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span><span class="si">}</span><span class="s2"> items from disk! &quot;</span>
            <span class="s2">&quot;If this is what you want, reissue this command with confirm=True.&quot;</span>
        <span class="p">)</span>

    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">:</span>
        <span class="n">Path</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">remove_docs</span><span class="p">(</span><span class="n">criteria</span><span class="o">=</span><span class="n">new_criteria</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.file_store.FileStore.update">
<code class="codehilite language-python"><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.file_store.FileStore.update" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Update items in the Store. Only possible if the store is not read only. Any new
fields that are added will be written to the JSON file in the root directory
of the FileStore.</p>
<p>Note that certain fields that come from file metadata on disk are protected and
cannot be updated with this method. This prevents the contents of the FileStore
from becoming out of sync with the files on which it is based. The protected fields
are keys in the dict returned by _create_record_from_file, e.g. 'name', 'parent',
'path', 'last_updated', 'hash', 'size', 'contents', and 'orphan'. The 'path_relative' and key fields are
retained to make each document in the JSON file identifiable by manual inspection.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>docs</code></td>
        <td><code>Union[List[Dict], Dict]</code></td>
        <td><p>the document or list of documents to update</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>key</code></td>
        <td><code>Union[List, str]</code></td>
        <td><p>field name(s) to determine uniqueness for a
 document, can be a list of multiple fields,
 a single field, or None if the Store's key
 field is to be used</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/file_store.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">Dict</span><span class="p">],</span> <span class="n">key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update items in the Store. Only possible if the store is not read only. Any new</span>
<span class="sd">    fields that are added will be written to the JSON file in the root directory</span>
<span class="sd">    of the FileStore.</span>

<span class="sd">    Note that certain fields that come from file metadata on disk are protected and</span>
<span class="sd">    cannot be updated with this method. This prevents the contents of the FileStore</span>
<span class="sd">    from becoming out of sync with the files on which it is based. The protected fields</span>
<span class="sd">    are keys in the dict returned by _create_record_from_file, e.g. &#39;name&#39;, &#39;parent&#39;,</span>
<span class="sd">    &#39;path&#39;, &#39;last_updated&#39;, &#39;hash&#39;, &#39;size&#39;, &#39;contents&#39;, and &#39;orphan&#39;. The &#39;path_relative&#39; and key fields are</span>
<span class="sd">    retained to make each document in the JSON file identifiable by manual inspection.</span>

<span class="sd">    Args:</span>
<span class="sd">        docs: the document or list of documents to update</span>
<span class="sd">        key: field name(s) to determine uniqueness for a</span>
<span class="sd">             document, can be a list of multiple fields,</span>
<span class="sd">             a single field, or None if the Store&#39;s key</span>
<span class="sd">             field is to be used</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">StoreError</span><span class="p">(</span>
            <span class="s2">&quot;This Store is read-only. To enable file I/O, re-initialize the store with read_only=False.&quot;</span>
        <span class="p">)</span>

    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">docs</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">()]</span>
    <span class="n">filtered_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># remove fields that are populated by .read()</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">filtered_d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_data</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="c1"># don&#39;t write records that contain only file_id</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">filtered_d</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="s2">&quot;path_relative&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">])))</span>
            <span class="o">!=</span> <span class="mi">0</span>
        <span class="p">):</span>
            <span class="n">filtered_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filtered_d</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">metadata_store</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">filtered_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">

<a id="maggma.stores.gridfs"></a>
    <div class="doc doc-contents first">

      <p>Module containing various definitions of Stores.
Stores are a default access pattern to data and provide
various utilities</p>



  <div class="doc doc-children">








  <div class="doc doc-object doc-class">



<h2 class="doc doc-heading" id="maggma.stores.gridfs.GridFSStore">
        <code>
GridFSStore            (<a class="autorefs autorefs-internal" title="maggma.core.store.Store" href="../core_store/#maggma.core.store.Store">Store</a>)
        </code>



<a class="headerlink" href="#maggma.stores.gridfs.GridFSStore" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>A Store for GrdiFS backend. Provides a common access method consistent with other stores</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/gridfs.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">GridFSStore</span><span class="p">(</span><span class="n">Store</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Store for GrdiFS backend. Provides a common access method consistent with other stores</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">database</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span>
        <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">27017</span><span class="p">,</span>
        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">compression</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">ensure_metadata</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">searchable_fields</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">auth_source</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mongoclient_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ssh_tunnel</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SSHTunnel</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes a GrdiFS Store for binary data</span>
<span class="sd">        Args:</span>
<span class="sd">            database: database name</span>
<span class="sd">            collection_name: The name of the collection.</span>
<span class="sd">                This is the string portion before the GridFS extensions</span>
<span class="sd">            host: hostname for the database</span>
<span class="sd">            port: port to connect to</span>
<span class="sd">            username: username to connect as</span>
<span class="sd">            password: password to authenticate as</span>
<span class="sd">            compression: compress the data as it goes into GridFS</span>
<span class="sd">            ensure_metadata: ensure returned documents have the metadata fields</span>
<span class="sd">            searchable_fields: fields to keep in the index store</span>
<span class="sd">            auth_source: The database to authenticate on. Defaults to the database name.</span>
<span class="sd">            ssh_tunnel: An SSHTunnel object to use.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span> <span class="o">=</span> <span class="n">collection_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">password</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compression</span> <span class="o">=</span> <span class="n">compression</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_metadata</span> <span class="o">=</span> <span class="n">ensure_metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">searchable_fields</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">searchable_fields</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">searchable_fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssh_tunnel</span> <span class="o">=</span> <span class="n">ssh_tunnel</span>

        <span class="k">if</span> <span class="n">auth_source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">auth_source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auth_source</span> <span class="o">=</span> <span class="n">auth_source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mongoclient_kwargs</span> <span class="o">=</span> <span class="n">mongoclient_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="s2">&quot;key&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;_id&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_launchpad_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">lp_file</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience method to construct a GridFSStore from a launchpad file</span>

<span class="sd">        Note: A launchpad file is a special formatted yaml file used in fireworks</span>

<span class="sd">        Returns:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">lp_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">lp_creds</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

        <span class="n">db_creds</span> <span class="o">=</span> <span class="n">lp_creds</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">db_creds</span><span class="p">[</span><span class="s2">&quot;database&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">db_creds</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">db_creds</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;database&quot;</span><span class="p">,</span> <span class="s2">&quot;host&quot;</span><span class="p">,</span> <span class="s2">&quot;port&quot;</span><span class="p">,</span> <span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">]:</span>
                <span class="n">db_creds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">db_creds</span><span class="p">[</span><span class="s2">&quot;collection_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collection_name</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">db_creds</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a string representing this data source</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;gridfs://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_reset</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Connect to the source data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssh_tunnel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span>
            <span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ssh_tunnel</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssh_tunnel</span><span class="o">.</span><span class="n">local_address</span>

        <span class="n">conn</span><span class="p">:</span> <span class="n">MongoClient</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">MongoClient</span><span class="p">(</span>
                <span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span>
                <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span>
                <span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
                <span class="n">password</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">,</span>
                <span class="n">authSource</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">auth_source</span><span class="p">,</span>
                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">mongoclient_kwargs</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">else</span> <span class="n">MongoClient</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">mongoclient_kwargs</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="ow">or</span> <span class="n">force_reset</span><span class="p">:</span>
            <span class="n">db</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="o">=</span> <span class="n">gridfs</span><span class="o">.</span><span class="n">GridFS</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_files_collection</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.files&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_files_store</span> <span class="o">=</span> <span class="n">MongoStore</span><span class="o">.</span><span class="n">from_collection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_files_collection</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_files_store</span><span class="o">.</span><span class="n">last_updated_field</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;metadata.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_files_store</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_chunks_collection</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.chunks&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="p">)]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Property referring to underlying pymongo collection&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StoreError</span><span class="p">(</span>
                <span class="s2">&quot;Must connect Mongo-like store before attempting to use it&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">last_updated</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Provides the most recent last_updated date time stamp from</span>
<span class="sd">        the documents in this Store</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files_store</span><span class="o">.</span><span class="n">last_updated</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">transform_criteria</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Allow client to not need to prepend &#39;metadata.&#39; to query fields.</span>
<span class="sd">        Args:</span>
<span class="sd">            criteria: Query criteria</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_criteria</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">criteria</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">files_collection_fields</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span>
                <span class="s2">&quot;metadata.&quot;</span>
            <span class="p">):</span>
                <span class="n">new_criteria</span><span class="p">[</span><span class="s2">&quot;metadata.&quot;</span> <span class="o">+</span> <span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">criteria</span><span class="p">[</span><span class="n">field</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_criteria</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">criteria</span><span class="p">[</span><span class="n">field</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">new_criteria</span>

    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Counts the number of documents matching the query criteria</span>

<span class="sd">        Args:</span>
<span class="sd">            criteria: PyMongo filter for documents to count in</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">criteria</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_criteria</span><span class="p">(</span><span class="n">criteria</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files_store</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">criteria</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">properties</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">skip</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Queries the GridFS Store for a set of documents.</span>
<span class="sd">        Will check to see if data can be returned from</span>
<span class="sd">        files store first.</span>
<span class="sd">        If the data from the gridfs is not a json serialized string</span>
<span class="sd">        a dict will be returned with the data in the &quot;data&quot; key</span>
<span class="sd">        plus the self.key and self.last_updated_field.</span>

<span class="sd">        Args:</span>
<span class="sd">            criteria: PyMongo filter for documents to search in</span>
<span class="sd">            properties: properties to return in grouped documents</span>
<span class="sd">            sort: Dictionary of sort order for fields. Keys are field names and</span>
<span class="sd">                values are 1 for ascending or -1 for descending.</span>
<span class="sd">            skip: number documents to skip</span>
<span class="sd">            limit: limit on total number of documents returned</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">criteria</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_criteria</span><span class="p">(</span><span class="n">criteria</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">criteria</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Criteria must be a dictionary or None&quot;</span><span class="p">)</span>

        <span class="n">prop_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">prop_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">properties</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">prop_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files_store</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="n">skip</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">properties</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prop_keys</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
                <span class="k">yield</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="n">doc</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">properties</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="p">{})</span>

                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span>
                    <span class="nb">filter</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]},</span>
                    <span class="n">skip</span><span class="o">=</span><span class="n">skip</span><span class="p">,</span>
                    <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span>
                    <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span>
                <span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;compression&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;zlib&quot;</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">:</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span><span class="p">:</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span><span class="p">),</span>
                        <span class="p">}</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_metadata</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>

                <span class="k">yield</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">distinct</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">all_exist</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get all distinct values for a field. This function only operates</span>
<span class="sd">        on the metadata in the files collection</span>

<span class="sd">        Args:</span>
<span class="sd">            field: the field(s) to get distinct values for</span>
<span class="sd">            criteria: PyMongo filter for documents to search in</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">criteria</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transform_criteria</span><span class="p">(</span><span class="n">criteria</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">criteria</span>
        <span class="p">)</span>

        <span class="n">field</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;metadata.</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">files_collection_fields</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;metadata.&quot;</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">field</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files_store</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="n">field</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">groupby</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">keys</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">properties</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">skip</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simple grouping function that will group documents</span>
<span class="sd">        by keys. Will only work if the keys are included in the files</span>
<span class="sd">        collection for GridFS</span>

<span class="sd">        Args:</span>
<span class="sd">            keys: fields to group documents</span>
<span class="sd">            criteria: PyMongo filter for documents to search in</span>
<span class="sd">            properties: properties to return in grouped documents</span>
<span class="sd">            sort: Dictionary of sort order for fields. Keys are field names and</span>
<span class="sd">                values are 1 for ascending or -1 for descending.</span>
<span class="sd">            skip: number documents to skip</span>
<span class="sd">            limit: limit on total number of documents returned</span>

<span class="sd">        Returns:</span>
<span class="sd">            generator returning tuples of (dict, list of docs)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">criteria</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transform_criteria</span><span class="p">(</span><span class="n">criteria</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">criteria</span>
        <span class="p">)</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">keys</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">keys</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;metadata.</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">files_collection_fields</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;metadata.&quot;</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">k</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">ids</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files_store</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
            <span class="n">keys</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;metadata.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">get</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;metadata.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">ids</span>
                <span class="k">if</span> <span class="n">has</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;metadata.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="p">]</span>

            <span class="n">group</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;metadata.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">):</span> <span class="n">get</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span> <span class="k">if</span> <span class="n">has</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
            <span class="p">}</span>

            <span class="k">yield</span> <span class="n">group</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">criteria</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="p">:</span> <span class="n">ids</span><span class="p">}}))</span>

    <span class="k">def</span> <span class="nf">ensure_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">unique</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tries to create an index and return true if it succeeded</span>
<span class="sd">        Currently operators on the GridFS files collection</span>
<span class="sd">        Args:</span>
<span class="sd">            key: single key to index</span>
<span class="sd">            unique: Whether or not this index contains only unique keys</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool indicating if the index exists/was created</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Transform key for gridfs first</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">files_collection_fields</span><span class="p">:</span>
            <span class="n">files_col_key</span> <span class="o">=</span> <span class="s2">&quot;metadata.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files_store</span><span class="o">.</span><span class="n">ensure_index</span><span class="p">(</span><span class="n">files_col_key</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="n">unique</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files_store</span><span class="o">.</span><span class="n">ensure_index</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="n">unique</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">docs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">Dict</span><span class="p">],</span>
        <span class="n">key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">additional_metadata</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update documents into the Store</span>

<span class="sd">        Args:</span>
<span class="sd">            docs: the document or list of documents to update</span>
<span class="sd">            key: field name(s) to determine uniqueness for a</span>
<span class="sd">                 document, can be a list of multiple fields,</span>
<span class="sd">                 a single field, or None if the Store&#39;s key</span>
<span class="sd">                 field is to be used</span>
<span class="sd">            additional_metadata: field(s) to include in the gridfs metadata</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">docs</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">docs</span> <span class="o">=</span> <span class="p">[</span><span class="n">docs</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">key</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>

        <span class="n">key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">files_collection_fields</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">additional_metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">additional_metadata</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">additional_metadata</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">additional_metadata</span> <span class="o">=</span> <span class="p">[</span><span class="n">additional_metadata</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">additional_metadata</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">additional_metadata</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">:</span>
            <span class="n">search_doc</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">key</span><span class="p">}</span>

            <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">get</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">additional_metadata</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchable_fields</span>
                <span class="k">if</span> <span class="n">has</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="n">metadata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">search_doc</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">jsanitize</span><span class="p">(</span><span class="n">d</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compression</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;compression&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;zlib&quot;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>
            <span class="n">search_doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_criteria</span><span class="p">(</span><span class="n">search_doc</span><span class="p">)</span>

            <span class="c1"># Cleans up old gridfs entries</span>
            <span class="k">for</span> <span class="n">fdoc</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_files_collection</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">search_doc</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">])</span>
                <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;uploadDate&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">fdoc</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">remove_docs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove docs matching the query dictionary</span>

<span class="sd">        Args:</span>
<span class="sd">            criteria: query dictionary to match</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">criteria</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_criteria</span><span class="p">(</span><span class="n">criteria</span><span class="p">)</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">cursor</span><span class="o">.</span><span class="n">_id</span> <span class="k">for</span> <span class="n">cursor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">criteria</span><span class="p">)]</span>

        <span class="k">for</span> <span class="n">_id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_files_store</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssh_tunnel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ssh_tunnel</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check equality for GridFSStore</span>
<span class="sd">        other: other GridFSStore to compare with</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">GridFSStore</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;database&quot;</span><span class="p">,</span> <span class="s2">&quot;collection_name&quot;</span><span class="p">,</span> <span class="s2">&quot;host&quot;</span><span class="p">,</span> <span class="s2">&quot;port&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="maggma.stores.gridfs.GridFSStore.last_updated">
<code class="codehilite language-python"><span class="n">last_updated</span><span class="p">:</span> <span class="n">datetime</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.gridfs.GridFSStore.last_updated" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Provides the most recent last_updated date time stamp from
the documents in this Store</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="maggma.stores.gridfs.GridFSStore.name">
<code class="codehilite language-python"><span class="n">name</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.gridfs.GridFSStore.name" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Return a string representing this data source</p>
    </div>

  </div>






  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.gridfs.GridFSStore.__eq__">
<code class="codehilite language-python"><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.gridfs.GridFSStore.__eq__" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Check equality for GridFSStore
other: other GridFSStore to compare with</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/gridfs.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check equality for GridFSStore</span>
<span class="sd">    other: other GridFSStore to compare with</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">GridFSStore</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;database&quot;</span><span class="p">,</span> <span class="s2">&quot;collection_name&quot;</span><span class="p">,</span> <span class="s2">&quot;host&quot;</span><span class="p">,</span> <span class="s2">&quot;port&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.gridfs.GridFSStore.__init__">
<code class="codehilite language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">27017</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ensure_metadata</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">searchable_fields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">auth_source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mongoclient_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ssh_tunnel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.gridfs.GridFSStore.__init__" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Initializes a GrdiFS Store for binary data</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>database</code></td>
        <td><code>str</code></td>
        <td><p>database name</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>collection_name</code></td>
        <td><code>str</code></td>
        <td><p>The name of the collection.
This is the string portion before the GridFS extensions</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>host</code></td>
        <td><code>str</code></td>
        <td><p>hostname for the database</p></td>
        <td><code>&#39;localhost&#39;</code></td>
      </tr>
      <tr>
        <td><code>port</code></td>
        <td><code>int</code></td>
        <td><p>port to connect to</p></td>
        <td><code>27017</code></td>
      </tr>
      <tr>
        <td><code>username</code></td>
        <td><code>str</code></td>
        <td><p>username to connect as</p></td>
        <td><code>&#39;&#39;</code></td>
      </tr>
      <tr>
        <td><code>password</code></td>
        <td><code>str</code></td>
        <td><p>password to authenticate as</p></td>
        <td><code>&#39;&#39;</code></td>
      </tr>
      <tr>
        <td><code>compression</code></td>
        <td><code>bool</code></td>
        <td><p>compress the data as it goes into GridFS</p></td>
        <td><code>False</code></td>
      </tr>
      <tr>
        <td><code>ensure_metadata</code></td>
        <td><code>bool</code></td>
        <td><p>ensure returned documents have the metadata fields</p></td>
        <td><code>False</code></td>
      </tr>
      <tr>
        <td><code>searchable_fields</code></td>
        <td><code>List[str]</code></td>
        <td><p>fields to keep in the index store</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>auth_source</code></td>
        <td><code>Optional[str]</code></td>
        <td><p>The database to authenticate on. Defaults to the database name.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>ssh_tunnel</code></td>
        <td><code>Optional[maggma.stores.mongolike.SSHTunnel]</code></td>
        <td><p>An SSHTunnel object to use.</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/gridfs.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">database</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span>
    <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">27017</span><span class="p">,</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">compression</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">ensure_metadata</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">searchable_fields</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">auth_source</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">mongoclient_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ssh_tunnel</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SSHTunnel</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initializes a GrdiFS Store for binary data</span>
<span class="sd">    Args:</span>
<span class="sd">        database: database name</span>
<span class="sd">        collection_name: The name of the collection.</span>
<span class="sd">            This is the string portion before the GridFS extensions</span>
<span class="sd">        host: hostname for the database</span>
<span class="sd">        port: port to connect to</span>
<span class="sd">        username: username to connect as</span>
<span class="sd">        password: password to authenticate as</span>
<span class="sd">        compression: compress the data as it goes into GridFS</span>
<span class="sd">        ensure_metadata: ensure returned documents have the metadata fields</span>
<span class="sd">        searchable_fields: fields to keep in the index store</span>
<span class="sd">        auth_source: The database to authenticate on. Defaults to the database name.</span>
<span class="sd">        ssh_tunnel: An SSHTunnel object to use.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">database</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span> <span class="o">=</span> <span class="n">collection_name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">password</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">compression</span> <span class="o">=</span> <span class="n">compression</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ensure_metadata</span> <span class="o">=</span> <span class="n">ensure_metadata</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">searchable_fields</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">searchable_fields</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">searchable_fields</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ssh_tunnel</span> <span class="o">=</span> <span class="n">ssh_tunnel</span>

    <span class="k">if</span> <span class="n">auth_source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">auth_source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">auth_source</span> <span class="o">=</span> <span class="n">auth_source</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mongoclient_kwargs</span> <span class="o">=</span> <span class="n">mongoclient_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="s2">&quot;key&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;_id&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.gridfs.GridFSStore.close">
<code class="codehilite language-python"><span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.gridfs.GridFSStore.close" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Closes any connections</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/gridfs.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_files_store</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssh_tunnel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssh_tunnel</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.gridfs.GridFSStore.connect">
<code class="codehilite language-python"><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_reset</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.gridfs.GridFSStore.connect" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Connect to the source data</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/gridfs.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_reset</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Connect to the source data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssh_tunnel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span>
        <span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssh_tunnel</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssh_tunnel</span><span class="o">.</span><span class="n">local_address</span>

    <span class="n">conn</span><span class="p">:</span> <span class="n">MongoClient</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">MongoClient</span><span class="p">(</span>
            <span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span>
            <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span>
            <span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
            <span class="n">password</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">,</span>
            <span class="n">authSource</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">auth_source</span><span class="p">,</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">mongoclient_kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span> <span class="n">MongoClient</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">mongoclient_kwargs</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="ow">or</span> <span class="n">force_reset</span><span class="p">:</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="o">=</span> <span class="n">gridfs</span><span class="o">.</span><span class="n">GridFS</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_files_collection</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.files&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_files_store</span> <span class="o">=</span> <span class="n">MongoStore</span><span class="o">.</span><span class="n">from_collection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_files_collection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_files_store</span><span class="o">.</span><span class="n">last_updated_field</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;metadata.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_files_store</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_chunks_collection</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.chunks&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="p">)]</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.gridfs.GridFSStore.count">
<code class="codehilite language-python"><span class="n">count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.gridfs.GridFSStore.count" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Counts the number of documents matching the query criteria</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>criteria</code></td>
        <td><code>Optional[Dict]</code></td>
        <td><p>PyMongo filter for documents to count in</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/gridfs.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Counts the number of documents matching the query criteria</span>

<span class="sd">    Args:</span>
<span class="sd">        criteria: PyMongo filter for documents to count in</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">criteria</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_criteria</span><span class="p">(</span><span class="n">criteria</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files_store</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">criteria</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.gridfs.GridFSStore.distinct">
<code class="codehilite language-python"><span class="n">distinct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">all_exist</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.gridfs.GridFSStore.distinct" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Get all distinct values for a field. This function only operates
on the metadata in the files collection</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>field</code></td>
        <td><code>str</code></td>
        <td><p>the field(s) to get distinct values for</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>criteria</code></td>
        <td><code>Optional[Dict]</code></td>
        <td><p>PyMongo filter for documents to search in</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/gridfs.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">distinct</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">all_exist</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get all distinct values for a field. This function only operates</span>
<span class="sd">    on the metadata in the files collection</span>

<span class="sd">    Args:</span>
<span class="sd">        field: the field(s) to get distinct values for</span>
<span class="sd">        criteria: PyMongo filter for documents to search in</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">criteria</span> <span class="o">=</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform_criteria</span><span class="p">(</span><span class="n">criteria</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="k">else</span> <span class="n">criteria</span>
    <span class="p">)</span>

    <span class="n">field</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;metadata.</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">files_collection_fields</span>
        <span class="ow">and</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;metadata.&quot;</span><span class="p">)</span>
        <span class="k">else</span> <span class="n">field</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files_store</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="n">field</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.gridfs.GridFSStore.ensure_index">
<code class="codehilite language-python"><span class="n">ensure_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.gridfs.GridFSStore.ensure_index" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Tries to create an index and return true if it succeeded
Currently operators on the GridFS files collection</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>key</code></td>
        <td><code>str</code></td>
        <td><p>single key to index</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>unique</code></td>
        <td><code>Optional[bool]</code></td>
        <td><p>Whether or not this index contains only unique keys</p></td>
        <td><code>False</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>bool</code></td>
      <td><p>bool indicating if the index exists/was created</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/gridfs.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">ensure_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">unique</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tries to create an index and return true if it succeeded</span>
<span class="sd">    Currently operators on the GridFS files collection</span>
<span class="sd">    Args:</span>
<span class="sd">        key: single key to index</span>
<span class="sd">        unique: Whether or not this index contains only unique keys</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool indicating if the index exists/was created</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Transform key for gridfs first</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">files_collection_fields</span><span class="p">:</span>
        <span class="n">files_col_key</span> <span class="o">=</span> <span class="s2">&quot;metadata.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files_store</span><span class="o">.</span><span class="n">ensure_index</span><span class="p">(</span><span class="n">files_col_key</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="n">unique</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files_store</span><span class="o">.</span><span class="n">ensure_index</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="n">unique</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.gridfs.GridFSStore.from_launchpad_file">
<code class="codehilite language-python"><span class="n">from_launchpad_file</span><span class="p">(</span><span class="n">lp_file</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-classmethod"><code>classmethod</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.gridfs.GridFSStore.from_launchpad_file" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Convenience method to construct a GridFSStore from a launchpad file</p>
<p>Note: A launchpad file is a special formatted yaml file used in fireworks</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/gridfs.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">from_launchpad_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">lp_file</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convenience method to construct a GridFSStore from a launchpad file</span>

<span class="sd">    Note: A launchpad file is a special formatted yaml file used in fireworks</span>

<span class="sd">    Returns:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">lp_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lp_creds</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

    <span class="n">db_creds</span> <span class="o">=</span> <span class="n">lp_creds</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">db_creds</span><span class="p">[</span><span class="s2">&quot;database&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">db_creds</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">db_creds</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;database&quot;</span><span class="p">,</span> <span class="s2">&quot;host&quot;</span><span class="p">,</span> <span class="s2">&quot;port&quot;</span><span class="p">,</span> <span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">]:</span>
            <span class="n">db_creds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">db_creds</span><span class="p">[</span><span class="s2">&quot;collection_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collection_name</span>

    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">db_creds</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.gridfs.GridFSStore.groupby">
<code class="codehilite language-python"><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.gridfs.GridFSStore.groupby" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Simple grouping function that will group documents
by keys. Will only work if the keys are included in the files
collection for GridFS</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>keys</code></td>
        <td><code>Union[List[str], str]</code></td>
        <td><p>fields to group documents</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>criteria</code></td>
        <td><code>Optional[Dict]</code></td>
        <td><p>PyMongo filter for documents to search in</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>properties</code></td>
        <td><code>Union[Dict, List]</code></td>
        <td><p>properties to return in grouped documents</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>sort</code></td>
        <td><code>Optional[Dict[str, Union[maggma.core.store.Sort, int]]]</code></td>
        <td><p>Dictionary of sort order for fields. Keys are field names and
values are 1 for ascending or -1 for descending.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>skip</code></td>
        <td><code>int</code></td>
        <td><p>number documents to skip</p></td>
        <td><code>0</code></td>
      </tr>
      <tr>
        <td><code>limit</code></td>
        <td><code>int</code></td>
        <td><p>limit on total number of documents returned</p></td>
        <td><code>0</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Iterator[Tuple[Dict, List[Dict]]]</code></td>
      <td><p>generator returning tuples of (dict, list of docs)</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/gridfs.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">groupby</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">keys</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">],</span>
    <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">properties</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">sort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">skip</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple grouping function that will group documents</span>
<span class="sd">    by keys. Will only work if the keys are included in the files</span>
<span class="sd">    collection for GridFS</span>

<span class="sd">    Args:</span>
<span class="sd">        keys: fields to group documents</span>
<span class="sd">        criteria: PyMongo filter for documents to search in</span>
<span class="sd">        properties: properties to return in grouped documents</span>
<span class="sd">        sort: Dictionary of sort order for fields. Keys are field names and</span>
<span class="sd">            values are 1 for ascending or -1 for descending.</span>
<span class="sd">        skip: number documents to skip</span>
<span class="sd">        limit: limit on total number of documents returned</span>

<span class="sd">    Returns:</span>
<span class="sd">        generator returning tuples of (dict, list of docs)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">criteria</span> <span class="o">=</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform_criteria</span><span class="p">(</span><span class="n">criteria</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="k">else</span> <span class="n">criteria</span>
    <span class="p">)</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">keys</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">keys</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">f</span><span class="s2">&quot;metadata.</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">files_collection_fields</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;metadata.&quot;</span><span class="p">)</span>
        <span class="k">else</span> <span class="n">k</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">ids</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files_store</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
        <span class="n">keys</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;metadata.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
    <span class="p">):</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">get</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;metadata.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">ids</span>
            <span class="k">if</span> <span class="n">has</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;metadata.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="n">group</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;metadata.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">):</span> <span class="n">get</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span> <span class="k">if</span> <span class="n">has</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">yield</span> <span class="n">group</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">criteria</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="p">:</span> <span class="n">ids</span><span class="p">}}))</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.gridfs.GridFSStore.query">
<code class="codehilite language-python"><span class="n">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.gridfs.GridFSStore.query" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Queries the GridFS Store for a set of documents.
Will check to see if data can be returned from
files store first.
If the data from the gridfs is not a json serialized string
a dict will be returned with the data in the "data" key
plus the self.key and self.last_updated_field.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>criteria</code></td>
        <td><code>Optional[Dict]</code></td>
        <td><p>PyMongo filter for documents to search in</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>properties</code></td>
        <td><code>Union[Dict, List]</code></td>
        <td><p>properties to return in grouped documents</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>sort</code></td>
        <td><code>Optional[Dict[str, Union[maggma.core.store.Sort, int]]]</code></td>
        <td><p>Dictionary of sort order for fields. Keys are field names and
values are 1 for ascending or -1 for descending.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>skip</code></td>
        <td><code>int</code></td>
        <td><p>number documents to skip</p></td>
        <td><code>0</code></td>
      </tr>
      <tr>
        <td><code>limit</code></td>
        <td><code>int</code></td>
        <td><p>limit on total number of documents returned</p></td>
        <td><code>0</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/gridfs.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">query</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">properties</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">sort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">skip</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Queries the GridFS Store for a set of documents.</span>
<span class="sd">    Will check to see if data can be returned from</span>
<span class="sd">    files store first.</span>
<span class="sd">    If the data from the gridfs is not a json serialized string</span>
<span class="sd">    a dict will be returned with the data in the &quot;data&quot; key</span>
<span class="sd">    plus the self.key and self.last_updated_field.</span>

<span class="sd">    Args:</span>
<span class="sd">        criteria: PyMongo filter for documents to search in</span>
<span class="sd">        properties: properties to return in grouped documents</span>
<span class="sd">        sort: Dictionary of sort order for fields. Keys are field names and</span>
<span class="sd">            values are 1 for ascending or -1 for descending.</span>
<span class="sd">        skip: number documents to skip</span>
<span class="sd">        limit: limit on total number of documents returned</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">criteria</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_criteria</span><span class="p">(</span><span class="n">criteria</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">criteria</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Criteria must be a dictionary or None&quot;</span><span class="p">)</span>

    <span class="n">prop_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">prop_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">properties</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">prop_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files_store</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
        <span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="n">skip</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">properties</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prop_keys</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
            <span class="k">yield</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="n">doc</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">properties</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="p">{})</span>

            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span>
                <span class="nb">filter</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]},</span>
                <span class="n">skip</span><span class="o">=</span><span class="n">skip</span><span class="p">,</span>
                <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span>
                <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;compression&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;zlib&quot;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">:</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span><span class="p">:</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span><span class="p">),</span>
                    <span class="p">}</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_metadata</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>

            <span class="k">yield</span> <span class="n">data</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.gridfs.GridFSStore.remove_docs">
<code class="codehilite language-python"><span class="n">remove_docs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.gridfs.GridFSStore.remove_docs" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Remove docs matching the query dictionary</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>criteria</code></td>
        <td><code>Dict</code></td>
        <td><p>query dictionary to match</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/gridfs.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">remove_docs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove docs matching the query dictionary</span>

<span class="sd">    Args:</span>
<span class="sd">        criteria: query dictionary to match</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">criteria</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_criteria</span><span class="p">(</span><span class="n">criteria</span><span class="p">)</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">cursor</span><span class="o">.</span><span class="n">_id</span> <span class="k">for</span> <span class="n">cursor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">criteria</span><span class="p">)]</span>

    <span class="k">for</span> <span class="n">_id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">_id</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.gridfs.GridFSStore.transform_criteria">
<code class="codehilite language-python"><span class="n">transform_criteria</span><span class="p">(</span><span class="n">criteria</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-classmethod"><code>classmethod</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.gridfs.GridFSStore.transform_criteria" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Allow client to not need to prepend 'metadata.' to query fields.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>criteria</code></td>
        <td><code>Dict</code></td>
        <td><p>Query criteria</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/gridfs.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">transform_criteria</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allow client to not need to prepend &#39;metadata.&#39; to query fields.</span>
<span class="sd">    Args:</span>
<span class="sd">        criteria: Query criteria</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new_criteria</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">criteria</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">files_collection_fields</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span>
            <span class="s2">&quot;metadata.&quot;</span>
        <span class="p">):</span>
            <span class="n">new_criteria</span><span class="p">[</span><span class="s2">&quot;metadata.&quot;</span> <span class="o">+</span> <span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">criteria</span><span class="p">[</span><span class="n">field</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_criteria</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">criteria</span><span class="p">[</span><span class="n">field</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">new_criteria</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.gridfs.GridFSStore.update">
<code class="codehilite language-python"><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">additional_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.gridfs.GridFSStore.update" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Update documents into the Store</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>docs</code></td>
        <td><code>Union[List[Dict], Dict]</code></td>
        <td><p>the document or list of documents to update</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>key</code></td>
        <td><code>Union[List, str]</code></td>
        <td><p>field name(s) to determine uniqueness for a
 document, can be a list of multiple fields,
 a single field, or None if the Store's key
 field is to be used</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>additional_metadata</code></td>
        <td><code>Union[str, List[str]]</code></td>
        <td><p>field(s) to include in the gridfs metadata</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/gridfs.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">update</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">docs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">Dict</span><span class="p">],</span>
    <span class="n">key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">additional_metadata</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update documents into the Store</span>

<span class="sd">    Args:</span>
<span class="sd">        docs: the document or list of documents to update</span>
<span class="sd">        key: field name(s) to determine uniqueness for a</span>
<span class="sd">             document, can be a list of multiple fields,</span>
<span class="sd">             a single field, or None if the Store&#39;s key</span>
<span class="sd">             field is to be used</span>
<span class="sd">        additional_metadata: field(s) to include in the gridfs metadata</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">docs</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">docs</span> <span class="o">=</span> <span class="p">[</span><span class="n">docs</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">key</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>

    <span class="n">key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">files_collection_fields</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">additional_metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">additional_metadata</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">additional_metadata</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">additional_metadata</span> <span class="o">=</span> <span class="p">[</span><span class="n">additional_metadata</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">additional_metadata</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">additional_metadata</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">:</span>
        <span class="n">search_doc</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">key</span><span class="p">}</span>

        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">get</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">additional_metadata</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchable_fields</span>
            <span class="k">if</span> <span class="n">has</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">search_doc</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">jsanitize</span><span class="p">(</span><span class="n">d</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compression</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;compression&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;zlib&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>
        <span class="n">search_doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_criteria</span><span class="p">(</span><span class="n">search_doc</span><span class="p">)</span>

        <span class="c1"># Cleans up old gridfs entries</span>
        <span class="k">for</span> <span class="n">fdoc</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_files_collection</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">search_doc</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;uploadDate&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">fdoc</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">])</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h2 class="doc doc-heading" id="maggma.stores.gridfs.GridFSURIStore">
        <code>
GridFSURIStore            (<a class="autorefs autorefs-internal" title="maggma.stores.gridfs.GridFSStore" href="#maggma.stores.gridfs.GridFSStore">GridFSStore</a>)
        </code>



<a class="headerlink" href="#maggma.stores.gridfs.GridFSURIStore" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>A Store for GridFS backend, with connection via a mongo URI string.</p>
<p>This is expected to be a special mongodb+srv:// URIs that include client parameters
via TXT records</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/gridfs.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">GridFSURIStore</span><span class="p">(</span><span class="n">GridFSStore</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Store for GridFS backend, with connection via a mongo URI string.</span>

<span class="sd">    This is expected to be a special mongodb+srv:// URIs that include client parameters</span>
<span class="sd">    via TXT records</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">database</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">compression</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">ensure_metadata</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">searchable_fields</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mongoclient_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes a GrdiFS Store for binary data</span>
<span class="sd">        Args:</span>
<span class="sd">            uri: MongoDB+SRV URI</span>
<span class="sd">            database: database to connect to</span>
<span class="sd">            collection_name: The collection name</span>
<span class="sd">            compression: compress the data as it goes into GridFS</span>
<span class="sd">            ensure_metadata: ensure returned documents have the metadata fields</span>
<span class="sd">            searchable_fields: fields to keep in the index store</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">uri</span> <span class="o">=</span> <span class="n">uri</span>

        <span class="c1"># parse the dbname from the uri</span>
        <span class="k">if</span> <span class="n">database</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">d_uri</span> <span class="o">=</span> <span class="n">uri_parser</span><span class="o">.</span><span class="n">parse_uri</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">d_uri</span><span class="p">[</span><span class="s2">&quot;database&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                    <span class="s2">&quot;If database name is not supplied, a database must be set in the uri&quot;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">d_uri</span><span class="p">[</span><span class="s2">&quot;database&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">database</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span> <span class="o">=</span> <span class="n">collection_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compression</span> <span class="o">=</span> <span class="n">compression</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_metadata</span> <span class="o">=</span> <span class="n">ensure_metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">searchable_fields</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">searchable_fields</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">searchable_fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mongoclient_kwargs</span> <span class="o">=</span> <span class="n">mongoclient_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="s2">&quot;key&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;_id&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GridFSStore</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># lgtm</span>

    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_reset</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Connect to the source data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="ow">or</span> <span class="n">force_reset</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="n">conn</span><span class="p">:</span> <span class="n">MongoClient</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uri</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">mongoclient_kwargs</span><span class="p">)</span>
            <span class="n">db</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="o">=</span> <span class="n">gridfs</span><span class="o">.</span><span class="n">GridFS</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_files_collection</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.files&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_files_store</span> <span class="o">=</span> <span class="n">MongoStore</span><span class="o">.</span><span class="n">from_collection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_files_collection</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_files_store</span><span class="o">.</span><span class="n">last_updated_field</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;metadata.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_files_store</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_chunks_collection</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.chunks&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="p">)]</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.gridfs.GridFSURIStore.__init__">
<code class="codehilite language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ensure_metadata</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">searchable_fields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mongoclient_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.gridfs.GridFSURIStore.__init__" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Initializes a GrdiFS Store for binary data</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>uri</code></td>
        <td><code>str</code></td>
        <td><p>MongoDB+SRV URI</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>database</code></td>
        <td><code>str</code></td>
        <td><p>database to connect to</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>collection_name</code></td>
        <td><code>str</code></td>
        <td><p>The collection name</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>compression</code></td>
        <td><code>bool</code></td>
        <td><p>compress the data as it goes into GridFS</p></td>
        <td><code>False</code></td>
      </tr>
      <tr>
        <td><code>ensure_metadata</code></td>
        <td><code>bool</code></td>
        <td><p>ensure returned documents have the metadata fields</p></td>
        <td><code>False</code></td>
      </tr>
      <tr>
        <td><code>searchable_fields</code></td>
        <td><code>List[str]</code></td>
        <td><p>fields to keep in the index store</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/gridfs.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">database</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">compression</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">ensure_metadata</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">searchable_fields</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">mongoclient_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initializes a GrdiFS Store for binary data</span>
<span class="sd">    Args:</span>
<span class="sd">        uri: MongoDB+SRV URI</span>
<span class="sd">        database: database to connect to</span>
<span class="sd">        collection_name: The collection name</span>
<span class="sd">        compression: compress the data as it goes into GridFS</span>
<span class="sd">        ensure_metadata: ensure returned documents have the metadata fields</span>
<span class="sd">        searchable_fields: fields to keep in the index store</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">uri</span> <span class="o">=</span> <span class="n">uri</span>

    <span class="c1"># parse the dbname from the uri</span>
    <span class="k">if</span> <span class="n">database</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">d_uri</span> <span class="o">=</span> <span class="n">uri_parser</span><span class="o">.</span><span class="n">parse_uri</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">d_uri</span><span class="p">[</span><span class="s2">&quot;database&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="s2">&quot;If database name is not supplied, a database must be set in the uri&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">d_uri</span><span class="p">[</span><span class="s2">&quot;database&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">database</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span> <span class="o">=</span> <span class="n">collection_name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">compression</span> <span class="o">=</span> <span class="n">compression</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ensure_metadata</span> <span class="o">=</span> <span class="n">ensure_metadata</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">searchable_fields</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">searchable_fields</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">searchable_fields</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mongoclient_kwargs</span> <span class="o">=</span> <span class="n">mongoclient_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="s2">&quot;key&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;_id&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">GridFSStore</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># lgtm</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.gridfs.GridFSURIStore.connect">
<code class="codehilite language-python"><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_reset</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.gridfs.GridFSURIStore.connect" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Connect to the source data</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/gridfs.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_reset</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Connect to the source data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="ow">or</span> <span class="n">force_reset</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">conn</span><span class="p">:</span> <span class="n">MongoClient</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uri</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">mongoclient_kwargs</span><span class="p">)</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="o">=</span> <span class="n">gridfs</span><span class="o">.</span><span class="n">GridFS</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_files_collection</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.files&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_files_store</span> <span class="o">=</span> <span class="n">MongoStore</span><span class="o">.</span><span class="n">from_collection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_files_collection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_files_store</span><span class="o">.</span><span class="n">last_updated_field</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;metadata.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_files_store</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_chunks_collection</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.chunks&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="p">)]</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">

<a id="maggma.stores.aws"></a>
    <div class="doc doc-contents first">

      <p>Advanced Stores for connecting to AWS data</p>



  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h2 class="doc doc-heading" id="maggma.stores.aws.S3Store">
        <code>
S3Store            (<a class="autorefs autorefs-internal" title="maggma.core.store.Store" href="../core_store/#maggma.core.store.Store">Store</a>)
        </code>



<a class="headerlink" href="#maggma.stores.aws.S3Store" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>GridFS like storage using Amazon S3 and a regular store for indexing
Assumes Amazon AWS key and secret key are set in environment or default config file</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/aws.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">S3Store</span><span class="p">(</span><span class="n">Store</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GridFS like storage using Amazon S3 and a regular store for indexing</span>
<span class="sd">    Assumes Amazon AWS key and secret key are set in environment or default config file</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">index</span><span class="p">:</span> <span class="n">Store</span><span class="p">,</span>
        <span class="n">bucket</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">s3_profile</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">compress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">endpoint_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sub_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">s3_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">s3_resource_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;fs_id&quot;</span><span class="p">,</span>
        <span class="n">store_hash</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">unpack_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">searchable_fields</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes an S3 Store</span>

<span class="sd">        Args:</span>
<span class="sd">            index: a store to use to index the S3 Bucket</span>
<span class="sd">            bucket: name of the bucket</span>
<span class="sd">            s3_profile: name of aws profile containing credentials for role.</span>
<span class="sd">                Alternatively you can pass in a dictionary with the full credentials:</span>
<span class="sd">                    aws_access_key_id (string) -- AWS access key ID</span>
<span class="sd">                    aws_secret_access_key (string) -- AWS secret access key</span>
<span class="sd">                    aws_session_token (string) -- AWS temporary session token</span>
<span class="sd">                    region_name (string) -- Default region when creating new connections</span>
<span class="sd">            compress: compress files inserted into the store</span>
<span class="sd">            endpoint_url: endpoint_url to allow interface to minio service</span>
<span class="sd">            sub_dir: (optional)  subdirectory of the s3 bucket to store the data</span>
<span class="sd">            s3_workers: number of concurrent S3 puts to run</span>
<span class="sd">            store_hash: store the sha1 hash right before insertion to the database.</span>
<span class="sd">            unpack_data: whether to decompress and unpack byte data when querying from the bucket.</span>
<span class="sd">            searchable_fields: fields to keep in the index store</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">boto3</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;boto3 and botocore are required for S3Store&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span> <span class="o">=</span> <span class="n">bucket</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s3_profile</span> <span class="o">=</span> <span class="n">s3_profile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compress</span> <span class="o">=</span> <span class="n">compress</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endpoint_url</span> <span class="o">=</span> <span class="n">endpoint_url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sub_dir</span> <span class="o">=</span> <span class="n">sub_dir</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="k">if</span> <span class="n">sub_dir</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s3</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Any</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s3_bucket</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Any</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s3_workers</span> <span class="o">=</span> <span class="n">s3_workers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s3_resource_kwargs</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">s3_resource_kwargs</span> <span class="k">if</span> <span class="n">s3_resource_kwargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unpack_data</span> <span class="o">=</span> <span class="n">unpack_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">searchable_fields</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">searchable_fields</span> <span class="k">if</span> <span class="n">searchable_fields</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store_hash</span> <span class="o">=</span> <span class="n">store_hash</span>

        <span class="c1"># Force the key to be the same as the index</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">index</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span>
        <span class="p">),</span> <span class="s2">&quot;Since we are using the key as a file name in S3, they key must be a string&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="n">index</span><span class="o">.</span><span class="n">key</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;The desired S3Store key &quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&quot; does not match the index key &quot;</span><span class="si">{</span><span class="n">index</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s1">,&quot;&#39;</span>
                <span class="s2">&quot;the index key will be used&quot;</span><span class="p">,</span>
                <span class="ne">UserWarning</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_thread_local</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">local</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">S3Store</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            a string representing this data source</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;s3://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># lgtm[py/conflicting-attributes]</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Connect to the source data</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_session</span><span class="p">()</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span>
            <span class="s2">&quot;s3&quot;</span><span class="p">,</span> <span class="n">endpoint_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">endpoint_url</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">s3_resource_kwargs</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">s3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s3</span> <span class="o">=</span> <span class="n">resource</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">s3</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">head_bucket</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ClientError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Bucket not present on AWS: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">s3_bucket</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">Bucket</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Closes any connections</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s3</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s3_bucket</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            a handle to the pymongo collection object</span>

<span class="sd">        Important:</span>
<span class="sd">            Not guaranteed to exist in the future</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># For now returns the index collection since that is what we would &quot;search&quot; on</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">_collection</span>

    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Counts the number of documents matching the query criteria</span>

<span class="sd">        Args:</span>
<span class="sd">            criteria: PyMongo filter for documents to count in</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">criteria</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">properties</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">skip</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Queries the Store for a set of documents</span>

<span class="sd">        Args:</span>
<span class="sd">            criteria: PyMongo filter for documents to search in</span>
<span class="sd">            properties: properties to return in grouped documents</span>
<span class="sd">            sort: Dictionary of sort order for fields. Keys are field names and</span>
<span class="sd">                values are 1 for ascending or -1 for descending.</span>
<span class="sd">            skip: number documents to skip</span>
<span class="sd">            limit: limit on total number of documents returned</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prop_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">prop_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">properties</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">prop_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="n">skip</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">properties</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prop_keys</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
                <span class="k">yield</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="n">doc</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">properties</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># TODO: THis is ugly and unsafe, do some real checking before pulling data</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">s3_bucket</span><span class="o">.</span><span class="n">Object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub_dir</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]))</span>
                        <span class="o">.</span><span class="n">get</span><span class="p">()[</span><span class="s2">&quot;Body&quot;</span><span class="p">]</span>
                        <span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="c1"># If a client error is thrown, then check that it was a 404 error.</span>
                    <span class="c1"># If it was a 404 error, then the object does not exist.</span>
                    <span class="n">error_code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;Error&quot;</span><span class="p">][</span><span class="s2">&quot;Code&quot;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">error_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="s2">&quot;Could not find S3 object </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">])</span>
                        <span class="p">)</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">e</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unpack_data</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unpack</span><span class="p">(</span>
                        <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">compressed</span><span class="o">=</span><span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;compression&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;zlib&quot;</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">:</span>
                        <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span><span class="p">]</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span><span class="p">]</span>

                <span class="k">yield</span> <span class="n">data</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_unpack</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">compressed</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">compressed</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="c1"># requires msgpack-python to be installed to fix string encoding problem</span>
        <span class="c1"># https://github.com/msgpack/msgpack/issues/121</span>
        <span class="c1"># During recursion</span>
        <span class="c1"># msgpack.unpackb goes as deep as possible during reconstruction</span>
        <span class="c1"># MontyDecoder().process_decode only goes until it finds a from_dict</span>
        <span class="c1"># as such, we cannot just use msgpack.unpackb(data, object_hook=monty_object_hook, raw=False)</span>
        <span class="c1"># Should just return the unpacked object then let the user run process_decoded</span>
        <span class="n">unpacked_data</span> <span class="o">=</span> <span class="n">msgpack</span><span class="o">.</span><span class="n">unpackb</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">unpacked_data</span>

    <span class="k">def</span> <span class="nf">distinct</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">all_exist</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get all distinct values for a field</span>

<span class="sd">        Args:</span>
<span class="sd">            field: the field(s) to get distinct values for</span>
<span class="sd">            criteria: PyMongo filter for documents to search in</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Index is a store so it should have its own distinct function</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">groupby</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">keys</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">properties</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">skip</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simple grouping function that will group documents</span>
<span class="sd">        by keys.</span>

<span class="sd">        Args:</span>
<span class="sd">            keys: fields to group documents</span>
<span class="sd">            criteria: PyMongo filter for documents to search in</span>
<span class="sd">            properties: properties to return in grouped documents</span>
<span class="sd">            sort: Dictionary of sort order for fields. Keys are field names and</span>
<span class="sd">                values are 1 for ascending or -1 for descending.</span>
<span class="sd">            skip: number documents to skip</span>
<span class="sd">            limit: limit on total number of documents returned</span>

<span class="sd">        Returns:</span>
<span class="sd">            generator returning tuples of (dict, list of docs)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
            <span class="n">keys</span><span class="o">=</span><span class="n">keys</span><span class="p">,</span>
            <span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">,</span>
            <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">,</span>
            <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span>
            <span class="n">skip</span><span class="o">=</span><span class="n">skip</span><span class="p">,</span>
            <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">ensure_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">unique</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tries to create an index and return true if it suceeded</span>

<span class="sd">        Args:</span>
<span class="sd">            key: single key to index</span>
<span class="sd">            unique: Whether or not this index contains only unique keys</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool indicating if the index exists/was created</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">ensure_index</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="n">unique</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">docs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">Dict</span><span class="p">],</span>
        <span class="n">key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">additional_metadata</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update documents into the Store</span>

<span class="sd">        Args:</span>
<span class="sd">            docs: the document or list of documents to update</span>
<span class="sd">            key: field name(s) to determine uniqueness for a</span>
<span class="sd">                 document, can be a list of multiple fields,</span>
<span class="sd">                 a single field, or None if the Store&#39;s key</span>
<span class="sd">                 field is to be used</span>
<span class="sd">            additional_metadata: field(s) to include in the s3 store&#39;s metadata</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">docs</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">docs</span> <span class="o">=</span> <span class="p">[</span><span class="n">docs</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">key</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">additional_metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">additional_metadata</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">additional_metadata</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">additional_metadata</span> <span class="o">=</span> <span class="p">[</span><span class="n">additional_metadata</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">additional_metadata</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">additional_metadata</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">s3_workers</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
            <span class="n">fs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">pool</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write_doc_to_s3</span><span class="p">,</span>
                    <span class="n">doc</span><span class="o">=</span><span class="n">itr_doc</span><span class="p">,</span>
                    <span class="n">search_keys</span><span class="o">=</span><span class="n">key</span> <span class="o">+</span> <span class="n">additional_metadata</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchable_fields</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">itr_doc</span> <span class="ow">in</span> <span class="n">docs</span>
            <span class="p">}</span>
            <span class="n">fs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">wait</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>

            <span class="n">search_docs</span> <span class="o">=</span> <span class="p">[</span><span class="n">sdoc</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="k">for</span> <span class="n">sdoc</span> <span class="ow">in</span> <span class="n">fs</span><span class="p">]</span>

        <span class="c1"># Use store&#39;s update to remove key clashes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">search_docs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_session</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_thread_local</span><span class="p">,</span> <span class="s2">&quot;s3_bucket&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s3_profile</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">Session</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">s3_profile</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Session</span><span class="p">(</span><span class="n">profile_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">s3_profile</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_bucket</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If on the main thread return the bucket created above, else create a new bucket on each thread</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;MainThread&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">s3_bucket</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_thread_local</span><span class="p">,</span> <span class="s2">&quot;s3_bucket&quot;</span><span class="p">):</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_session</span><span class="p">()</span>
            <span class="n">resource</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s2">&quot;s3&quot;</span><span class="p">,</span> <span class="n">endpoint_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">endpoint_url</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_thread_local</span><span class="o">.</span><span class="n">s3_bucket</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">Bucket</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thread_local</span><span class="o">.</span><span class="n">s3_bucket</span>

    <span class="k">def</span> <span class="nf">write_doc_to_s3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doc</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">search_keys</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write the data to s3 and return the metadata to be inserted into the index db</span>

<span class="sd">        Args:</span>
<span class="sd">            doc: the document</span>
<span class="sd">            search_keys: list of keys to pull from the docs and be inserted into the</span>
<span class="sd">            index db</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s3_bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_bucket</span><span class="p">()</span>

        <span class="n">search_doc</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">doc</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">search_keys</span><span class="p">}</span>
        <span class="n">search_doc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>  <span class="c1"># Ensure key is in metadata</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub_dir</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">search_doc</span><span class="p">[</span><span class="s2">&quot;sub_dir&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub_dir</span>

        <span class="c1"># Remove MongoDB _id from search</span>
        <span class="k">if</span> <span class="s2">&quot;_id&quot;</span> <span class="ow">in</span> <span class="n">search_doc</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">search_doc</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]</span>

        <span class="c1"># to make hashing more meaningful, make sure last updated field is removed</span>
        <span class="n">lu_info</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">msgpack</span><span class="o">.</span><span class="n">packb</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">monty_default</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compress</span><span class="p">:</span>
            <span class="c1"># Compress with zlib if chosen</span>
            <span class="n">search_doc</span><span class="p">[</span><span class="s2">&quot;compression&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;zlib&quot;</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">:</span>
            <span class="c1"># need this conversion for aws metadata insert</span>
            <span class="n">search_doc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
                <span class="n">to_isoformat_ceil_ms</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span><span class="p">])</span>
            <span class="p">)</span>

        <span class="c1"># keep a record of original keys, in case these are important for the individual researcher</span>
        <span class="c1"># it is not expected that this information will be used except in disaster recovery</span>
        <span class="n">s3_to_mongo_keys</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sanitize_key</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">search_doc</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="n">s3_to_mongo_keys</span><span class="p">[</span><span class="s2">&quot;s3-to-mongo-keys&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;s3-to-mongo-keys&quot;</span>  <span class="c1"># inception</span>
        <span class="c1"># encode dictionary since values have to be strings</span>
        <span class="n">search_doc</span><span class="p">[</span><span class="s2">&quot;s3-to-mongo-keys&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dumps</span><span class="p">(</span><span class="n">s3_to_mongo_keys</span><span class="p">)</span>
        <span class="n">s3_bucket</span><span class="o">.</span><span class="n">put_object</span><span class="p">(</span>
            <span class="n">Key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sub_dir</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]),</span>
            <span class="n">Body</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">Metadata</span><span class="o">=</span><span class="p">{</span><span class="n">s3_to_mongo_keys</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">search_doc</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">lu_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">search_doc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span><span class="p">]</span> <span class="o">=</span> <span class="n">lu_info</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_hash</span><span class="p">:</span>
            <span class="n">hasher</span> <span class="o">=</span> <span class="n">sha1</span><span class="p">()</span>
            <span class="n">hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">obj_hash</span> <span class="o">=</span> <span class="n">hasher</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
            <span class="n">search_doc</span><span class="p">[</span><span class="s2">&quot;obj_hash&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj_hash</span>
        <span class="k">return</span> <span class="n">search_doc</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_sanitize_key</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sanitize keys to store in S3/MinIO metadata.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Any underscores are encoded as double dashes in metadata, since keys with</span>
        <span class="c1"># underscores may be result in the corresponding HTTP header being stripped</span>
        <span class="c1"># by certain server configurations (e.g. default nginx), leading to:</span>
        <span class="c1"># `botocore.exceptions.ClientError: An error occurred (AccessDenied) when</span>
        <span class="c1"># calling the PutObject operation: There were headers present in the request</span>
        <span class="c1"># which were not signed`</span>
        <span class="c1"># Metadata stored in the MongoDB index (self.index) is stored unchanged.</span>

        <span class="c1"># Additionally, MinIO requires lowercase keys</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">remove_docs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">remove_s3_object</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove docs matching the query dictionary</span>

<span class="sd">        Args:</span>
<span class="sd">            criteria: query dictionary to match</span>
<span class="sd">            remove_s3_object: whether to remove the actual S3 Object or not</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">remove_s3_object</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">remove_docs</span><span class="p">(</span><span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">to_remove</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">remove_docs</span><span class="p">(</span><span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">)</span>

            <span class="c1"># Can remove up to 1000 items at a time via boto</span>
            <span class="n">to_remove_chunks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">grouper</span><span class="p">(</span><span class="n">to_remove</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1000</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">chunk_to_remove</span> <span class="ow">in</span> <span class="n">to_remove_chunks</span><span class="p">:</span>
                <span class="n">objlist</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;Key&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sub_dir</span><span class="si">}{</span><span class="n">obj</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">chunk_to_remove</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">s3_bucket</span><span class="o">.</span><span class="n">delete_objects</span><span class="p">(</span><span class="n">Delete</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Objects&quot;</span><span class="p">:</span> <span class="n">objlist</span><span class="p">})</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">last_updated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">last_updated</span>

    <span class="k">def</span> <span class="nf">newer_in</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">Store</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">exhaustive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the keys of documents that are newer in the target</span>
<span class="sd">        Store than this Store.</span>

<span class="sd">        Args:</span>
<span class="sd">            target: target Store</span>
<span class="sd">            criteria: PyMongo filter for documents to search in</span>
<span class="sd">            exhaustive: triggers an item-by-item check vs. checking</span>
<span class="sd">                        the last_updated of the target Store and using</span>
<span class="sd">                        that to filter out new items in</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">newer_in</span><span class="p">(</span>
                <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">,</span> <span class="n">exhaustive</span><span class="o">=</span><span class="n">exhaustive</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">newer_in</span><span class="p">(</span>
                <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">,</span> <span class="n">exhaustive</span><span class="o">=</span><span class="n">exhaustive</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="fm">__hash__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">rebuild_index_from_s3_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rebuilds the index Store from the data in S3</span>
<span class="sd">        Relies on the index document being stores as the metadata for the file</span>
<span class="sd">        This can help recover lost databases</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s3_bucket</span>
        <span class="n">objects</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sub_dir</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">:</span>
            <span class="n">key_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub_dir</span> <span class="o">+</span> <span class="n">obj</span><span class="o">.</span><span class="n">key</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s3_bucket</span><span class="o">.</span><span class="n">Object</span><span class="p">(</span><span class="n">key_</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()[</span><span class="s2">&quot;Body&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compress</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">unpacked_data</span> <span class="o">=</span> <span class="n">msgpack</span><span class="o">.</span><span class="n">unpackb</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">unpacked_data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">rebuild_metadata_from_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_query</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read data from the index store and populate the metadata of the S3 bucket</span>
<span class="sd">        Force all of the keys to be lower case to be Minio compatible</span>
<span class="sd">        Args:</span>
<span class="sd">            index_query: query on the index store</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">qq</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">index_query</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">index_query</span>
        <span class="k">for</span> <span class="n">index_doc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">qq</span><span class="p">):</span>
            <span class="n">key_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub_dir</span> <span class="o">+</span> <span class="n">index_doc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>
            <span class="n">s3_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s3_bucket</span><span class="o">.</span><span class="n">Object</span><span class="p">(</span><span class="n">key_</span><span class="p">)</span>
            <span class="n">new_meta</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_sanitize_key</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">s3_object</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">index_doc</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">new_meta</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="n">new_meta</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_id&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span> <span class="ow">in</span> <span class="n">new_meta</span><span class="p">:</span>
                <span class="n">new_meta</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
                    <span class="n">to_isoformat_ceil_ms</span><span class="p">(</span><span class="n">new_meta</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span><span class="p">])</span>
                <span class="p">)</span>
            <span class="c1"># s3_object.metadata.update(new_meta)</span>
            <span class="n">s3_object</span><span class="o">.</span><span class="n">copy_from</span><span class="p">(</span>
                <span class="n">CopySource</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Bucket&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">s3_bucket</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;Key&quot;</span><span class="p">:</span> <span class="n">key_</span><span class="p">},</span>
                <span class="n">Metadata</span><span class="o">=</span><span class="n">new_meta</span><span class="p">,</span>
                <span class="n">MetadataDirective</span><span class="o">=</span><span class="s2">&quot;REPLACE&quot;</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check equality for S3Store</span>
<span class="sd">        other: other S3Store to compare with</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">S3Store</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="s2">&quot;bucket&quot;</span><span class="p">,</span> <span class="s2">&quot;last_updated_field&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="maggma.stores.aws.S3Store.last_updated">
<code class="codehilite language-python"><span class="n">last_updated</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.aws.S3Store.last_updated" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Provides the most recent last_updated date time stamp from
the documents in this Store</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="maggma.stores.aws.S3Store.name">
<code class="codehilite language-python"><span class="n">name</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.aws.S3Store.name" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>str</code></td>
      <td><p>a string representing this data source</p></td>
    </tr>
  </tbody>
</table>    </div>

  </div>






  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.aws.S3Store.__eq__">
<code class="codehilite language-python"><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.aws.S3Store.__eq__" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Check equality for S3Store
other: other S3Store to compare with</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/aws.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check equality for S3Store</span>
<span class="sd">    other: other S3Store to compare with</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">S3Store</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="s2">&quot;bucket&quot;</span><span class="p">,</span> <span class="s2">&quot;last_updated_field&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>




  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.aws.S3Store.__init__">
<code class="codehilite language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">s3_profile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">endpoint_url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sub_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">s3_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">s3_resource_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;fs_id&#39;</span><span class="p">,</span> <span class="n">store_hash</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">unpack_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">searchable_fields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.aws.S3Store.__init__" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Initializes an S3 Store</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>index</code></td>
        <td><code>Store</code></td>
        <td><p>a store to use to index the S3 Bucket</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>bucket</code></td>
        <td><code>str</code></td>
        <td><p>name of the bucket</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>s3_profile</code></td>
        <td><code>Union[str, dict]</code></td>
        <td><p>name of aws profile containing credentials for role.
Alternatively you can pass in a dictionary with the full credentials:
    aws_access_key_id (string) -- AWS access key ID
    aws_secret_access_key (string) -- AWS secret access key
    aws_session_token (string) -- AWS temporary session token
    region_name (string) -- Default region when creating new connections</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>compress</code></td>
        <td><code>bool</code></td>
        <td><p>compress files inserted into the store</p></td>
        <td><code>False</code></td>
      </tr>
      <tr>
        <td><code>endpoint_url</code></td>
        <td><code>str</code></td>
        <td><p>endpoint_url to allow interface to minio service</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>sub_dir</code></td>
        <td><code>str</code></td>
        <td><p>(optional)  subdirectory of the s3 bucket to store the data</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>s3_workers</code></td>
        <td><code>int</code></td>
        <td><p>number of concurrent S3 puts to run</p></td>
        <td><code>1</code></td>
      </tr>
      <tr>
        <td><code>store_hash</code></td>
        <td><code>bool</code></td>
        <td><p>store the sha1 hash right before insertion to the database.</p></td>
        <td><code>True</code></td>
      </tr>
      <tr>
        <td><code>unpack_data</code></td>
        <td><code>bool</code></td>
        <td><p>whether to decompress and unpack byte data when querying from the bucket.</p></td>
        <td><code>True</code></td>
      </tr>
      <tr>
        <td><code>searchable_fields</code></td>
        <td><code>Optional[List[str]]</code></td>
        <td><p>fields to keep in the index store</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/aws.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">index</span><span class="p">:</span> <span class="n">Store</span><span class="p">,</span>
    <span class="n">bucket</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">s3_profile</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">compress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">endpoint_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">sub_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">s3_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">s3_resource_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;fs_id&quot;</span><span class="p">,</span>
    <span class="n">store_hash</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">unpack_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">searchable_fields</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initializes an S3 Store</span>

<span class="sd">    Args:</span>
<span class="sd">        index: a store to use to index the S3 Bucket</span>
<span class="sd">        bucket: name of the bucket</span>
<span class="sd">        s3_profile: name of aws profile containing credentials for role.</span>
<span class="sd">            Alternatively you can pass in a dictionary with the full credentials:</span>
<span class="sd">                aws_access_key_id (string) -- AWS access key ID</span>
<span class="sd">                aws_secret_access_key (string) -- AWS secret access key</span>
<span class="sd">                aws_session_token (string) -- AWS temporary session token</span>
<span class="sd">                region_name (string) -- Default region when creating new connections</span>
<span class="sd">        compress: compress files inserted into the store</span>
<span class="sd">        endpoint_url: endpoint_url to allow interface to minio service</span>
<span class="sd">        sub_dir: (optional)  subdirectory of the s3 bucket to store the data</span>
<span class="sd">        s3_workers: number of concurrent S3 puts to run</span>
<span class="sd">        store_hash: store the sha1 hash right before insertion to the database.</span>
<span class="sd">        unpack_data: whether to decompress and unpack byte data when querying from the bucket.</span>
<span class="sd">        searchable_fields: fields to keep in the index store</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">boto3</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;boto3 and botocore are required for S3Store&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span> <span class="o">=</span> <span class="n">bucket</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">s3_profile</span> <span class="o">=</span> <span class="n">s3_profile</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">compress</span> <span class="o">=</span> <span class="n">compress</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">endpoint_url</span> <span class="o">=</span> <span class="n">endpoint_url</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sub_dir</span> <span class="o">=</span> <span class="n">sub_dir</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="k">if</span> <span class="n">sub_dir</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">s3</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Any</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">s3_bucket</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Any</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">s3_workers</span> <span class="o">=</span> <span class="n">s3_workers</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">s3_resource_kwargs</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">s3_resource_kwargs</span> <span class="k">if</span> <span class="n">s3_resource_kwargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">unpack_data</span> <span class="o">=</span> <span class="n">unpack_data</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">searchable_fields</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">searchable_fields</span> <span class="k">if</span> <span class="n">searchable_fields</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">store_hash</span> <span class="o">=</span> <span class="n">store_hash</span>

    <span class="c1"># Force the key to be the same as the index</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="n">index</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span>
    <span class="p">),</span> <span class="s2">&quot;Since we are using the key as a file name in S3, they key must be a string&quot;</span>
    <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="n">index</span><span class="o">.</span><span class="n">key</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;The desired S3Store key &quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&quot; does not match the index key &quot;</span><span class="si">{</span><span class="n">index</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s1">,&quot;&#39;</span>
            <span class="s2">&quot;the index key will be used&quot;</span><span class="p">,</span>
            <span class="ne">UserWarning</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_thread_local</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">local</span><span class="p">()</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">S3Store</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.aws.S3Store.close">
<code class="codehilite language-python"><span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.aws.S3Store.close" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Closes any connections</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/aws.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Closes any connections</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">s3</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">s3_bucket</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.aws.S3Store.connect">
<code class="codehilite language-python"><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.aws.S3Store.connect" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Connect to the source data</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/aws.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># lgtm[py/conflicting-attributes]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Connect to the source data</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_session</span><span class="p">()</span>
    <span class="n">resource</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span>
        <span class="s2">&quot;s3&quot;</span><span class="p">,</span> <span class="n">endpoint_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">endpoint_url</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">s3_resource_kwargs</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">s3</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s3</span> <span class="o">=</span> <span class="n">resource</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s3</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">head_bucket</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ClientError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Bucket not present on AWS: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">s3_bucket</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">Bucket</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.aws.S3Store.count">
<code class="codehilite language-python"><span class="n">count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.aws.S3Store.count" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Counts the number of documents matching the query criteria</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>criteria</code></td>
        <td><code>Optional[Dict]</code></td>
        <td><p>PyMongo filter for documents to count in</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/aws.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Counts the number of documents matching the query criteria</span>

<span class="sd">    Args:</span>
<span class="sd">        criteria: PyMongo filter for documents to count in</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">criteria</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.aws.S3Store.distinct">
<code class="codehilite language-python"><span class="n">distinct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">all_exist</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.aws.S3Store.distinct" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Get all distinct values for a field</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>field</code></td>
        <td><code>str</code></td>
        <td><p>the field(s) to get distinct values for</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>criteria</code></td>
        <td><code>Optional[Dict]</code></td>
        <td><p>PyMongo filter for documents to search in</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/aws.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">distinct</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">all_exist</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get all distinct values for a field</span>

<span class="sd">    Args:</span>
<span class="sd">        field: the field(s) to get distinct values for</span>
<span class="sd">        criteria: PyMongo filter for documents to search in</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Index is a store so it should have its own distinct function</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.aws.S3Store.ensure_index">
<code class="codehilite language-python"><span class="n">ensure_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.aws.S3Store.ensure_index" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Tries to create an index and return true if it suceeded</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>key</code></td>
        <td><code>str</code></td>
        <td><p>single key to index</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>unique</code></td>
        <td><code>bool</code></td>
        <td><p>Whether or not this index contains only unique keys</p></td>
        <td><code>False</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>bool</code></td>
      <td><p>bool indicating if the index exists/was created</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/aws.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">ensure_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">unique</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tries to create an index and return true if it suceeded</span>

<span class="sd">    Args:</span>
<span class="sd">        key: single key to index</span>
<span class="sd">        unique: Whether or not this index contains only unique keys</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool indicating if the index exists/was created</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">ensure_index</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="n">unique</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.aws.S3Store.groupby">
<code class="codehilite language-python"><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.aws.S3Store.groupby" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Simple grouping function that will group documents
by keys.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>keys</code></td>
        <td><code>Union[List[str], str]</code></td>
        <td><p>fields to group documents</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>criteria</code></td>
        <td><code>Optional[Dict]</code></td>
        <td><p>PyMongo filter for documents to search in</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>properties</code></td>
        <td><code>Union[Dict, List]</code></td>
        <td><p>properties to return in grouped documents</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>sort</code></td>
        <td><code>Optional[Dict[str, Union[maggma.core.store.Sort, int]]]</code></td>
        <td><p>Dictionary of sort order for fields. Keys are field names and
values are 1 for ascending or -1 for descending.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>skip</code></td>
        <td><code>int</code></td>
        <td><p>number documents to skip</p></td>
        <td><code>0</code></td>
      </tr>
      <tr>
        <td><code>limit</code></td>
        <td><code>int</code></td>
        <td><p>limit on total number of documents returned</p></td>
        <td><code>0</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Iterator[Tuple[Dict, List[Dict]]]</code></td>
      <td><p>generator returning tuples of (dict, list of docs)</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/aws.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">groupby</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">keys</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">],</span>
    <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">properties</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">sort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">skip</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple grouping function that will group documents</span>
<span class="sd">    by keys.</span>

<span class="sd">    Args:</span>
<span class="sd">        keys: fields to group documents</span>
<span class="sd">        criteria: PyMongo filter for documents to search in</span>
<span class="sd">        properties: properties to return in grouped documents</span>
<span class="sd">        sort: Dictionary of sort order for fields. Keys are field names and</span>
<span class="sd">            values are 1 for ascending or -1 for descending.</span>
<span class="sd">        skip: number documents to skip</span>
<span class="sd">        limit: limit on total number of documents returned</span>

<span class="sd">    Returns:</span>
<span class="sd">        generator returning tuples of (dict, list of docs)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
        <span class="n">keys</span><span class="o">=</span><span class="n">keys</span><span class="p">,</span>
        <span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">,</span>
        <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">,</span>
        <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span>
        <span class="n">skip</span><span class="o">=</span><span class="n">skip</span><span class="p">,</span>
        <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.aws.S3Store.newer_in">
<code class="codehilite language-python"><span class="n">newer_in</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exhaustive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.aws.S3Store.newer_in" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Returns the keys of documents that are newer in the target
Store than this Store.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>target</code></td>
        <td><code>Store</code></td>
        <td><p>target Store</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>criteria</code></td>
        <td><code>Optional[Dict]</code></td>
        <td><p>PyMongo filter for documents to search in</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>exhaustive</code></td>
        <td><code>bool</code></td>
        <td><p>triggers an item-by-item check vs. checking
        the last_updated of the target Store and using
        that to filter out new items in</p></td>
        <td><code>False</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/aws.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">newer_in</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">Store</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">exhaustive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the keys of documents that are newer in the target</span>
<span class="sd">    Store than this Store.</span>

<span class="sd">    Args:</span>
<span class="sd">        target: target Store</span>
<span class="sd">        criteria: PyMongo filter for documents to search in</span>
<span class="sd">        exhaustive: triggers an item-by-item check vs. checking</span>
<span class="sd">                    the last_updated of the target Store and using</span>
<span class="sd">                    that to filter out new items in</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">newer_in</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">,</span> <span class="n">exhaustive</span><span class="o">=</span><span class="n">exhaustive</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">newer_in</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">,</span> <span class="n">exhaustive</span><span class="o">=</span><span class="n">exhaustive</span>
        <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.aws.S3Store.query">
<code class="codehilite language-python"><span class="n">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.aws.S3Store.query" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Queries the Store for a set of documents</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>criteria</code></td>
        <td><code>Optional[Dict]</code></td>
        <td><p>PyMongo filter for documents to search in</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>properties</code></td>
        <td><code>Union[Dict, List]</code></td>
        <td><p>properties to return in grouped documents</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>sort</code></td>
        <td><code>Optional[Dict[str, Union[maggma.core.store.Sort, int]]]</code></td>
        <td><p>Dictionary of sort order for fields. Keys are field names and
values are 1 for ascending or -1 for descending.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>skip</code></td>
        <td><code>int</code></td>
        <td><p>number documents to skip</p></td>
        <td><code>0</code></td>
      </tr>
      <tr>
        <td><code>limit</code></td>
        <td><code>int</code></td>
        <td><p>limit on total number of documents returned</p></td>
        <td><code>0</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/aws.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">query</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">properties</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">sort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">skip</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Queries the Store for a set of documents</span>

<span class="sd">    Args:</span>
<span class="sd">        criteria: PyMongo filter for documents to search in</span>
<span class="sd">        properties: properties to return in grouped documents</span>
<span class="sd">        sort: Dictionary of sort order for fields. Keys are field names and</span>
<span class="sd">            values are 1 for ascending or -1 for descending.</span>
<span class="sd">        skip: number documents to skip</span>
<span class="sd">        limit: limit on total number of documents returned</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">prop_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">prop_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">properties</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">prop_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
        <span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="n">skip</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">properties</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prop_keys</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
            <span class="k">yield</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="n">doc</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">properties</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># TODO: THis is ugly and unsafe, do some real checking before pulling data</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">s3_bucket</span><span class="o">.</span><span class="n">Object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub_dir</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]))</span>
                    <span class="o">.</span><span class="n">get</span><span class="p">()[</span><span class="s2">&quot;Body&quot;</span><span class="p">]</span>
                    <span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># If a client error is thrown, then check that it was a 404 error.</span>
                <span class="c1"># If it was a 404 error, then the object does not exist.</span>
                <span class="n">error_code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;Error&quot;</span><span class="p">][</span><span class="s2">&quot;Code&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">error_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s2">&quot;Could not find S3 object </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">])</span>
                    <span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unpack_data</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unpack</span><span class="p">(</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">compressed</span><span class="o">=</span><span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;compression&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;zlib&quot;</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span><span class="p">]</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span><span class="p">]</span>

            <span class="k">yield</span> <span class="n">data</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.aws.S3Store.rebuild_index_from_s3_data">
<code class="codehilite language-python"><span class="n">rebuild_index_from_s3_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.aws.S3Store.rebuild_index_from_s3_data" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Rebuilds the index Store from the data in S3
Relies on the index document being stores as the metadata for the file
This can help recover lost databases</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/aws.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">rebuild_index_from_s3_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rebuilds the index Store from the data in S3</span>
<span class="sd">    Relies on the index document being stores as the metadata for the file</span>
<span class="sd">    This can help recover lost databases</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s3_bucket</span>
    <span class="n">objects</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sub_dir</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">:</span>
        <span class="n">key_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub_dir</span> <span class="o">+</span> <span class="n">obj</span><span class="o">.</span><span class="n">key</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s3_bucket</span><span class="o">.</span><span class="n">Object</span><span class="p">(</span><span class="n">key_</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()[</span><span class="s2">&quot;Body&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compress</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">unpacked_data</span> <span class="o">=</span> <span class="n">msgpack</span><span class="o">.</span><span class="n">unpackb</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">unpacked_data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.aws.S3Store.rebuild_metadata_from_index">
<code class="codehilite language-python"><span class="n">rebuild_metadata_from_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_query</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.aws.S3Store.rebuild_metadata_from_index" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Read data from the index store and populate the metadata of the S3 bucket
Force all of the keys to be lower case to be Minio compatible</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>index_query</code></td>
        <td><code>dict</code></td>
        <td><p>query on the index store</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/aws.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">rebuild_metadata_from_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_query</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read data from the index store and populate the metadata of the S3 bucket</span>
<span class="sd">    Force all of the keys to be lower case to be Minio compatible</span>
<span class="sd">    Args:</span>
<span class="sd">        index_query: query on the index store</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">qq</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">index_query</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">index_query</span>
    <span class="k">for</span> <span class="n">index_doc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">qq</span><span class="p">):</span>
        <span class="n">key_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub_dir</span> <span class="o">+</span> <span class="n">index_doc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>
        <span class="n">s3_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s3_bucket</span><span class="o">.</span><span class="n">Object</span><span class="p">(</span><span class="n">key_</span><span class="p">)</span>
        <span class="n">new_meta</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_sanitize_key</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">s3_object</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">index_doc</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">new_meta</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="n">new_meta</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_id&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span> <span class="ow">in</span> <span class="n">new_meta</span><span class="p">:</span>
            <span class="n">new_meta</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
                <span class="n">to_isoformat_ceil_ms</span><span class="p">(</span><span class="n">new_meta</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="c1"># s3_object.metadata.update(new_meta)</span>
        <span class="n">s3_object</span><span class="o">.</span><span class="n">copy_from</span><span class="p">(</span>
            <span class="n">CopySource</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Bucket&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">s3_bucket</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;Key&quot;</span><span class="p">:</span> <span class="n">key_</span><span class="p">},</span>
            <span class="n">Metadata</span><span class="o">=</span><span class="n">new_meta</span><span class="p">,</span>
            <span class="n">MetadataDirective</span><span class="o">=</span><span class="s2">&quot;REPLACE&quot;</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.aws.S3Store.remove_docs">
<code class="codehilite language-python"><span class="n">remove_docs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">,</span> <span class="n">remove_s3_object</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.aws.S3Store.remove_docs" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Remove docs matching the query dictionary</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>criteria</code></td>
        <td><code>Dict</code></td>
        <td><p>query dictionary to match</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>remove_s3_object</code></td>
        <td><code>bool</code></td>
        <td><p>whether to remove the actual S3 Object or not</p></td>
        <td><code>False</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/aws.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">remove_docs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">remove_s3_object</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove docs matching the query dictionary</span>

<span class="sd">    Args:</span>
<span class="sd">        criteria: query dictionary to match</span>
<span class="sd">        remove_s3_object: whether to remove the actual S3 Object or not</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">remove_s3_object</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">remove_docs</span><span class="p">(</span><span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">to_remove</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">remove_docs</span><span class="p">(</span><span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">)</span>

        <span class="c1"># Can remove up to 1000 items at a time via boto</span>
        <span class="n">to_remove_chunks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">grouper</span><span class="p">(</span><span class="n">to_remove</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1000</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">chunk_to_remove</span> <span class="ow">in</span> <span class="n">to_remove_chunks</span><span class="p">:</span>
            <span class="n">objlist</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;Key&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sub_dir</span><span class="si">}{</span><span class="n">obj</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">chunk_to_remove</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s3_bucket</span><span class="o">.</span><span class="n">delete_objects</span><span class="p">(</span><span class="n">Delete</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Objects&quot;</span><span class="p">:</span> <span class="n">objlist</span><span class="p">})</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.aws.S3Store.update">
<code class="codehilite language-python"><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">additional_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.aws.S3Store.update" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Update documents into the Store</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>docs</code></td>
        <td><code>Union[List[Dict], Dict]</code></td>
        <td><p>the document or list of documents to update</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>key</code></td>
        <td><code>Union[List, str]</code></td>
        <td><p>field name(s) to determine uniqueness for a
 document, can be a list of multiple fields,
 a single field, or None if the Store's key
 field is to be used</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>additional_metadata</code></td>
        <td><code>Union[str, List[str]]</code></td>
        <td><p>field(s) to include in the s3 store's metadata</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/aws.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">update</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">docs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">Dict</span><span class="p">],</span>
    <span class="n">key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">additional_metadata</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update documents into the Store</span>

<span class="sd">    Args:</span>
<span class="sd">        docs: the document or list of documents to update</span>
<span class="sd">        key: field name(s) to determine uniqueness for a</span>
<span class="sd">             document, can be a list of multiple fields,</span>
<span class="sd">             a single field, or None if the Store&#39;s key</span>
<span class="sd">             field is to be used</span>
<span class="sd">        additional_metadata: field(s) to include in the s3 store&#39;s metadata</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">docs</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">docs</span> <span class="o">=</span> <span class="p">[</span><span class="n">docs</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">key</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">additional_metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">additional_metadata</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">additional_metadata</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">additional_metadata</span> <span class="o">=</span> <span class="p">[</span><span class="n">additional_metadata</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">additional_metadata</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">additional_metadata</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">s3_workers</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_doc_to_s3</span><span class="p">,</span>
                <span class="n">doc</span><span class="o">=</span><span class="n">itr_doc</span><span class="p">,</span>
                <span class="n">search_keys</span><span class="o">=</span><span class="n">key</span> <span class="o">+</span> <span class="n">additional_metadata</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchable_fields</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">itr_doc</span> <span class="ow">in</span> <span class="n">docs</span>
        <span class="p">}</span>
        <span class="n">fs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">wait</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>

        <span class="n">search_docs</span> <span class="o">=</span> <span class="p">[</span><span class="n">sdoc</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="k">for</span> <span class="n">sdoc</span> <span class="ow">in</span> <span class="n">fs</span><span class="p">]</span>

    <span class="c1"># Use store&#39;s update to remove key clashes</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">search_docs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.aws.S3Store.write_doc_to_s3">
<code class="codehilite language-python"><span class="n">write_doc_to_s3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doc</span><span class="p">,</span> <span class="n">search_keys</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.aws.S3Store.write_doc_to_s3" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Write the data to s3 and return the metadata to be inserted into the index db</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>doc</code></td>
        <td><code>Dict</code></td>
        <td><p>the document</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>search_keys</code></td>
        <td><code>List[str]</code></td>
        <td><p>list of keys to pull from the docs and be inserted into the</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/aws.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">write_doc_to_s3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doc</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">search_keys</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write the data to s3 and return the metadata to be inserted into the index db</span>

<span class="sd">    Args:</span>
<span class="sd">        doc: the document</span>
<span class="sd">        search_keys: list of keys to pull from the docs and be inserted into the</span>
<span class="sd">        index db</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s3_bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_bucket</span><span class="p">()</span>

    <span class="n">search_doc</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">doc</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">search_keys</span><span class="p">}</span>
    <span class="n">search_doc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>  <span class="c1"># Ensure key is in metadata</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub_dir</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">search_doc</span><span class="p">[</span><span class="s2">&quot;sub_dir&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub_dir</span>

    <span class="c1"># Remove MongoDB _id from search</span>
    <span class="k">if</span> <span class="s2">&quot;_id&quot;</span> <span class="ow">in</span> <span class="n">search_doc</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">search_doc</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]</span>

    <span class="c1"># to make hashing more meaningful, make sure last updated field is removed</span>
    <span class="n">lu_info</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">msgpack</span><span class="o">.</span><span class="n">packb</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">monty_default</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compress</span><span class="p">:</span>
        <span class="c1"># Compress with zlib if chosen</span>
        <span class="n">search_doc</span><span class="p">[</span><span class="s2">&quot;compression&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;zlib&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">:</span>
        <span class="c1"># need this conversion for aws metadata insert</span>
        <span class="n">search_doc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
            <span class="n">to_isoformat_ceil_ms</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span><span class="p">])</span>
        <span class="p">)</span>

    <span class="c1"># keep a record of original keys, in case these are important for the individual researcher</span>
    <span class="c1"># it is not expected that this information will be used except in disaster recovery</span>
    <span class="n">s3_to_mongo_keys</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sanitize_key</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">search_doc</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
    <span class="n">s3_to_mongo_keys</span><span class="p">[</span><span class="s2">&quot;s3-to-mongo-keys&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;s3-to-mongo-keys&quot;</span>  <span class="c1"># inception</span>
    <span class="c1"># encode dictionary since values have to be strings</span>
    <span class="n">search_doc</span><span class="p">[</span><span class="s2">&quot;s3-to-mongo-keys&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dumps</span><span class="p">(</span><span class="n">s3_to_mongo_keys</span><span class="p">)</span>
    <span class="n">s3_bucket</span><span class="o">.</span><span class="n">put_object</span><span class="p">(</span>
        <span class="n">Key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sub_dir</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]),</span>
        <span class="n">Body</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
        <span class="n">Metadata</span><span class="o">=</span><span class="p">{</span><span class="n">s3_to_mongo_keys</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">search_doc</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">lu_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">search_doc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span><span class="p">]</span> <span class="o">=</span> <span class="n">lu_info</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_hash</span><span class="p">:</span>
        <span class="n">hasher</span> <span class="o">=</span> <span class="n">sha1</span><span class="p">()</span>
        <span class="n">hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">obj_hash</span> <span class="o">=</span> <span class="n">hasher</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="n">search_doc</span><span class="p">[</span><span class="s2">&quot;obj_hash&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj_hash</span>
    <span class="k">return</span> <span class="n">search_doc</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">

<a id="maggma.stores.advanced_stores"></a>
    <div class="doc doc-contents first">

      <p>Advanced Stores for behavior outside normal access patterns</p>



  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h2 class="doc doc-heading" id="maggma.stores.advanced_stores.AliasingStore">
        <code>
AliasingStore            (<a class="autorefs autorefs-internal" title="maggma.core.store.Store" href="../core_store/#maggma.core.store.Store">Store</a>)
        </code>



<a class="headerlink" href="#maggma.stores.advanced_stores.AliasingStore" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Special Store that aliases for the primary accessors</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/advanced_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">AliasingStore</span><span class="p">(</span><span class="n">Store</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Special Store that aliases for the primary accessors</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">store</span><span class="p">:</span> <span class="n">Store</span><span class="p">,</span> <span class="n">aliases</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            store: the store to wrap around</span>
<span class="sd">            aliases: dict of aliases of the form external key: internal key</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">store</span>
        <span class="c1"># Given an external key tells what the internal key is</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aliases</span> <span class="o">=</span> <span class="n">aliases</span>
        <span class="c1"># Given the internal key tells us what the external key is</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reverse_aliases</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">aliases</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

        <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;last_updated_field&quot;</span><span class="p">:</span> <span class="n">store</span><span class="o">.</span><span class="n">last_updated_field</span><span class="p">,</span>
                <span class="s2">&quot;last_updated_type&quot;</span><span class="p">:</span> <span class="n">store</span><span class="o">.</span><span class="n">last_updated_type</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AliasingStore</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a string representing this data source</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Counts the number of documents matching the query criteria</span>

<span class="sd">        Args:</span>
<span class="sd">            criteria: PyMongo filter for documents to count in</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">criteria</span> <span class="o">=</span> <span class="n">criteria</span> <span class="k">if</span> <span class="n">criteria</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="n">lazy_substitute</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reverse_aliases</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">criteria</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">properties</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">skip</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Queries the Store for a set of documents</span>

<span class="sd">        Args:</span>
<span class="sd">            criteria: PyMongo filter for documents to search in</span>
<span class="sd">            properties: properties to return in grouped documents</span>
<span class="sd">            sort: Dictionary of sort order for fields. Keys are field names and</span>
<span class="sd">                values are 1 for ascending or -1 for descending.</span>
<span class="sd">            skip: number documents to skip</span>
<span class="sd">            limit: limit on total number of documents returned</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">criteria</span> <span class="o">=</span> <span class="n">criteria</span> <span class="k">if</span> <span class="n">criteria</span> <span class="k">else</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">properties</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">}</span>
            <span class="n">substitute</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reverse_aliases</span><span class="p">)</span>

        <span class="n">lazy_substitute</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reverse_aliases</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="n">skip</span>
        <span class="p">):</span>
            <span class="n">substitute</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aliases</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">distinct</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">all_exist</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get all distinct values for a field</span>

<span class="sd">        Args:</span>
<span class="sd">            field: the field(s) to get distinct values for</span>
<span class="sd">            criteria: PyMongo filter for documents to search in</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">criteria</span> <span class="o">=</span> <span class="n">criteria</span> <span class="k">if</span> <span class="n">criteria</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="n">lazy_substitute</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reverse_aliases</span><span class="p">)</span>

        <span class="c1"># substitute forward</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aliases</span><span class="p">[</span><span class="n">field</span><span class="p">],</span> <span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">groupby</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">keys</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">properties</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">skip</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simple grouping function that will group documents</span>
<span class="sd">        by keys.</span>

<span class="sd">        Args:</span>
<span class="sd">            keys: fields to group documents</span>
<span class="sd">            criteria: PyMongo filter for documents to search in</span>
<span class="sd">            properties: properties to return in grouped documents</span>
<span class="sd">            sort: Dictionary of sort order for fields. Keys are field names and</span>
<span class="sd">                values are 1 for ascending or -1 for descending.</span>
<span class="sd">            skip: number documents to skip</span>
<span class="sd">            limit: limit on total number of documents returned</span>

<span class="sd">        Returns:</span>
<span class="sd">            generator returning tuples of (dict, list of docs)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Convert to a list</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">keys</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">keys</span><span class="p">]</span>

        <span class="c1"># Make the aliasing transformations on keys</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">aliases</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aliases</span> <span class="k">else</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span>

        <span class="c1"># Update criteria and properties based on aliases</span>
        <span class="n">criteria</span> <span class="o">=</span> <span class="n">criteria</span> <span class="k">if</span> <span class="n">criteria</span> <span class="k">else</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">properties</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">}</span>
            <span class="n">substitute</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reverse_aliases</span><span class="p">)</span>

        <span class="n">lazy_substitute</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reverse_aliases</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
            <span class="n">keys</span><span class="o">=</span><span class="n">keys</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="n">skip</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">Dict</span><span class="p">],</span> <span class="n">key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update documents into the Store</span>

<span class="sd">        Args:</span>
<span class="sd">            docs: the document or list of documents to update</span>
<span class="sd">            key: field name(s) to determine uniqueness for a</span>
<span class="sd">                 document, can be a list of multiple fields,</span>
<span class="sd">                 a single field, or None if the Store&#39;s key</span>
<span class="sd">                 field is to be used</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span> <span class="k">if</span> <span class="n">key</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">:</span>
            <span class="n">substitute</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reverse_aliases</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aliases</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aliases</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">docs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove_docs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove docs matching the query dictionary</span>

<span class="sd">        Args:</span>
<span class="sd">            criteria: query dictionary to match</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Update criteria and properties based on aliases</span>
        <span class="n">lazy_substitute</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reverse_aliases</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">remove_docs</span><span class="p">(</span><span class="n">criteria</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ensure_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aliases</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aliases</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">ensure_index</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">unique</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">_collection</span>

    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_reset</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">force_reset</span><span class="o">=</span><span class="n">force_reset</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check equality for AliasingStore</span>

<span class="sd">        Args:</span>
<span class="sd">            other: other AliasingStore to compare with</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">AliasingStore</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="s2">&quot;aliases&quot;</span><span class="p">,</span> <span class="s2">&quot;last_updated_field&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="maggma.stores.advanced_stores.AliasingStore.name">
<code class="codehilite language-python"><span class="n">name</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.advanced_stores.AliasingStore.name" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Return a string representing this data source</p>
    </div>

  </div>






  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.advanced_stores.AliasingStore.__eq__">
<code class="codehilite language-python"><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.advanced_stores.AliasingStore.__eq__" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Check equality for AliasingStore</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>other</code></td>
        <td><code>object</code></td>
        <td><p>other AliasingStore to compare with</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/advanced_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check equality for AliasingStore</span>

<span class="sd">    Args:</span>
<span class="sd">        other: other AliasingStore to compare with</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">AliasingStore</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="s2">&quot;aliases&quot;</span><span class="p">,</span> <span class="s2">&quot;last_updated_field&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.advanced_stores.AliasingStore.__init__">
<code class="codehilite language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">store</span><span class="p">,</span> <span class="n">aliases</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.advanced_stores.AliasingStore.__init__" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>store</code></td>
        <td><code>Store</code></td>
        <td><p>the store to wrap around</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>aliases</code></td>
        <td><code>Dict</code></td>
        <td><p>dict of aliases of the form external key: internal key</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/advanced_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">store</span><span class="p">:</span> <span class="n">Store</span><span class="p">,</span> <span class="n">aliases</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        store: the store to wrap around</span>
<span class="sd">        aliases: dict of aliases of the form external key: internal key</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">store</span>
    <span class="c1"># Given an external key tells what the internal key is</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">aliases</span> <span class="o">=</span> <span class="n">aliases</span>
    <span class="c1"># Given the internal key tells us what the external key is</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">reverse_aliases</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">aliases</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

    <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;last_updated_field&quot;</span><span class="p">:</span> <span class="n">store</span><span class="o">.</span><span class="n">last_updated_field</span><span class="p">,</span>
            <span class="s2">&quot;last_updated_type&quot;</span><span class="p">:</span> <span class="n">store</span><span class="o">.</span><span class="n">last_updated_type</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">AliasingStore</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.advanced_stores.AliasingStore.close">
<code class="codehilite language-python"><span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.advanced_stores.AliasingStore.close" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Closes any connections</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/advanced_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.advanced_stores.AliasingStore.connect">
<code class="codehilite language-python"><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_reset</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.advanced_stores.AliasingStore.connect" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Connect to the source data</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>force_reset</code></td>
        <td></td>
        <td><p>whether to reset the connection or not</p></td>
        <td><code>False</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/advanced_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_reset</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">force_reset</span><span class="o">=</span><span class="n">force_reset</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.advanced_stores.AliasingStore.count">
<code class="codehilite language-python"><span class="n">count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.advanced_stores.AliasingStore.count" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Counts the number of documents matching the query criteria</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>criteria</code></td>
        <td><code>Optional[Dict]</code></td>
        <td><p>PyMongo filter for documents to count in</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/advanced_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Counts the number of documents matching the query criteria</span>

<span class="sd">    Args:</span>
<span class="sd">        criteria: PyMongo filter for documents to count in</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">criteria</span> <span class="o">=</span> <span class="n">criteria</span> <span class="k">if</span> <span class="n">criteria</span> <span class="k">else</span> <span class="p">{}</span>
    <span class="n">lazy_substitute</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reverse_aliases</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">criteria</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.advanced_stores.AliasingStore.distinct">
<code class="codehilite language-python"><span class="n">distinct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">all_exist</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.advanced_stores.AliasingStore.distinct" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Get all distinct values for a field</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>field</code></td>
        <td><code>str</code></td>
        <td><p>the field(s) to get distinct values for</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>criteria</code></td>
        <td><code>Optional[Dict]</code></td>
        <td><p>PyMongo filter for documents to search in</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/advanced_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">distinct</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">all_exist</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get all distinct values for a field</span>

<span class="sd">    Args:</span>
<span class="sd">        field: the field(s) to get distinct values for</span>
<span class="sd">        criteria: PyMongo filter for documents to search in</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">criteria</span> <span class="o">=</span> <span class="n">criteria</span> <span class="k">if</span> <span class="n">criteria</span> <span class="k">else</span> <span class="p">{}</span>
    <span class="n">lazy_substitute</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reverse_aliases</span><span class="p">)</span>

    <span class="c1"># substitute forward</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aliases</span><span class="p">[</span><span class="n">field</span><span class="p">],</span> <span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.advanced_stores.AliasingStore.ensure_index">
<code class="codehilite language-python"><span class="n">ensure_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.advanced_stores.AliasingStore.ensure_index" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Tries to create an index and return true if it suceeded</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>key</code></td>
        <td></td>
        <td><p>single key to index</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>unique</code></td>
        <td></td>
        <td><p>Whether or not this index contains only unique keys</p></td>
        <td><code>False</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td></td>
      <td><p>bool indicating if the index exists/was created</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/advanced_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">ensure_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aliases</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aliases</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">ensure_index</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">unique</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.advanced_stores.AliasingStore.groupby">
<code class="codehilite language-python"><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.advanced_stores.AliasingStore.groupby" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Simple grouping function that will group documents
by keys.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>keys</code></td>
        <td><code>Union[List[str], str]</code></td>
        <td><p>fields to group documents</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>criteria</code></td>
        <td><code>Optional[Dict]</code></td>
        <td><p>PyMongo filter for documents to search in</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>properties</code></td>
        <td><code>Union[Dict, List]</code></td>
        <td><p>properties to return in grouped documents</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>sort</code></td>
        <td><code>Optional[Dict[str, Union[maggma.core.store.Sort, int]]]</code></td>
        <td><p>Dictionary of sort order for fields. Keys are field names and
values are 1 for ascending or -1 for descending.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>skip</code></td>
        <td><code>int</code></td>
        <td><p>number documents to skip</p></td>
        <td><code>0</code></td>
      </tr>
      <tr>
        <td><code>limit</code></td>
        <td><code>int</code></td>
        <td><p>limit on total number of documents returned</p></td>
        <td><code>0</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Iterator[Tuple[Dict, List[Dict]]]</code></td>
      <td><p>generator returning tuples of (dict, list of docs)</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/advanced_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">groupby</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">keys</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">],</span>
    <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">properties</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">sort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">skip</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple grouping function that will group documents</span>
<span class="sd">    by keys.</span>

<span class="sd">    Args:</span>
<span class="sd">        keys: fields to group documents</span>
<span class="sd">        criteria: PyMongo filter for documents to search in</span>
<span class="sd">        properties: properties to return in grouped documents</span>
<span class="sd">        sort: Dictionary of sort order for fields. Keys are field names and</span>
<span class="sd">            values are 1 for ascending or -1 for descending.</span>
<span class="sd">        skip: number documents to skip</span>
<span class="sd">        limit: limit on total number of documents returned</span>

<span class="sd">    Returns:</span>
<span class="sd">        generator returning tuples of (dict, list of docs)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert to a list</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="n">keys</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">keys</span><span class="p">]</span>

    <span class="c1"># Make the aliasing transformations on keys</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">aliases</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aliases</span> <span class="k">else</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span>

    <span class="c1"># Update criteria and properties based on aliases</span>
    <span class="n">criteria</span> <span class="o">=</span> <span class="n">criteria</span> <span class="k">if</span> <span class="n">criteria</span> <span class="k">else</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">properties</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">}</span>
        <span class="n">substitute</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reverse_aliases</span><span class="p">)</span>

    <span class="n">lazy_substitute</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reverse_aliases</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
        <span class="n">keys</span><span class="o">=</span><span class="n">keys</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="n">skip</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.advanced_stores.AliasingStore.query">
<code class="codehilite language-python"><span class="n">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.advanced_stores.AliasingStore.query" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Queries the Store for a set of documents</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>criteria</code></td>
        <td><code>Optional[Dict]</code></td>
        <td><p>PyMongo filter for documents to search in</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>properties</code></td>
        <td><code>Union[Dict, List]</code></td>
        <td><p>properties to return in grouped documents</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>sort</code></td>
        <td><code>Optional[Dict[str, Union[maggma.core.store.Sort, int]]]</code></td>
        <td><p>Dictionary of sort order for fields. Keys are field names and
values are 1 for ascending or -1 for descending.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>skip</code></td>
        <td><code>int</code></td>
        <td><p>number documents to skip</p></td>
        <td><code>0</code></td>
      </tr>
      <tr>
        <td><code>limit</code></td>
        <td><code>int</code></td>
        <td><p>limit on total number of documents returned</p></td>
        <td><code>0</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/advanced_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">query</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">properties</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">sort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">skip</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Queries the Store for a set of documents</span>

<span class="sd">    Args:</span>
<span class="sd">        criteria: PyMongo filter for documents to search in</span>
<span class="sd">        properties: properties to return in grouped documents</span>
<span class="sd">        sort: Dictionary of sort order for fields. Keys are field names and</span>
<span class="sd">            values are 1 for ascending or -1 for descending.</span>
<span class="sd">        skip: number documents to skip</span>
<span class="sd">        limit: limit on total number of documents returned</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">criteria</span> <span class="o">=</span> <span class="n">criteria</span> <span class="k">if</span> <span class="n">criteria</span> <span class="k">else</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">properties</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">}</span>
        <span class="n">substitute</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reverse_aliases</span><span class="p">)</span>

    <span class="n">lazy_substitute</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reverse_aliases</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
        <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="n">skip</span>
    <span class="p">):</span>
        <span class="n">substitute</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aliases</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">d</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.advanced_stores.AliasingStore.remove_docs">
<code class="codehilite language-python"><span class="n">remove_docs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.advanced_stores.AliasingStore.remove_docs" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Remove docs matching the query dictionary</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>criteria</code></td>
        <td><code>Dict</code></td>
        <td><p>query dictionary to match</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/advanced_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">remove_docs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove docs matching the query dictionary</span>

<span class="sd">    Args:</span>
<span class="sd">        criteria: query dictionary to match</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Update criteria and properties based on aliases</span>
    <span class="n">lazy_substitute</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reverse_aliases</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">remove_docs</span><span class="p">(</span><span class="n">criteria</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.advanced_stores.AliasingStore.update">
<code class="codehilite language-python"><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.advanced_stores.AliasingStore.update" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Update documents into the Store</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>docs</code></td>
        <td><code>Union[List[Dict], Dict]</code></td>
        <td><p>the document or list of documents to update</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>key</code></td>
        <td><code>Union[List, str]</code></td>
        <td><p>field name(s) to determine uniqueness for a
 document, can be a list of multiple fields,
 a single field, or None if the Store's key
 field is to be used</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/advanced_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">Dict</span><span class="p">],</span> <span class="n">key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update documents into the Store</span>

<span class="sd">    Args:</span>
<span class="sd">        docs: the document or list of documents to update</span>
<span class="sd">        key: field name(s) to determine uniqueness for a</span>
<span class="sd">             document, can be a list of multiple fields,</span>
<span class="sd">             a single field, or None if the Store&#39;s key</span>
<span class="sd">             field is to be used</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">key</span> <span class="k">if</span> <span class="n">key</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span>

    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">:</span>
        <span class="n">substitute</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reverse_aliases</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aliases</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aliases</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">docs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h2 class="doc doc-heading" id="maggma.stores.advanced_stores.MongograntStore">
        <code>
MongograntStore            (<a class="autorefs autorefs-internal" title="maggma.stores.mongolike.MongoStore" href="#maggma.stores.mongolike.MongoStore">MongoStore</a>)
        </code>



<a class="headerlink" href="#maggma.stores.advanced_stores.MongograntStore" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Initialize a Store with a mongogrant "<code>&lt;role&gt;</code>:<code>&lt;host&gt;</code>/<code>&lt;db&gt;</code>." spec.</p>
<p>Some class methods of MongoStore, e.g. from_db_file and from_collection,
are not supported.</p>
<p>mongogrant documentation: https://github.com/materialsproject/mongogrant</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/advanced_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">MongograntStore</span><span class="p">(</span><span class="n">MongoStore</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize a Store with a mongogrant &quot;`&lt;role&gt;`:`&lt;host&gt;`/`&lt;db&gt;`.&quot; spec.</span>

<span class="sd">    Some class methods of MongoStore, e.g. from_db_file and from_collection,</span>
<span class="sd">    are not supported.</span>

<span class="sd">    mongogrant documentation: https://github.com/materialsproject/mongogrant</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mongogrant_spec</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">mgclient_config_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            mongogrant_spec: of the form `&lt;role&gt;`:`&lt;host&gt;`/`&lt;db&gt;`, where</span>
<span class="sd">                role is one of {&quot;read&quot;, &quot;readWrite&quot;} or aliases {&quot;ro&quot;, &quot;rw&quot;};</span>
<span class="sd">                host is a db host (w/ optional port) or alias; and db is a db</span>
<span class="sd">                on that host, or alias. See mongogrant documentation.</span>
<span class="sd">            collection_name: name of mongo collection</span>
<span class="sd">            mgclient_config_path: Path to mongogrant client config file,</span>
<span class="sd">               or None if default path (`mongogrant.client.path`).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mongogrant_spec</span> <span class="o">=</span> <span class="n">mongogrant_spec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span> <span class="o">=</span> <span class="n">collection_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mgclient_config_path</span> <span class="o">=</span> <span class="n">mgclient_config_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mgclient_config_path</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="n">check</span><span class="o">=</span><span class="n">check</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mgclient_config_path</span><span class="p">)</span>
            <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">set</span><span class="p">((</span><span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="s2">&quot;database&quot;</span><span class="p">,</span> <span class="s2">&quot;host&quot;</span><span class="p">))</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">StoreError</span><span class="p">(</span>
                <span class="s2">&quot;MongograntStore does not accept &quot;</span>
                <span class="s2">&quot;username, password, database, or host &quot;</span>
                <span class="s2">&quot;arguments. Use `mongogrant_spec`.&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="n">_auth_info</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_db_auth_from_spec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mongogrant_spec</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MongograntStore</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">host</span><span class="o">=</span><span class="n">_auth_info</span><span class="p">[</span><span class="s2">&quot;host&quot;</span><span class="p">],</span>
            <span class="n">database</span><span class="o">=</span><span class="n">_auth_info</span><span class="p">[</span><span class="s2">&quot;authSource&quot;</span><span class="p">],</span>
            <span class="n">username</span><span class="o">=</span><span class="n">_auth_info</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">],</span>
            <span class="n">password</span><span class="o">=</span><span class="n">_auth_info</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">],</span>
            <span class="n">collection_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;mgrant://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mongogrant_spec</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mongogrant_spec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_db_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Raises ValueError since MongograntStores can&#39;t be initialized from a file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;MongograntStore doesn&#39;t implement from_db_file&quot;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_collection</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">collection</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Raises ValueError since MongograntStores can&#39;t be initialized from a PyMongo collection</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;MongograntStore doesn&#39;t implement from_collection&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check equality for MongograntStore</span>

<span class="sd">        Args:</span>
<span class="sd">            other: other MongograntStore to compare with</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">MongograntStore</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;mongogrant_spec&quot;</span><span class="p">,</span>
            <span class="s2">&quot;collection_name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mgclient_config_path&quot;</span><span class="p">,</span>
            <span class="s2">&quot;last_updated_field&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="maggma.stores.advanced_stores.MongograntStore.name">
<code class="codehilite language-python"><span class="n">name</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.advanced_stores.MongograntStore.name" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Return a string representing this data source</p>
    </div>

  </div>






  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.advanced_stores.MongograntStore.__eq__">
<code class="codehilite language-python"><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.advanced_stores.MongograntStore.__eq__" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Check equality for MongograntStore</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>other</code></td>
        <td><code>object</code></td>
        <td><p>other MongograntStore to compare with</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/advanced_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check equality for MongograntStore</span>

<span class="sd">    Args:</span>
<span class="sd">        other: other MongograntStore to compare with</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">MongograntStore</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;mongogrant_spec&quot;</span><span class="p">,</span>
        <span class="s2">&quot;collection_name&quot;</span><span class="p">,</span>
        <span class="s2">&quot;mgclient_config_path&quot;</span><span class="p">,</span>
        <span class="s2">&quot;last_updated_field&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>




  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.advanced_stores.MongograntStore.__init__">
<code class="codehilite language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mongogrant_spec</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">,</span> <span class="n">mgclient_config_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.advanced_stores.MongograntStore.__init__" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>mongogrant_spec</code></td>
        <td><code>str</code></td>
        <td><p>of the form <code>&lt;role&gt;</code>:<code>&lt;host&gt;</code>/<code>&lt;db&gt;</code>, where
role is one of {"read", "readWrite"} or aliases {"ro", "rw"};
host is a db host (w/ optional port) or alias; and db is a db
on that host, or alias. See mongogrant documentation.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>collection_name</code></td>
        <td><code>str</code></td>
        <td><p>name of mongo collection</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>mgclient_config_path</code></td>
        <td><code>Optional[str]</code></td>
        <td><p>Path to mongogrant client config file,
or None if default path (<code>mongogrant.client.path</code>).</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/advanced_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">mongogrant_spec</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">mgclient_config_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        mongogrant_spec: of the form `&lt;role&gt;`:`&lt;host&gt;`/`&lt;db&gt;`, where</span>
<span class="sd">            role is one of {&quot;read&quot;, &quot;readWrite&quot;} or aliases {&quot;ro&quot;, &quot;rw&quot;};</span>
<span class="sd">            host is a db host (w/ optional port) or alias; and db is a db</span>
<span class="sd">            on that host, or alias. See mongogrant documentation.</span>
<span class="sd">        collection_name: name of mongo collection</span>
<span class="sd">        mgclient_config_path: Path to mongogrant client config file,</span>
<span class="sd">           or None if default path (`mongogrant.client.path`).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mongogrant_spec</span> <span class="o">=</span> <span class="n">mongogrant_spec</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span> <span class="o">=</span> <span class="n">collection_name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mgclient_config_path</span> <span class="o">=</span> <span class="n">mgclient_config_path</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mgclient_config_path</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="n">check</span><span class="o">=</span><span class="n">check</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mgclient_config_path</span><span class="p">)</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">set</span><span class="p">((</span><span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="s2">&quot;database&quot;</span><span class="p">,</span> <span class="s2">&quot;host&quot;</span><span class="p">))</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">StoreError</span><span class="p">(</span>
            <span class="s2">&quot;MongograntStore does not accept &quot;</span>
            <span class="s2">&quot;username, password, database, or host &quot;</span>
            <span class="s2">&quot;arguments. Use `mongogrant_spec`.&quot;</span>
        <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
    <span class="n">_auth_info</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_db_auth_from_spec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mongogrant_spec</span><span class="p">)</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">MongograntStore</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
        <span class="n">host</span><span class="o">=</span><span class="n">_auth_info</span><span class="p">[</span><span class="s2">&quot;host&quot;</span><span class="p">],</span>
        <span class="n">database</span><span class="o">=</span><span class="n">_auth_info</span><span class="p">[</span><span class="s2">&quot;authSource&quot;</span><span class="p">],</span>
        <span class="n">username</span><span class="o">=</span><span class="n">_auth_info</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">],</span>
        <span class="n">password</span><span class="o">=</span><span class="n">_auth_info</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">],</span>
        <span class="n">collection_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.advanced_stores.MongograntStore.from_collection">
<code class="codehilite language-python"><span class="n">from_collection</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-classmethod"><code>classmethod</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.advanced_stores.MongograntStore.from_collection" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Raises ValueError since MongograntStores can't be initialized from a PyMongo collection</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/advanced_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">from_collection</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">collection</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Raises ValueError since MongograntStores can&#39;t be initialized from a PyMongo collection</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;MongograntStore doesn&#39;t implement from_collection&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.advanced_stores.MongograntStore.from_db_file">
<code class="codehilite language-python"><span class="n">from_db_file</span><span class="p">(</span><span class="n">file</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-classmethod"><code>classmethod</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.advanced_stores.MongograntStore.from_db_file" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Raises ValueError since MongograntStores can't be initialized from a file</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/advanced_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">from_db_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Raises ValueError since MongograntStores can&#39;t be initialized from a file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;MongograntStore doesn&#39;t implement from_db_file&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h2 class="doc doc-heading" id="maggma.stores.advanced_stores.SandboxStore">
        <code>
SandboxStore            (<a class="autorefs autorefs-internal" title="maggma.core.store.Store" href="../core_store/#maggma.core.store.Store">Store</a>)
        </code>



<a class="headerlink" href="#maggma.stores.advanced_stores.SandboxStore" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Provides a sandboxed view to another store</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/advanced_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">SandboxStore</span><span class="p">(</span><span class="n">Store</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Provides a sandboxed view to another store</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">store</span><span class="p">:</span> <span class="n">Store</span><span class="p">,</span> <span class="n">sandbox</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">exclusive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            store: store to wrap sandboxing around</span>
<span class="sd">            sandbox: the corresponding sandbox</span>
<span class="sd">            exclusive: whether to be exclusively in this sandbox or include global items</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">store</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sandbox</span> <span class="o">=</span> <span class="n">sandbox</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exclusive</span> <span class="o">=</span> <span class="n">exclusive</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
            <span class="n">last_updated_field</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">last_updated_field</span><span class="p">,</span>
            <span class="n">last_updated_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">last_updated_type</span><span class="p">,</span>
            <span class="n">validator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">validator</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            a string representing this data source</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Sandbox[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">][</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sandbox</span><span class="si">}</span><span class="s2">]&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sbx_criteria</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            the sandbox criteria dict used to filter the source store</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exclusive</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;sbxn&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sandbox</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;$or&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;sbxn&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sandbox</span><span class="p">]}},</span> <span class="p">{</span><span class="s2">&quot;sbxn&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$exists&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}}]</span>
            <span class="p">}</span>

    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Counts the number of documents matching the query criteria</span>

<span class="sd">        Args:</span>
<span class="sd">            criteria: PyMongo filter for documents to count in</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">criteria</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span><span class="o">**</span><span class="n">criteria</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">sbx_criteria</span><span class="p">)</span> <span class="k">if</span> <span class="n">criteria</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">sbx_criteria</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">properties</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">skip</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Queries the Store for a set of documents</span>

<span class="sd">        Args:</span>
<span class="sd">            criteria: PyMongo filter for documents to search in</span>
<span class="sd">            properties: properties to return in grouped documents</span>
<span class="sd">            sort: Dictionary of sort order for fields. Keys are field names and</span>
<span class="sd">                values are 1 for ascending or -1 for descending.</span>
<span class="sd">            skip: number documents to skip</span>
<span class="sd">            limit: limit on total number of documents returned</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">criteria</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span><span class="o">**</span><span class="n">criteria</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">sbx_criteria</span><span class="p">)</span> <span class="k">if</span> <span class="n">criteria</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">sbx_criteria</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="n">skip</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">groupby</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">keys</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">properties</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">skip</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simple grouping function that will group documents</span>
<span class="sd">        by keys.</span>

<span class="sd">        Args:</span>
<span class="sd">            keys: fields to group documents</span>
<span class="sd">            criteria: PyMongo filter for documents to search in</span>
<span class="sd">            properties: properties to return in grouped documents</span>
<span class="sd">            sort: Dictionary of sort order for fields. Keys are field names and</span>
<span class="sd">                values are 1 for ascending or -1 for descending.</span>
<span class="sd">            skip: number documents to skip</span>
<span class="sd">            limit: limit on total number of documents returned</span>

<span class="sd">        Returns:</span>
<span class="sd">            generator returning tuples of (dict, list of docs)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">criteria</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span><span class="o">**</span><span class="n">criteria</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">sbx_criteria</span><span class="p">)</span> <span class="k">if</span> <span class="n">criteria</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">sbx_criteria</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
            <span class="n">keys</span><span class="o">=</span><span class="n">keys</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="n">skip</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">Dict</span><span class="p">],</span> <span class="n">key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update documents into the Store</span>

<span class="sd">        Args:</span>
<span class="sd">            docs: the document or list of documents to update</span>
<span class="sd">            key: field name(s) to determine uniqueness for a</span>
<span class="sd">                 document, can be a list of multiple fields,</span>
<span class="sd">                 a single field, or None if the Store&#39;s key</span>
<span class="sd">                 field is to be used</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;sbxn&quot;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="s2">&quot;sbxn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;sbxn&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sandbox</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="s2">&quot;sbxn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sandbox</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">docs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove_docs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove docs matching the query dictionary</span>

<span class="sd">        Args:</span>
<span class="sd">            criteria: query dictionary to match</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Update criteria and properties based on aliases</span>
        <span class="n">criteria</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span><span class="o">**</span><span class="n">criteria</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">sbx_criteria</span><span class="p">)</span> <span class="k">if</span> <span class="n">criteria</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">sbx_criteria</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">remove_docs</span><span class="p">(</span><span class="n">criteria</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ensure_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">ensure_index</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">unique</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">_collection</span>

    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_reset</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">force_reset</span><span class="o">=</span><span class="n">force_reset</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check equality for SandboxStore</span>

<span class="sd">        Args:</span>
<span class="sd">            other: other SandboxStore to compare with</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">SandboxStore</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="s2">&quot;sandbox&quot;</span><span class="p">,</span> <span class="s2">&quot;last_updated_field&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="maggma.stores.advanced_stores.SandboxStore.name">
<code class="codehilite language-python"><span class="n">name</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.advanced_stores.SandboxStore.name" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>str</code></td>
      <td><p>a string representing this data source</p></td>
    </tr>
  </tbody>
</table>    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="maggma.stores.advanced_stores.SandboxStore.sbx_criteria">
<code class="codehilite language-python"><span class="n">sbx_criteria</span><span class="p">:</span> <span class="n">Dict</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.advanced_stores.SandboxStore.sbx_criteria" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Dict</code></td>
      <td><p>the sandbox criteria dict used to filter the source store</p></td>
    </tr>
  </tbody>
</table>    </div>

  </div>






  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.advanced_stores.SandboxStore.__eq__">
<code class="codehilite language-python"><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.advanced_stores.SandboxStore.__eq__" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Check equality for SandboxStore</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>other</code></td>
        <td><code>object</code></td>
        <td><p>other SandboxStore to compare with</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/advanced_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check equality for SandboxStore</span>

<span class="sd">    Args:</span>
<span class="sd">        other: other SandboxStore to compare with</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">SandboxStore</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="s2">&quot;sandbox&quot;</span><span class="p">,</span> <span class="s2">&quot;last_updated_field&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.advanced_stores.SandboxStore.__init__">
<code class="codehilite language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">store</span><span class="p">,</span> <span class="n">sandbox</span><span class="p">,</span> <span class="n">exclusive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.advanced_stores.SandboxStore.__init__" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>store</code></td>
        <td><code>Store</code></td>
        <td><p>store to wrap sandboxing around</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>sandbox</code></td>
        <td><code>str</code></td>
        <td><p>the corresponding sandbox</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>exclusive</code></td>
        <td><code>bool</code></td>
        <td><p>whether to be exclusively in this sandbox or include global items</p></td>
        <td><code>False</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/advanced_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">store</span><span class="p">:</span> <span class="n">Store</span><span class="p">,</span> <span class="n">sandbox</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">exclusive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        store: store to wrap sandboxing around</span>
<span class="sd">        sandbox: the corresponding sandbox</span>
<span class="sd">        exclusive: whether to be exclusively in this sandbox or include global items</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">store</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sandbox</span> <span class="o">=</span> <span class="n">sandbox</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">exclusive</span> <span class="o">=</span> <span class="n">exclusive</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
        <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
        <span class="n">last_updated_field</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">last_updated_field</span><span class="p">,</span>
        <span class="n">last_updated_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">last_updated_type</span><span class="p">,</span>
        <span class="n">validator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">validator</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.advanced_stores.SandboxStore.close">
<code class="codehilite language-python"><span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.advanced_stores.SandboxStore.close" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Closes any connections</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/advanced_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.advanced_stores.SandboxStore.connect">
<code class="codehilite language-python"><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_reset</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.advanced_stores.SandboxStore.connect" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Connect to the source data</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>force_reset</code></td>
        <td></td>
        <td><p>whether to reset the connection or not</p></td>
        <td><code>False</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/advanced_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_reset</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">force_reset</span><span class="o">=</span><span class="n">force_reset</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.advanced_stores.SandboxStore.count">
<code class="codehilite language-python"><span class="n">count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.advanced_stores.SandboxStore.count" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Counts the number of documents matching the query criteria</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>criteria</code></td>
        <td><code>Optional[Dict]</code></td>
        <td><p>PyMongo filter for documents to count in</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/advanced_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Counts the number of documents matching the query criteria</span>

<span class="sd">    Args:</span>
<span class="sd">        criteria: PyMongo filter for documents to count in</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">criteria</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nb">dict</span><span class="p">(</span><span class="o">**</span><span class="n">criteria</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">sbx_criteria</span><span class="p">)</span> <span class="k">if</span> <span class="n">criteria</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">sbx_criteria</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.advanced_stores.SandboxStore.ensure_index">
<code class="codehilite language-python"><span class="n">ensure_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.advanced_stores.SandboxStore.ensure_index" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Tries to create an index and return true if it suceeded</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>key</code></td>
        <td></td>
        <td><p>single key to index</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>unique</code></td>
        <td></td>
        <td><p>Whether or not this index contains only unique keys</p></td>
        <td><code>False</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td></td>
      <td><p>bool indicating if the index exists/was created</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/advanced_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">ensure_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">ensure_index</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">unique</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.advanced_stores.SandboxStore.groupby">
<code class="codehilite language-python"><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.advanced_stores.SandboxStore.groupby" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Simple grouping function that will group documents
by keys.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>keys</code></td>
        <td><code>Union[List[str], str]</code></td>
        <td><p>fields to group documents</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>criteria</code></td>
        <td><code>Optional[Dict]</code></td>
        <td><p>PyMongo filter for documents to search in</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>properties</code></td>
        <td><code>Union[Dict, List]</code></td>
        <td><p>properties to return in grouped documents</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>sort</code></td>
        <td><code>Optional[Dict[str, Union[maggma.core.store.Sort, int]]]</code></td>
        <td><p>Dictionary of sort order for fields. Keys are field names and
values are 1 for ascending or -1 for descending.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>skip</code></td>
        <td><code>int</code></td>
        <td><p>number documents to skip</p></td>
        <td><code>0</code></td>
      </tr>
      <tr>
        <td><code>limit</code></td>
        <td><code>int</code></td>
        <td><p>limit on total number of documents returned</p></td>
        <td><code>0</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Iterator[Tuple[Dict, List[Dict]]]</code></td>
      <td><p>generator returning tuples of (dict, list of docs)</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/advanced_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">groupby</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">keys</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">],</span>
    <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">properties</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">sort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">skip</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple grouping function that will group documents</span>
<span class="sd">    by keys.</span>

<span class="sd">    Args:</span>
<span class="sd">        keys: fields to group documents</span>
<span class="sd">        criteria: PyMongo filter for documents to search in</span>
<span class="sd">        properties: properties to return in grouped documents</span>
<span class="sd">        sort: Dictionary of sort order for fields. Keys are field names and</span>
<span class="sd">            values are 1 for ascending or -1 for descending.</span>
<span class="sd">        skip: number documents to skip</span>
<span class="sd">        limit: limit on total number of documents returned</span>

<span class="sd">    Returns:</span>
<span class="sd">        generator returning tuples of (dict, list of docs)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">criteria</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nb">dict</span><span class="p">(</span><span class="o">**</span><span class="n">criteria</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">sbx_criteria</span><span class="p">)</span> <span class="k">if</span> <span class="n">criteria</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">sbx_criteria</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
        <span class="n">keys</span><span class="o">=</span><span class="n">keys</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="n">skip</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.advanced_stores.SandboxStore.query">
<code class="codehilite language-python"><span class="n">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.advanced_stores.SandboxStore.query" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Queries the Store for a set of documents</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>criteria</code></td>
        <td><code>Optional[Dict]</code></td>
        <td><p>PyMongo filter for documents to search in</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>properties</code></td>
        <td><code>Union[Dict, List]</code></td>
        <td><p>properties to return in grouped documents</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>sort</code></td>
        <td><code>Optional[Dict[str, Union[maggma.core.store.Sort, int]]]</code></td>
        <td><p>Dictionary of sort order for fields. Keys are field names and
values are 1 for ascending or -1 for descending.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>skip</code></td>
        <td><code>int</code></td>
        <td><p>number documents to skip</p></td>
        <td><code>0</code></td>
      </tr>
      <tr>
        <td><code>limit</code></td>
        <td><code>int</code></td>
        <td><p>limit on total number of documents returned</p></td>
        <td><code>0</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/advanced_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">query</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">properties</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">sort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">skip</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Queries the Store for a set of documents</span>

<span class="sd">    Args:</span>
<span class="sd">        criteria: PyMongo filter for documents to search in</span>
<span class="sd">        properties: properties to return in grouped documents</span>
<span class="sd">        sort: Dictionary of sort order for fields. Keys are field names and</span>
<span class="sd">            values are 1 for ascending or -1 for descending.</span>
<span class="sd">        skip: number documents to skip</span>
<span class="sd">        limit: limit on total number of documents returned</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">criteria</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nb">dict</span><span class="p">(</span><span class="o">**</span><span class="n">criteria</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">sbx_criteria</span><span class="p">)</span> <span class="k">if</span> <span class="n">criteria</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">sbx_criteria</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
        <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="n">skip</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.advanced_stores.SandboxStore.remove_docs">
<code class="codehilite language-python"><span class="n">remove_docs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.advanced_stores.SandboxStore.remove_docs" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Remove docs matching the query dictionary</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>criteria</code></td>
        <td><code>Dict</code></td>
        <td><p>query dictionary to match</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/advanced_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">remove_docs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove docs matching the query dictionary</span>

<span class="sd">    Args:</span>
<span class="sd">        criteria: query dictionary to match</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Update criteria and properties based on aliases</span>
    <span class="n">criteria</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nb">dict</span><span class="p">(</span><span class="o">**</span><span class="n">criteria</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">sbx_criteria</span><span class="p">)</span> <span class="k">if</span> <span class="n">criteria</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">sbx_criteria</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">remove_docs</span><span class="p">(</span><span class="n">criteria</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.advanced_stores.SandboxStore.update">
<code class="codehilite language-python"><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.advanced_stores.SandboxStore.update" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Update documents into the Store</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>docs</code></td>
        <td><code>Union[List[Dict], Dict]</code></td>
        <td><p>the document or list of documents to update</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>key</code></td>
        <td><code>Union[List, str]</code></td>
        <td><p>field name(s) to determine uniqueness for a
 document, can be a list of multiple fields,
 a single field, or None if the Store's key
 field is to be used</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/advanced_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">Dict</span><span class="p">],</span> <span class="n">key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update documents into the Store</span>

<span class="sd">    Args:</span>
<span class="sd">        docs: the document or list of documents to update</span>
<span class="sd">        key: field name(s) to determine uniqueness for a</span>
<span class="sd">             document, can be a list of multiple fields,</span>
<span class="sd">             a single field, or None if the Store&#39;s key</span>
<span class="sd">             field is to be used</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;sbxn&quot;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="s2">&quot;sbxn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;sbxn&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sandbox</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="s2">&quot;sbxn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sandbox</span><span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">docs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h2 class="doc doc-heading" id="maggma.stores.advanced_stores.VaultStore">
        <code>
VaultStore            (<a class="autorefs autorefs-internal" title="maggma.stores.mongolike.MongoStore" href="#maggma.stores.mongolike.MongoStore">MongoStore</a>)
        </code>



<a class="headerlink" href="#maggma.stores.advanced_stores.VaultStore" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Extends MongoStore to read credentials out of Vault server
and uses these values to initialize MongoStore instance</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/advanced_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">VaultStore</span><span class="p">(</span><span class="n">MongoStore</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extends MongoStore to read credentials out of Vault server</span>
<span class="sd">    and uses these values to initialize MongoStore instance</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@requires</span><span class="p">(</span><span class="n">hvac</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;hvac is required to use VaultStore&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">vault_secret_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            collection_name: name of mongo collection</span>
<span class="sd">            vault_secret_path: path on vault server with mongo creds object</span>

<span class="sd">        Important:</span>
<span class="sd">            Environment variables that must be set prior to invocation</span>
<span class="sd">            VAULT_ADDR - URL of vault server (eg. https://matgen8.lbl.gov:8200)</span>
<span class="sd">            VAULT_TOKEN or GITHUB_TOKEN - token used to authenticate to vault</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span> <span class="o">=</span> <span class="n">collection_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vault_secret_path</span> <span class="o">=</span> <span class="n">vault_secret_path</span>

        <span class="c1"># TODO: Switch this over to Pydantic ConfigSettings</span>
        <span class="n">vault_addr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;VAULT_ADDR&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">vault_addr</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;VAULT_ADDR not set&quot;</span><span class="p">)</span>

        <span class="n">client</span> <span class="o">=</span> <span class="n">hvac</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="n">vault_addr</span><span class="p">)</span>

        <span class="c1"># If we have a vault token use this</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;VAULT_TOKEN&quot;</span><span class="p">)</span>

        <span class="c1"># Look for a github token instead</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
            <span class="n">github_token</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;GITHUB_TOKEN&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">github_token</span><span class="p">:</span>
                <span class="n">client</span><span class="o">.</span><span class="n">auth_github</span><span class="p">(</span><span class="n">github_token</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;VAULT_TOKEN or GITHUB_TOKEN not set&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">token</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">client</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Bad token&quot;</span><span class="p">)</span>

        <span class="c1"># Read the vault secret</span>
        <span class="n">json_db_creds</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">vault_secret_path</span><span class="p">)</span>
        <span class="n">db_creds</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_db_creds</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">])</span>

        <span class="n">database</span> <span class="o">=</span> <span class="n">db_creds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;db&quot;</span><span class="p">)</span>
        <span class="n">host</span> <span class="o">=</span> <span class="n">db_creds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;host&quot;</span><span class="p">,</span> <span class="s2">&quot;localhost&quot;</span><span class="p">)</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">db_creds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;port&quot;</span><span class="p">,</span> <span class="mi">27017</span><span class="p">)</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">db_creds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">db_creds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">VaultStore</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">database</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check equality for VaultStore</span>

<span class="sd">        Args:</span>
<span class="sd">            other: other VaultStore to compare with</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">VaultStore</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;vault_secret_path&quot;</span><span class="p">,</span> <span class="s2">&quot;collection_name&quot;</span><span class="p">,</span> <span class="s2">&quot;last_updated_field&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.advanced_stores.VaultStore.__eq__">
<code class="codehilite language-python"><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.advanced_stores.VaultStore.__eq__" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Check equality for VaultStore</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>other</code></td>
        <td><code>object</code></td>
        <td><p>other VaultStore to compare with</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/advanced_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check equality for VaultStore</span>

<span class="sd">    Args:</span>
<span class="sd">        other: other VaultStore to compare with</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">VaultStore</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;vault_secret_path&quot;</span><span class="p">,</span> <span class="s2">&quot;collection_name&quot;</span><span class="p">,</span> <span class="s2">&quot;last_updated_field&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.advanced_stores.VaultStore.__init__">
<code class="codehilite language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">,</span> <span class="n">vault_secret_path</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.advanced_stores.VaultStore.__init__" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>collection_name</code></td>
        <td><code>str</code></td>
        <td><p>name of mongo collection</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>vault_secret_path</code></td>
        <td><code>str</code></td>
        <td><p>path on vault server with mongo creds object</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>      <div class="admonition important">
<p class="admonition-title">Important</p>
<p>Environment variables that must be set prior to invocation
VAULT_ADDR - URL of vault server (eg. https://matgen8.lbl.gov:8200)
VAULT_TOKEN or GITHUB_TOKEN - token used to authenticate to vault</p>
</div>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/advanced_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="nd">@requires</span><span class="p">(</span><span class="n">hvac</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;hvac is required to use VaultStore&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">vault_secret_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        collection_name: name of mongo collection</span>
<span class="sd">        vault_secret_path: path on vault server with mongo creds object</span>

<span class="sd">    Important:</span>
<span class="sd">        Environment variables that must be set prior to invocation</span>
<span class="sd">        VAULT_ADDR - URL of vault server (eg. https://matgen8.lbl.gov:8200)</span>
<span class="sd">        VAULT_TOKEN or GITHUB_TOKEN - token used to authenticate to vault</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span> <span class="o">=</span> <span class="n">collection_name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">vault_secret_path</span> <span class="o">=</span> <span class="n">vault_secret_path</span>

    <span class="c1"># TODO: Switch this over to Pydantic ConfigSettings</span>
    <span class="n">vault_addr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;VAULT_ADDR&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">vault_addr</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;VAULT_ADDR not set&quot;</span><span class="p">)</span>

    <span class="n">client</span> <span class="o">=</span> <span class="n">hvac</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="n">vault_addr</span><span class="p">)</span>

    <span class="c1"># If we have a vault token use this</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;VAULT_TOKEN&quot;</span><span class="p">)</span>

    <span class="c1"># Look for a github token instead</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
        <span class="n">github_token</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;GITHUB_TOKEN&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">github_token</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">auth_github</span><span class="p">(</span><span class="n">github_token</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;VAULT_TOKEN or GITHUB_TOKEN not set&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">client</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">token</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">client</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Bad token&quot;</span><span class="p">)</span>

    <span class="c1"># Read the vault secret</span>
    <span class="n">json_db_creds</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">vault_secret_path</span><span class="p">)</span>
    <span class="n">db_creds</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_db_creds</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">])</span>

    <span class="n">database</span> <span class="o">=</span> <span class="n">db_creds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;db&quot;</span><span class="p">)</span>
    <span class="n">host</span> <span class="o">=</span> <span class="n">db_creds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;host&quot;</span><span class="p">,</span> <span class="s2">&quot;localhost&quot;</span><span class="p">)</span>
    <span class="n">port</span> <span class="o">=</span> <span class="n">db_creds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;port&quot;</span><span class="p">,</span> <span class="mi">27017</span><span class="p">)</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">db_creds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">db_creds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="nb">super</span><span class="p">(</span><span class="n">VaultStore</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
        <span class="n">database</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">

<a id="maggma.stores.compound_stores"></a>
    <div class="doc doc-contents first">

      <p>Special stores that combine underlying Stores together </p>



  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h2 class="doc doc-heading" id="maggma.stores.compound_stores.ConcatStore">
        <code>
ConcatStore            (<a class="autorefs autorefs-internal" title="maggma.core.store.Store" href="../core_store/#maggma.core.store.Store">Store</a>)
        </code>



<a class="headerlink" href="#maggma.stores.compound_stores.ConcatStore" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Store concatting multiple stores</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/compound_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">ConcatStore</span><span class="p">(</span><span class="n">Store</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Store concatting multiple stores&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stores</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Store</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a ConcatStore that concatenates multiple stores together</span>
<span class="sd">        to appear as one store</span>

<span class="sd">        Args:</span>
<span class="sd">            stores: list of stores to concatenate together</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stores</span> <span class="o">=</span> <span class="n">stores</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ConcatStore</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A string representing this data source</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">compound_name</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">store</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">store</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stores</span><span class="p">])</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Concat[</span><span class="si">{</span><span class="n">compound_name</span><span class="si">}</span><span class="s2">]&quot;</span>

    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_reset</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Connect all stores in this ConcatStore</span>

<span class="sd">        Args:</span>
<span class="sd">            force_reset: Whether to forcibly reset the connection for all stores</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">store</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stores</span><span class="p">:</span>
            <span class="n">store</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">force_reset</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Close all connections in this ConcatStore</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">store</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stores</span><span class="p">:</span>
            <span class="n">store</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;No collection property for ConcatStore&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">last_updated</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finds the most recent last_updated across all the stores.</span>
<span class="sd">        This might not be the most usefull way to do this for this type of Store</span>
<span class="sd">        since it could very easily over-estimate the last_updated based on what stores</span>
<span class="sd">        are used</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lus</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">store</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stores</span><span class="p">:</span>
            <span class="n">lu</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">last_updated</span>
            <span class="n">lus</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lu</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">lus</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">Dict</span><span class="p">],</span> <span class="n">key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update documents into the Store</span>
<span class="sd">        Not implemented in ConcatStore</span>

<span class="sd">        Args:</span>
<span class="sd">            docs: the document or list of documents to update</span>
<span class="sd">            key: field name(s) to determine uniqueness for a</span>
<span class="sd">                 document, can be a list of multiple fields,</span>
<span class="sd">                 a single field, or None if the Store&#39;s key</span>
<span class="sd">                 field is to be used</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;No update method for ConcatStore&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">distinct</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">all_exist</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get all distinct values for a field</span>

<span class="sd">        Args:</span>
<span class="sd">            field: the field(s) to get distinct values for</span>
<span class="sd">            criteria: PyMongo filter for documents to search in</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">distincts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">store</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stores</span><span class="p">:</span>
            <span class="n">distincts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">store</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="n">field</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">))</span>

        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">distincts</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">ensure_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">unique</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ensure an index is properly set. Returns whether all stores support this index or not</span>

<span class="sd">        Args:</span>
<span class="sd">            key: single key to index</span>
<span class="sd">            unique: Whether or not this index contains only unique keys</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool indicating if the index exists/was created on all stores</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">([</span><span class="n">store</span><span class="o">.</span><span class="n">ensure_index</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">unique</span><span class="p">)</span> <span class="k">for</span> <span class="n">store</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stores</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Counts the number of documents matching the query criteria</span>

<span class="sd">        Args:</span>
<span class="sd">            criteria: PyMongo filter for documents to count in</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="p">[</span><span class="n">store</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">criteria</span><span class="p">)</span> <span class="k">for</span> <span class="n">store</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stores</span><span class="p">]</span>

        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">properties</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">skip</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Queries across all Store for a set of documents</span>

<span class="sd">        Args:</span>
<span class="sd">            criteria: PyMongo filter for documents to search in</span>
<span class="sd">            properties: properties to return in grouped documents</span>
<span class="sd">            sort: Dictionary of sort order for fields. Keys are field names and</span>
<span class="sd">                values are 1 for ascending or -1 for descending.</span>
<span class="sd">            skip: number documents to skip</span>
<span class="sd">            limit: limit on total number of documents returned</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: skip, sort and limit are broken. implement properly</span>
        <span class="k">for</span> <span class="n">store</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stores</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">store</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">groupby</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">keys</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">properties</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">skip</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simple grouping function that will group documents</span>
<span class="sd">        by keys.</span>

<span class="sd">        Args:</span>
<span class="sd">            keys: fields to group documents</span>
<span class="sd">            criteria: PyMongo filter for documents to search in</span>
<span class="sd">            properties: properties to return in grouped documents</span>
<span class="sd">            sort: Dictionary of sort order for fields. Keys are field names and</span>
<span class="sd">                values are 1 for ascending or -1 for descending.</span>
<span class="sd">            skip: number documents to skip</span>
<span class="sd">            limit: limit on total number of documents returned</span>

<span class="sd">        Returns:</span>
<span class="sd">            generator returning tuples of (dict, list of docs)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">keys</span><span class="p">]</span>

        <span class="n">docs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">store</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stores</span><span class="p">:</span>
            <span class="n">temp_docs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="n">store</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                    <span class="n">keys</span><span class="o">=</span><span class="n">keys</span><span class="p">,</span>
                    <span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">,</span>
                    <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">,</span>
                    <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span>
                    <span class="n">skip</span><span class="o">=</span><span class="n">skip</span><span class="p">,</span>
                    <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">temp_docs</span><span class="p">:</span>
                <span class="n">docs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">key_set</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">:</span>
            <span class="s2">&quot;index function based on passed in keys&quot;</span>
            <span class="n">test_d</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">test_d</span>

        <span class="n">sorted_docs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">docs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key_set</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">vals</span><span class="p">,</span> <span class="n">group_iter</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">(</span><span class="n">sorted_docs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key_set</span><span class="p">):</span>
            <span class="n">id_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">vals</span><span class="p">)}</span>
            <span class="k">yield</span> <span class="n">id_dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">group_iter</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove_docs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove docs matching the query dictionary</span>

<span class="sd">        Args:</span>
<span class="sd">            criteria: query dictionary to match</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;No remove_docs method for JointStore&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check equality for ConcatStore</span>

<span class="sd">        Args:</span>
<span class="sd">            other: other JointStore to compare with</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">ConcatStore</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;stores&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="maggma.stores.compound_stores.ConcatStore.last_updated">
<code class="codehilite language-python"><span class="n">last_updated</span><span class="p">:</span> <span class="n">datetime</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.compound_stores.ConcatStore.last_updated" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Finds the most recent last_updated across all the stores.
This might not be the most usefull way to do this for this type of Store
since it could very easily over-estimate the last_updated based on what stores
are used</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="maggma.stores.compound_stores.ConcatStore.name">
<code class="codehilite language-python"><span class="n">name</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.compound_stores.ConcatStore.name" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>A string representing this data source</p>
    </div>

  </div>






  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.compound_stores.ConcatStore.__eq__">
<code class="codehilite language-python"><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.compound_stores.ConcatStore.__eq__" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Check equality for ConcatStore</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>other</code></td>
        <td><code>object</code></td>
        <td><p>other JointStore to compare with</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/compound_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check equality for ConcatStore</span>

<span class="sd">    Args:</span>
<span class="sd">        other: other JointStore to compare with</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">ConcatStore</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;stores&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.compound_stores.ConcatStore.__init__">
<code class="codehilite language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stores</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.compound_stores.ConcatStore.__init__" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Initialize a ConcatStore that concatenates multiple stores together
to appear as one store</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>stores</code></td>
        <td><code>List[maggma.core.store.Store]</code></td>
        <td><p>list of stores to concatenate together</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/compound_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stores</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Store</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize a ConcatStore that concatenates multiple stores together</span>
<span class="sd">    to appear as one store</span>

<span class="sd">    Args:</span>
<span class="sd">        stores: list of stores to concatenate together</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stores</span> <span class="o">=</span> <span class="n">stores</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">ConcatStore</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.compound_stores.ConcatStore.close">
<code class="codehilite language-python"><span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.compound_stores.ConcatStore.close" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Close all connections in this ConcatStore</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/compound_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Close all connections in this ConcatStore</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">store</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stores</span><span class="p">:</span>
        <span class="n">store</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.compound_stores.ConcatStore.connect">
<code class="codehilite language-python"><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_reset</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.compound_stores.ConcatStore.connect" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Connect all stores in this ConcatStore</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>force_reset</code></td>
        <td><code>bool</code></td>
        <td><p>Whether to forcibly reset the connection for all stores</p></td>
        <td><code>False</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/compound_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_reset</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Connect all stores in this ConcatStore</span>

<span class="sd">    Args:</span>
<span class="sd">        force_reset: Whether to forcibly reset the connection for all stores</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">store</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stores</span><span class="p">:</span>
        <span class="n">store</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">force_reset</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.compound_stores.ConcatStore.count">
<code class="codehilite language-python"><span class="n">count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.compound_stores.ConcatStore.count" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Counts the number of documents matching the query criteria</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>criteria</code></td>
        <td><code>Optional[Dict]</code></td>
        <td><p>PyMongo filter for documents to count in</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/compound_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Counts the number of documents matching the query criteria</span>

<span class="sd">    Args:</span>
<span class="sd">        criteria: PyMongo filter for documents to count in</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="p">[</span><span class="n">store</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">criteria</span><span class="p">)</span> <span class="k">for</span> <span class="n">store</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stores</span><span class="p">]</span>

    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.compound_stores.ConcatStore.distinct">
<code class="codehilite language-python"><span class="n">distinct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">all_exist</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.compound_stores.ConcatStore.distinct" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Get all distinct values for a field</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>field</code></td>
        <td><code>str</code></td>
        <td><p>the field(s) to get distinct values for</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>criteria</code></td>
        <td><code>Optional[Dict]</code></td>
        <td><p>PyMongo filter for documents to search in</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/compound_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">distinct</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">all_exist</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get all distinct values for a field</span>

<span class="sd">    Args:</span>
<span class="sd">        field: the field(s) to get distinct values for</span>
<span class="sd">        criteria: PyMongo filter for documents to search in</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">distincts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">store</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stores</span><span class="p">:</span>
        <span class="n">distincts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">store</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="n">field</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">))</span>

    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">distincts</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.compound_stores.ConcatStore.ensure_index">
<code class="codehilite language-python"><span class="n">ensure_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.compound_stores.ConcatStore.ensure_index" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Ensure an index is properly set. Returns whether all stores support this index or not</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>key</code></td>
        <td><code>str</code></td>
        <td><p>single key to index</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>unique</code></td>
        <td><code>bool</code></td>
        <td><p>Whether or not this index contains only unique keys</p></td>
        <td><code>False</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>bool</code></td>
      <td><p>bool indicating if the index exists/was created on all stores</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/compound_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">ensure_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">unique</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ensure an index is properly set. Returns whether all stores support this index or not</span>

<span class="sd">    Args:</span>
<span class="sd">        key: single key to index</span>
<span class="sd">        unique: Whether or not this index contains only unique keys</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool indicating if the index exists/was created on all stores</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">all</span><span class="p">([</span><span class="n">store</span><span class="o">.</span><span class="n">ensure_index</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">unique</span><span class="p">)</span> <span class="k">for</span> <span class="n">store</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stores</span><span class="p">])</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.compound_stores.ConcatStore.groupby">
<code class="codehilite language-python"><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.compound_stores.ConcatStore.groupby" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Simple grouping function that will group documents
by keys.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>keys</code></td>
        <td><code>Union[List[str], str]</code></td>
        <td><p>fields to group documents</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>criteria</code></td>
        <td><code>Optional[Dict]</code></td>
        <td><p>PyMongo filter for documents to search in</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>properties</code></td>
        <td><code>Union[Dict, List]</code></td>
        <td><p>properties to return in grouped documents</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>sort</code></td>
        <td><code>Optional[Dict[str, Union[maggma.core.store.Sort, int]]]</code></td>
        <td><p>Dictionary of sort order for fields. Keys are field names and
values are 1 for ascending or -1 for descending.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>skip</code></td>
        <td><code>int</code></td>
        <td><p>number documents to skip</p></td>
        <td><code>0</code></td>
      </tr>
      <tr>
        <td><code>limit</code></td>
        <td><code>int</code></td>
        <td><p>limit on total number of documents returned</p></td>
        <td><code>0</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Iterator[Tuple[Dict, List[Dict]]]</code></td>
      <td><p>generator returning tuples of (dict, list of docs)</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/compound_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">groupby</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">keys</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">],</span>
    <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">properties</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">sort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">skip</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple grouping function that will group documents</span>
<span class="sd">    by keys.</span>

<span class="sd">    Args:</span>
<span class="sd">        keys: fields to group documents</span>
<span class="sd">        criteria: PyMongo filter for documents to search in</span>
<span class="sd">        properties: properties to return in grouped documents</span>
<span class="sd">        sort: Dictionary of sort order for fields. Keys are field names and</span>
<span class="sd">            values are 1 for ascending or -1 for descending.</span>
<span class="sd">        skip: number documents to skip</span>
<span class="sd">        limit: limit on total number of documents returned</span>

<span class="sd">    Returns:</span>
<span class="sd">        generator returning tuples of (dict, list of docs)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">keys</span><span class="p">]</span>

    <span class="n">docs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">store</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stores</span><span class="p">:</span>
        <span class="n">temp_docs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="n">store</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                <span class="n">keys</span><span class="o">=</span><span class="n">keys</span><span class="p">,</span>
                <span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">,</span>
                <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">,</span>
                <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span>
                <span class="n">skip</span><span class="o">=</span><span class="n">skip</span><span class="p">,</span>
                <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">temp_docs</span><span class="p">:</span>
            <span class="n">docs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">key_set</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">:</span>
        <span class="s2">&quot;index function based on passed in keys&quot;</span>
        <span class="n">test_d</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">test_d</span>

    <span class="n">sorted_docs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">docs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key_set</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">vals</span><span class="p">,</span> <span class="n">group_iter</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">(</span><span class="n">sorted_docs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key_set</span><span class="p">):</span>
        <span class="n">id_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">vals</span><span class="p">)}</span>
        <span class="k">yield</span> <span class="n">id_dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">group_iter</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.compound_stores.ConcatStore.query">
<code class="codehilite language-python"><span class="n">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.compound_stores.ConcatStore.query" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Queries across all Store for a set of documents</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>criteria</code></td>
        <td><code>Optional[Dict]</code></td>
        <td><p>PyMongo filter for documents to search in</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>properties</code></td>
        <td><code>Union[Dict, List]</code></td>
        <td><p>properties to return in grouped documents</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>sort</code></td>
        <td><code>Optional[Dict[str, Union[maggma.core.store.Sort, int]]]</code></td>
        <td><p>Dictionary of sort order for fields. Keys are field names and
values are 1 for ascending or -1 for descending.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>skip</code></td>
        <td><code>int</code></td>
        <td><p>number documents to skip</p></td>
        <td><code>0</code></td>
      </tr>
      <tr>
        <td><code>limit</code></td>
        <td><code>int</code></td>
        <td><p>limit on total number of documents returned</p></td>
        <td><code>0</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/compound_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">query</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">properties</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">sort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">skip</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Queries across all Store for a set of documents</span>

<span class="sd">    Args:</span>
<span class="sd">        criteria: PyMongo filter for documents to search in</span>
<span class="sd">        properties: properties to return in grouped documents</span>
<span class="sd">        sort: Dictionary of sort order for fields. Keys are field names and</span>
<span class="sd">            values are 1 for ascending or -1 for descending.</span>
<span class="sd">        skip: number documents to skip</span>
<span class="sd">        limit: limit on total number of documents returned</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: skip, sort and limit are broken. implement properly</span>
    <span class="k">for</span> <span class="n">store</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stores</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">store</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">d</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.compound_stores.ConcatStore.remove_docs">
<code class="codehilite language-python"><span class="n">remove_docs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.compound_stores.ConcatStore.remove_docs" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Remove docs matching the query dictionary</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>criteria</code></td>
        <td><code>Dict</code></td>
        <td><p>query dictionary to match</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/compound_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">remove_docs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove docs matching the query dictionary</span>

<span class="sd">    Args:</span>
<span class="sd">        criteria: query dictionary to match</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;No remove_docs method for JointStore&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.compound_stores.ConcatStore.update">
<code class="codehilite language-python"><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.compound_stores.ConcatStore.update" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Update documents into the Store
Not implemented in ConcatStore</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>docs</code></td>
        <td><code>Union[List[Dict], Dict]</code></td>
        <td><p>the document or list of documents to update</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>key</code></td>
        <td><code>Union[List, str]</code></td>
        <td><p>field name(s) to determine uniqueness for a
 document, can be a list of multiple fields,
 a single field, or None if the Store's key
 field is to be used</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/compound_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">Dict</span><span class="p">],</span> <span class="n">key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update documents into the Store</span>
<span class="sd">    Not implemented in ConcatStore</span>

<span class="sd">    Args:</span>
<span class="sd">        docs: the document or list of documents to update</span>
<span class="sd">        key: field name(s) to determine uniqueness for a</span>
<span class="sd">             document, can be a list of multiple fields,</span>
<span class="sd">             a single field, or None if the Store&#39;s key</span>
<span class="sd">             field is to be used</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;No update method for ConcatStore&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h2 class="doc doc-heading" id="maggma.stores.compound_stores.JointStore">
        <code>
JointStore            (<a class="autorefs autorefs-internal" title="maggma.core.store.Store" href="../core_store/#maggma.core.store.Store">Store</a>)
        </code>



<a class="headerlink" href="#maggma.stores.compound_stores.JointStore" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Store that implements a on-the-fly join across multiple collections all in the same MongoDB database.
This is a Read-Only Store designed to combine data from multiple collections.</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/compound_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">JointStore</span><span class="p">(</span><span class="n">Store</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Store that implements a on-the-fly join across multiple collections all in the same MongoDB database.</span>
<span class="sd">    This is a Read-Only Store designed to combine data from multiple collections.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">database</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">collection_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span>
        <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">27017</span><span class="p">,</span>
        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">main</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">merge_at_root</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">mongoclient_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            database: The database name</span>
<span class="sd">            collection_names: list of all collections</span>
<span class="sd">                to join</span>
<span class="sd">            host: Hostname for the database</span>
<span class="sd">            port: TCP port to connect to</span>
<span class="sd">            username: Username for the collection</span>
<span class="sd">            password: Password to connect with</span>
<span class="sd">            main: name for the main collection</span>
<span class="sd">                if not specified this defaults to the first</span>
<span class="sd">                in collection_names list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection_names</span> <span class="o">=</span> <span class="n">collection_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">password</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Any</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main</span> <span class="o">=</span> <span class="n">main</span> <span class="ow">or</span> <span class="n">collection_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">merge_at_root</span> <span class="o">=</span> <span class="n">merge_at_root</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mongoclient_kwargs</span> <span class="o">=</span> <span class="n">mongoclient_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">JointStore</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a string representing this data source</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">compound_name</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_names</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Compound[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="si">}</span><span class="s2">][</span><span class="si">{</span><span class="n">compound_name</span><span class="si">}</span><span class="s2">]&quot;</span>

    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_reset</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Connects the underlying Mongo database and</span>
<span class="sd">        all collection connections</span>

<span class="sd">        Args:</span>
<span class="sd">            force_reset: whether to forcibly reset the connection</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">conn</span><span class="p">:</span> <span class="n">MongoClient</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">MongoClient</span><span class="p">(</span>
                <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
                <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
                <span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
                <span class="n">password</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">,</span>
                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">mongoclient_kwargs</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">else</span> <span class="n">MongoClient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">mongoclient_kwargs</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_has_merge_objects</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">server_info</span><span class="p">()[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="s2">&quot;3.6&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Closes underlying database connections</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Property referring to the root pymongo collection&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StoreError</span><span class="p">(</span><span class="s2">&quot;Must connect Mongo-like store before attemping to use it&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nonmain_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        alll non-main collection names</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_names</span><span class="p">)</span> <span class="o">-</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="p">})</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">last_updated</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Special last_updated for this JointStore</span>
<span class="sd">        that checks all underlying collections</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lus</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_names</span><span class="p">:</span>
            <span class="n">store</span> <span class="o">=</span> <span class="n">MongoStore</span><span class="o">.</span><span class="n">from_collection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">database</span><span class="p">[</span><span class="n">cname</span><span class="p">])</span>
            <span class="n">store</span><span class="o">.</span><span class="n">last_updated_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span>
            <span class="n">lu</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">last_updated</span>
            <span class="n">lus</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lu</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">lus</span><span class="p">)</span>

    <span class="c1"># TODO: implement update?</span>
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docs</span><span class="p">,</span> <span class="n">update_lu</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update documents into the underlying collections</span>
<span class="sd">        Not Implemented for JointStore</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;JointStore is a read-only store&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_store_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MongoStore</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets an underlying collection as a mongoStore</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_names</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Asking for collection not referenced in this Store&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">MongoStore</span><span class="o">.</span><span class="n">from_collection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">database</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">ensure_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Can&#39;t ensure index for JointStore</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;No ensure_index method for JointStore&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the aggregation pipeline for query and query_one</span>

<span class="sd">        Args:</span>
<span class="sd">            properties: properties to be returned</span>
<span class="sd">            criteria: criteria to filter by</span>
<span class="sd">            skip: docs to skip</span>
<span class="sd">            limit: limit results to N docs</span>
<span class="sd">        Returns:</span>
<span class="sd">            list of aggregation operators</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">collection_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_names</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">cname</span> <span class="ow">in</span> <span class="n">collection_names</span><span class="p">:</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;$lookup&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="n">cname</span><span class="p">,</span>
                        <span class="s2">&quot;localField&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
                        <span class="s2">&quot;foreignField&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
                        <span class="s2">&quot;as&quot;</span><span class="p">:</span> <span class="n">cname</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_at_root</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_merge_objects</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                        <span class="s2">&quot;MongoDB server version too low to use $mergeObjects.&quot;</span>
                    <span class="p">)</span>

                <span class="n">pipeline</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;$replaceRoot&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;newRoot&quot;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="s2">&quot;$mergeObjects&quot;</span><span class="p">:</span> <span class="p">[</span>
                                    <span class="p">{</span><span class="s2">&quot;$arrayElemAt&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;$</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cname</span><span class="p">),</span> <span class="mi">0</span><span class="p">]},</span>
                                    <span class="s2">&quot;$$ROOT&quot;</span><span class="p">,</span>
                                <span class="p">]</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pipeline</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;$unwind&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;$</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cname</span><span class="p">),</span>
                            <span class="s2">&quot;preserveNullAndEmptyArrays&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">)</span>

        <span class="c1"># Do projection for max last_updated</span>
        <span class="n">lu_max_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;$</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span><span class="p">)]</span>
        <span class="n">lu_max_fields</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot;$</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">cname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_names</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">lu_proj</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">last_updated_field</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$max&quot;</span><span class="p">:</span> <span class="n">lu_max_fields</span><span class="p">}}</span>
        <span class="n">pipeline</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$addFields&quot;</span><span class="p">:</span> <span class="n">lu_proj</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">criteria</span><span class="p">:</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$match&quot;</span><span class="p">:</span> <span class="n">criteria</span><span class="p">})</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">properties</span><span class="p">:</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$project&quot;</span><span class="p">:</span> <span class="n">properties</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">skip</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$skip&quot;</span><span class="p">:</span> <span class="n">skip</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">limit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$limit&quot;</span><span class="p">:</span> <span class="n">limit</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">pipeline</span>

    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Counts the number of documents matching the query criteria</span>

<span class="sd">        Args:</span>
<span class="sd">            criteria: PyMongo filter for documents to count in</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pipeline</span><span class="p">(</span><span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">)</span>
        <span class="n">pipeline</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$count&quot;</span><span class="p">:</span> <span class="s2">&quot;count&quot;</span><span class="p">})</span>
        <span class="n">agg</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">pipeline</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">agg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">agg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">properties</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">skip</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pipeline</span><span class="p">(</span>
            <span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="n">skip</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span>
        <span class="p">)</span>
        <span class="n">agg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">agg</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">groupby</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">keys</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">properties</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">skip</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]]:</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pipeline</span><span class="p">(</span>
            <span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="n">skip</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">keys</span><span class="p">]</span>
        <span class="n">group_id</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: Dict[str,Any]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">set_</span><span class="p">(</span><span class="n">group_id</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="s2">&quot;$</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="n">pipeline</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$group&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">group_id</span><span class="p">,</span> <span class="s2">&quot;docs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$push&quot;</span><span class="p">:</span> <span class="s2">&quot;$$ROOT&quot;</span><span class="p">}}})</span>

        <span class="n">agg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">agg</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;docs&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">query_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get one document</span>

<span class="sd">        Args:</span>
<span class="sd">            properties: properties to return in query</span>
<span class="sd">            criteria: filter for matching</span>
<span class="sd">            kwargs: kwargs for collection.aggregate</span>

<span class="sd">        Returns:</span>
<span class="sd">            single document</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: maybe adding explicit limit in agg pipeline is better as below?</span>
        <span class="c1"># pipeline = self._get_pipeline(properties, criteria)</span>
        <span class="c1"># pipeline.append({&quot;$limit&quot;: 1})</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">doc</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">remove_docs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove docs matching the query dictionary</span>

<span class="sd">        Args:</span>
<span class="sd">            criteria: query dictionary to match</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;No remove_docs method for JointStore&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check equality for JointStore</span>
<span class="sd">        Args:</span>
<span class="sd">            other: other JointStore to compare with</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">JointStore</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;database&quot;</span><span class="p">,</span>
            <span class="s2">&quot;collection_names&quot;</span><span class="p">,</span>
            <span class="s2">&quot;host&quot;</span><span class="p">,</span>
            <span class="s2">&quot;port&quot;</span><span class="p">,</span>
            <span class="s2">&quot;main&quot;</span><span class="p">,</span>
            <span class="s2">&quot;merge_at_root&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="maggma.stores.compound_stores.JointStore.last_updated">
<code class="codehilite language-python"><span class="n">last_updated</span><span class="p">:</span> <span class="n">datetime</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.compound_stores.JointStore.last_updated" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Special last_updated for this JointStore
that checks all underlying collections</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="maggma.stores.compound_stores.JointStore.name">
<code class="codehilite language-python"><span class="n">name</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.compound_stores.JointStore.name" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Return a string representing this data source</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="maggma.stores.compound_stores.JointStore.nonmain_names">
<code class="codehilite language-python"><span class="n">nonmain_names</span><span class="p">:</span> <span class="n">List</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.compound_stores.JointStore.nonmain_names" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>alll non-main collection names</p>
    </div>

  </div>






  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.compound_stores.JointStore.__eq__">
<code class="codehilite language-python"><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.compound_stores.JointStore.__eq__" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Check equality for JointStore</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>other</code></td>
        <td><code>object</code></td>
        <td><p>other JointStore to compare with</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/compound_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check equality for JointStore</span>
<span class="sd">    Args:</span>
<span class="sd">        other: other JointStore to compare with</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">JointStore</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;database&quot;</span><span class="p">,</span>
        <span class="s2">&quot;collection_names&quot;</span><span class="p">,</span>
        <span class="s2">&quot;host&quot;</span><span class="p">,</span>
        <span class="s2">&quot;port&quot;</span><span class="p">,</span>
        <span class="s2">&quot;main&quot;</span><span class="p">,</span>
        <span class="s2">&quot;merge_at_root&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.compound_stores.JointStore.__init__">
<code class="codehilite language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">collection_names</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">27017</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">merge_at_root</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mongoclient_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a class="headerlink" href="#maggma.stores.compound_stores.JointStore.__init__" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>database</code></td>
        <td><code>str</code></td>
        <td><p>The database name</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>collection_names</code></td>
        <td><code>List[str]</code></td>
        <td><p>list of all collections
to join</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>host</code></td>
        <td><code>str</code></td>
        <td><p>Hostname for the database</p></td>
        <td><code>&#39;localhost&#39;</code></td>
      </tr>
      <tr>
        <td><code>port</code></td>
        <td><code>int</code></td>
        <td><p>TCP port to connect to</p></td>
        <td><code>27017</code></td>
      </tr>
      <tr>
        <td><code>username</code></td>
        <td><code>str</code></td>
        <td><p>Username for the collection</p></td>
        <td><code>&#39;&#39;</code></td>
      </tr>
      <tr>
        <td><code>password</code></td>
        <td><code>str</code></td>
        <td><p>Password to connect with</p></td>
        <td><code>&#39;&#39;</code></td>
      </tr>
      <tr>
        <td><code>main</code></td>
        <td><code>Optional[str]</code></td>
        <td><p>name for the main collection
if not specified this defaults to the first
in collection_names list</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/compound_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">database</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">collection_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span>
    <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">27017</span><span class="p">,</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">main</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">merge_at_root</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">mongoclient_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        database: The database name</span>
<span class="sd">        collection_names: list of all collections</span>
<span class="sd">            to join</span>
<span class="sd">        host: Hostname for the database</span>
<span class="sd">        port: TCP port to connect to</span>
<span class="sd">        username: Username for the collection</span>
<span class="sd">        password: Password to connect with</span>
<span class="sd">        main: name for the main collection</span>
<span class="sd">            if not specified this defaults to the first</span>
<span class="sd">            in collection_names list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">database</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">collection_names</span> <span class="o">=</span> <span class="n">collection_names</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">password</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Any</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">main</span> <span class="o">=</span> <span class="n">main</span> <span class="ow">or</span> <span class="n">collection_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">merge_at_root</span> <span class="o">=</span> <span class="n">merge_at_root</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mongoclient_kwargs</span> <span class="o">=</span> <span class="n">mongoclient_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

    <span class="nb">super</span><span class="p">(</span><span class="n">JointStore</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.compound_stores.JointStore.close">
<code class="codehilite language-python"><span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.compound_stores.JointStore.close" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Closes underlying database connections</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/compound_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Closes underlying database connections</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.compound_stores.JointStore.connect">
<code class="codehilite language-python"><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_reset</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.compound_stores.JointStore.connect" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Connects the underlying Mongo database and
all collection connections</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>force_reset</code></td>
        <td><code>bool</code></td>
        <td><p>whether to forcibly reset the connection</p></td>
        <td><code>False</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/compound_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_reset</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Connects the underlying Mongo database and</span>
<span class="sd">    all collection connections</span>

<span class="sd">    Args:</span>
<span class="sd">        force_reset: whether to forcibly reset the connection</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span><span class="p">:</span> <span class="n">MongoClient</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">MongoClient</span><span class="p">(</span>
            <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
            <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
            <span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
            <span class="n">password</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">,</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">mongoclient_kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span> <span class="n">MongoClient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">mongoclient_kwargs</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_coll</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_has_merge_objects</span> <span class="o">=</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">server_info</span><span class="p">()[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="s2">&quot;3.6&quot;</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.compound_stores.JointStore.count">
<code class="codehilite language-python"><span class="n">count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.compound_stores.JointStore.count" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Counts the number of documents matching the query criteria</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>criteria</code></td>
        <td><code>Optional[Dict]</code></td>
        <td><p>PyMongo filter for documents to count in</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/compound_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Counts the number of documents matching the query criteria</span>

<span class="sd">    Args:</span>
<span class="sd">        criteria: PyMongo filter for documents to count in</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pipeline</span><span class="p">(</span><span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">)</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$count&quot;</span><span class="p">:</span> <span class="s2">&quot;count&quot;</span><span class="p">})</span>
    <span class="n">agg</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">pipeline</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">agg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">agg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.compound_stores.JointStore.ensure_index">
<code class="codehilite language-python"><span class="n">ensure_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.compound_stores.JointStore.ensure_index" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Can't ensure index for JointStore</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/compound_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">ensure_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Can&#39;t ensure index for JointStore</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;No ensure_index method for JointStore&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.compound_stores.JointStore.groupby">
<code class="codehilite language-python"><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.compound_stores.JointStore.groupby" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Simple grouping function that will group documents
by keys.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>keys</code></td>
        <td><code>Union[List[str], str]</code></td>
        <td><p>fields to group documents</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>criteria</code></td>
        <td><code>Optional[Dict]</code></td>
        <td><p>PyMongo filter for documents to search in</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>properties</code></td>
        <td><code>Union[Dict, List]</code></td>
        <td><p>properties to return in grouped documents</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>sort</code></td>
        <td><code>Optional[Dict[str, Union[maggma.core.store.Sort, int]]]</code></td>
        <td><p>Dictionary of sort order for fields. Keys are field names and
values are 1 for ascending or -1 for descending.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>skip</code></td>
        <td><code>int</code></td>
        <td><p>number documents to skip</p></td>
        <td><code>0</code></td>
      </tr>
      <tr>
        <td><code>limit</code></td>
        <td><code>int</code></td>
        <td><p>limit on total number of documents returned</p></td>
        <td><code>0</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Iterator[Tuple[Dict, List[Dict]]]</code></td>
      <td><p>generator returning tuples of (dict, list of docs)</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/compound_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">groupby</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">keys</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">],</span>
    <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">properties</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">sort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">skip</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]]:</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pipeline</span><span class="p">(</span>
        <span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="n">skip</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">keys</span><span class="p">]</span>
    <span class="n">group_id</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: Dict[str,Any]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
        <span class="n">set_</span><span class="p">(</span><span class="n">group_id</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="s2">&quot;$</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$group&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">group_id</span><span class="p">,</span> <span class="s2">&quot;docs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$push&quot;</span><span class="p">:</span> <span class="s2">&quot;$$ROOT&quot;</span><span class="p">}}})</span>

    <span class="n">agg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">agg</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;docs&quot;</span><span class="p">]</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.compound_stores.JointStore.query">
<code class="codehilite language-python"><span class="n">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.compound_stores.JointStore.query" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Queries the Store for a set of documents</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>criteria</code></td>
        <td><code>Optional[Dict]</code></td>
        <td><p>PyMongo filter for documents to search in</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>properties</code></td>
        <td><code>Union[Dict, List]</code></td>
        <td><p>properties to return in grouped documents</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>sort</code></td>
        <td><code>Optional[Dict[str, Union[maggma.core.store.Sort, int]]]</code></td>
        <td><p>Dictionary of sort order for fields. Keys are field names and
values are 1 for ascending or -1 for descending.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>skip</code></td>
        <td><code>int</code></td>
        <td><p>number documents to skip</p></td>
        <td><code>0</code></td>
      </tr>
      <tr>
        <td><code>limit</code></td>
        <td><code>int</code></td>
        <td><p>limit on total number of documents returned</p></td>
        <td><code>0</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/compound_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">query</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">properties</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">sort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">skip</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pipeline</span><span class="p">(</span>
        <span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="n">skip</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span>
    <span class="p">)</span>
    <span class="n">agg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">agg</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">d</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.compound_stores.JointStore.query_one">
<code class="codehilite language-python"><span class="n">query_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.compound_stores.JointStore.query_one" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Get one document</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>properties</code></td>
        <td></td>
        <td><p>properties to return in query</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>criteria</code></td>
        <td></td>
        <td><p>filter for matching</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>kwargs</code></td>
        <td></td>
        <td><p>kwargs for collection.aggregate</p></td>
        <td><code>{}</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td></td>
      <td><p>single document</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/compound_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">query_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get one document</span>

<span class="sd">    Args:</span>
<span class="sd">        properties: properties to return in query</span>
<span class="sd">        criteria: filter for matching</span>
<span class="sd">        kwargs: kwargs for collection.aggregate</span>

<span class="sd">    Returns:</span>
<span class="sd">        single document</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: maybe adding explicit limit in agg pipeline is better as below?</span>
    <span class="c1"># pipeline = self._get_pipeline(properties, criteria)</span>
    <span class="c1"># pipeline.append({&quot;$limit&quot;: 1})</span>
    <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">doc</span>
    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.compound_stores.JointStore.remove_docs">
<code class="codehilite language-python"><span class="n">remove_docs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.compound_stores.JointStore.remove_docs" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Remove docs matching the query dictionary</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>criteria</code></td>
        <td><code>Dict</code></td>
        <td><p>query dictionary to match</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>maggma/stores/compound_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">remove_docs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove docs matching the query dictionary</span>

<span class="sd">    Args:</span>
<span class="sd">        criteria: query dictionary to match</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;No remove_docs method for JointStore&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="maggma.stores.compound_stores.JointStore.update">
<code class="codehilite language-python"><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docs</span><span class="p">,</span> <span class="n">update_lu</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


<a class="headerlink" href="#maggma.stores.compound_stores.JointStore.update" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Update documents into the underlying collections
Not Implemented for JointStore</p>

        <details class="quote">
          <summary>Source code in <code>maggma/stores/compound_stores.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docs</span><span class="p">,</span> <span class="n">update_lu</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update documents into the underlying collections</span>
<span class="sd">    Not Implemented for JointStore</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;JointStore is a read-only store&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>

              
            </article>
            
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../core_validator/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Validator" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Validator
            </div>
          </div>
        </a>
      
      
        
        <a href="../builders/" class="md-footer__link md-footer__link--next" aria-label="Next: Builders" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Builders
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Built by The Materials Project
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.b97dbffb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.6c7ad80a.min.js"></script>
      
    
  </body>
</html>